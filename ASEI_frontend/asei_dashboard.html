<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ASEI Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
  tailwind.config = { darkMode: 'class' };
</script>

<script>
  (function () {
    const KEY = 'connectify.theme';
    const saved = localStorage.getItem(KEY);
    if (saved === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
      if (saved !== 'light') localStorage.setItem(KEY, 'light');
    }
  })();
</script>
  <link rel="icon" type="image/png" href="images/connectify_logo.png">
  <style>
    :root{--sidebar:#111111;--sidebar-2:#1c1c1c;--stroke:#e5e5e5}
    html,body{height:100%}
    body{font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol','Noto Color Emoji'}
    *{scrollbar-width:thin;scrollbar-color:#9a9898 transparent}
    *::-webkit-scrollbar{height:8px;width:8px}
    *::-webkit-scrollbar-thumb{background:#cfcfcf;border-radius:999px}
    *::-webkit-scrollbar-track{background:transparent}
  </style>
</head>
<body class="min-h-screen bg-neutral-50 text-neutral-900 dark:bg-neutral-900 dark:text-neutral-100">
  <div class="flex">
<!-- Sidebar -->
    <aside class="fixed inset-y-0 left-0 w-60 bg-neutral-100 text-neutral-900 dark:bg-neutral-800/40 dark:text-neutral-100 flex flex-col">
      <div class="px-4 py-4 flex items-center gap-2 border-b border-neutral-400 dark:border-gray-400/70">
        <img src="images/connectify_logo.png" alt="Logo" class="h-8 w-auto">
        <span>Connectify</span>
      </div>

      <nav class="p-2 text-sm space-y-1 flex-1">
        <a href="asei_dashboard.html" class="flex items-center gap-2 px-3 py-2 rounded bg-neutral-300 dark:bg-neutral-800"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor"  d="M13.5 8.183V4.817q0-.357.234-.587t.58-.23h4.88q.347 0 .576.23t.23.587v3.366q0 .358-.234.587q-.234.23-.58.23h-4.88q-.346 0-.576-.23t-.23-.587M4 11.2V4.8q0-.34.234-.57t.58-.23h4.88q.347 
          0 .576.23t.23.57v6.4q0 .34-.234.57t-.58.23h-4.88q-.346 0-.576-.23T4 11.2m9.5 8v-6.4q0-.34.234-.57t.58-.23h4.88q.347 0 .576.23t.23.57v6.4q0 .34-.234.57t-.58.23h-4.88q-.346 0-.576-.23t-.23-.57M4 19.183v-3.366q0-.357.234-.587t.58-.23h4.88q.347 0 .576.23t.23.587v3.366q0 .358-.234.587q-.234.23-.58.23h-4.88q-.346 0-.576-.23T4 19.183M5 11h4.5V5H5zm9.5 8H19v-6h-4.5zm0-11H19V5h-4.5zM5 19h4.5v-3H5zm4.5-3"/>
            </svg></span><span class="hidden sm:inline">Dashboard</span></a>
        
        <a href="flow_designer.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor" d="M11.5 12.5h-5q-.213 0-.356-.144T6 11.999t.144-.356t.356-.143h5v-5q0-.213.144-.356T12.001 6t.356.144t.143.356v5h5q.213 0 .356.144t.144.357t-.144.356t-.356.143h-5v5q0 .213-.144.356t-.357.144t-.356-.144t-.143-.356z"/>
          </svg></span><span class="hidden sm:inline">Flow Designer</span></a>
        
        <a href="connectors.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-5 w-5 -translate-x-[1px]" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M4.513 19.487c2.512 2.392 5.503 1.435 6.7.466c.618-.501.897-.825 
          1.136-1.065c.837-.777.784-1.555.24-2.177c-.219-.249-1.616-1.591-2.956-2.967c-.694-.694-1.172-1.184-1.582-1.58c-.547-.546-1.026-1.172-1.744-1.154c-.658 0-1.136.58-1.735 1.179c-.688.688-1.196 1.555-1.375 2.333c-.539 2.273.299 3.888 1.316 4.965Zm0 0L2 21.999M19.487 4.515c-2.513-2.394-5.494-1.42-6.69-.45c-.62.502-.898.826-1.138 1.066c-.837.778-.784 1.556-.239 2.178c.078.09.31.32.635.644m7.432-3.438c1.017 1.077 1.866 
            2.71 1.327 4.985c-.18.778-.688 1.645-1.376 2.334c-.598.598-1.077 1.179-1.735 1.179c-.718.018-1.09-.502-1.639-1.048m3.423-7.45L22 2m-5.936 9.964c-.41-.395-.994-.993-1.688-1.687c-.858-.882-1.74-1.75-2.321-2.325m4.009 4.012l-1.562 1.525m-3.99-3.984l1.543-1.553"/>
              </svg></span><span class="hidden sm:inline">Connectors</span></a>
        
        <a href="templates.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-5 w-5 -translate-x-[1px]" viewBox="0 0 24 24"><path fill="currentColor" d="M13 9h1v2h-3V7h2zm5.5 0l-2.12-2.12l1.25-1.25L20 8v2h-2v1h-3V9zM13 3.5V2h-1v2h1v2h-2V4H9V2H8v2H6v1H4V4c0-1.11.89-2 2-2h8l2.36 2.36l-1.25 1.25zM20 20a2 2 0 0 1-2 
          2h-2v-2h2v-1h2zm-2-5h2v3h-2zm-6 7v-2h3v2zm-4 0v-2h3v2zm-2 0a2 2 0 0 1-2-2v-2h2v2h1v2zm-2-8h2v3H4zm0-4h2v3H4zm14 1h2v3h-2zM4 6h2v3H4z"/>
            </svg></span><span class="hidden sm:inline">Templates</span></a>
        
        <a href="deployments.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px] -translate-x-[-2px] -translate-y-[-3px]" viewBox="0 0 24 24"><path fill="currentColor" d="M4.18 7c-.473 0-.88.294-.972.703l-1.189 5.25a1 1 0 0 0-.019.172c0 .483.444.875.99.875h11.02q.098 0 .194-.017c.537-.095.885-.556.778-1.03l-1.19-5.25C13.7 7.294 13.293 7 12.822 7zM5 6v1h7V6h.825c.946 
          0 1.76.606 1.946 1.447l1.19 5.4c.215.975-.482 1.923-1.556 2.118a2 2 0 0 1-.39.035H2.985C1.888 15 1 14.194 1 13.2q0-.178.039-.353l1.19-5.4C2.414 6.606 3.229 6 4.174 6z"/><path fill="currentColor" d="M5.99 1.399a.5.5 0 0 0-.98.202l2.058 9.945c.327 1.582 2.58 1.6 2.933.023l1.845-8.274L12.6 4.3a.5.5 0 0 0 .8-.6l-1.5-2a.5.5 0 0 0-.7-.1l-2 1.5a.5.5 0 1 0 .6.8l1.065-.799l-1.84 8.25c-.118.526-.869.52-.978-.008z"/>
            </svg></span><span class="hidden sm:inline">Deployments</span></a>
        
        <a href="monitoring.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px] -translate-x-[1px]" viewBox="0 0 24 24"><path fill="currentColor" d="M4 20.5q-.214 0-.357-.144T3.5 20v-.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T7.5 
          20v-5.288q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.213 0-.356-.144T11.5 20v-3.288q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T15.5 20v-4.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T19.5 20v-8.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 
            .213-.144.356t-.357.144M14 11.437q-.304 0-.598-.12q-.295-.12-.538-.34l-2.422-2.421q-.173-.173-.442-.173t-.442.173L4.354 13.76q-.146.146-.357.153q-.21.006-.356-.16q-.141-.145-.135-.349t.14-.338l5.218-5.218q.243-.24.538-.35q.294-.11.598-.11t.609.11t.527.35l2.422 2.421q.173.173.442.173t.442-.173l5.204-5.203q.146-.147.357-.153q.21-.007.357.158q.14.146.134.35t-.14.339l-5.217 5.217q-.224.22-.528.34t-.609.12"/>
              </svg></span><span class="hidden sm:inline">Monitoring</span></a>
        
        <a href="settings.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24">
          <path fill="currentColor" d="M10.96 21q-.349 0-.605-.229q-.257-.229-.319-.571l-.263-2.092q-.479-.145-1.036-.454q-.556-.31-.947-.664l-1.915.824q-.317.14-.644.03t-.504-.415L3.648 15.57q-.177-.305-.104-.638t.348-.546l1.672-1.25q-.045-.272-.073-.559q-.03-.288-.03-.559q0-.252.03-.53q.028-.278.073-.626l-1.672-1.25q-.275-.213-.338-.555t.113-.648l1.06-1.8q.177-.287.504-.406t.644.021l1.896.804q.448-.373.97-.673q.52-.3 
          1.013-.464l.283-2.092q.061-.342.318-.571T10.96 3h2.08q.349 0 .605.229q.257.229.319.571l.263 2.112q.575.202 1.016.463t.909.654l1.992-.804q.318-.14.645-.021t.503.406l1.06 1.819q.177.306.104.638t-.348.547L18.36 10.92q.082.31.092.569t.01.51q0 
          .233-.02.491q-.019.259-.088.626l1.69 1.27q.275.213.358.546t-.094.638l-1.066 1.839q-.176.306-.513.415q-.337.11-.654-.03l-1.923-.824q-.467.393-.94.673t-.985.445l-.264 2.111q-.061.342-.318.571t-.605.23zm.04-1h1.956l.369-2.708q.756-.2 
          1.36-.549q.606-.349 1.232-.956l2.495 1.063l.994-1.7l-2.189-1.644q.125-.427.166-.786q.04-.358.04-.72q0-.38-.04-.72t-.166-.747l2.227-1.683l-.994-1.7l-2.552 1.07q-.454-.499-1.193-.935q-.74-.435-1.4-.577L13 
          4h-1.994l-.312 2.689q-.756.161-1.39.52q-.633.358-1.26.985L5.55 7.15l-.994 1.7l2.169 1.62q-.125.336-.175.73t-.05.82q0 .38.05.755t.156.73l-2.15 1.645l.994 1.7l2.475-1.05q.589.594 1.222.953q.634.359 1.428.559zm.973-5.5q1.046 0 1.773-.727T14.473 12t-.727-1.773t-1.773-.727q-1.052 0-1.776.727T9.473 12t.724 1.773t1.776.727M12 12"/>
            </svg></span><span class="hidden sm:inline">Settings</span></a>
      </nav>

    <div class="relative">
      <div id="profileBtn" class="w-full px-4 py-4 flex items-center gap-2 border-t border-neutral-400 dark:border-gray-400/70 text-left">

          <img id="initialSidebarPfp" src="images/default_avatar.png" class="js-initial-pfp h-8 w-8 rounded-full object-cover" alt="O Pfp"/>
          <img id="mainPfp" class="js-main-pfp h-8 w-8 rounded-full object-cover hidden" alt="N Pfp"/>
          <span class="text-sm font-medium">Insert User Name</span>
      </div>
    </div>
  </aside>

    <!-- Main -->
    <main class="p-6 sm:p-6 ml-60">
      <!-- Header -->
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
        <h2 class="text-xl font-semibold">Dashboard</h2>
        <div class="flex items-center gap-3">
          <!-- Notification Bell -->
          <div class="relative">
            <button id="notifBtn" class="relative p-2 rounded-lg bg-white border border-neutral-200 dark:border-neutral-700 dark:bg-neutral-800 hover:bg-neutral-100 dark:hover:bg-neutral-700" aria-label="Notifications">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 1 0-12 0v3.2c0 .5-.2 1-.6 1.4L4 17h5"/>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
              </svg>
              <span id="notifBadge"
                    class="hidden absolute -top-1 -right-1 h-4 min-w-4 px-1 text-[10px] leading-4 text-center
                          rounded-full bg-red-500 text-white"></span>
            </button>
  <!-- ADD this wrapper back -->
  <div id="notifMenu" class="absolute hidden right-0 mt-2 w-80 max-h-96 overflow-y-auto bg-white border border-neutral-200 dark:bg-neutral-700 dark:border-neutral-600 rounded-xl shadow-xl z-50">
    <div class="flex items-center justify-between px-3 py-2 border-b border-neutral-100">
      <div class="text-sm font-medium">Notifications</div>
      <button id="notifMarkAll" class="text-xs px-2 py-1 rounded bg-neutral-100 hover:bg-neutral-200 dark:bg-neutral-600 dark:hover:bg-neutral-800">
        Clear
      </button>
    </div>

    <div id="notifList" class="divide-y divide-neutral-100 dark:divide-neutral-600"></div>
  </div>
</div>

          <div class="relative">
            <button id="topProfileBtn" class="relative h-10 w-10 overflow-hidden rounded-full border border-neutral-200 dark:border-gray-400 hover:bg-neutral-800 dark:hover:bg-neutral-600" aria-label="Profile">
              <img id="initialSidebarPfp" src="images/default_avatar.png" class="js-initial-pfp absolute inset-0 h-full w-full transform scale-[1.28] object-cover" alt="Default profile"/>
              <img id="mainPfp" class="js-main-pfp h-12 w-12 rounded-full object-cover hidden" alt="Profile"/>
            </button>
            <div id="profileMenu" class="hidden absolute top-full right-0 w-48 mt-2 rounded-lg z-50">
              <button href="login.html"id="logoutBtn" class="px-3 py-3 w-full bg-neutral-200 hover:bg-neutral-300 text-red-500 hover:text-red-600 border border-neutral-300 dark:bg-neutral-600 dark:hover:bg-neutral-500 dark:text-red-500 dark:hover:text-red-400 dark:border-neutral-700 shadow-lg rounded-lg">Sign Out</button>
            </div>
          </div>
        </div>
        <script>
          const btn = document.getElementById('topProfileBtn');
          const menu = document.getElementById('profileMenu');
          btn.addEventListener('click', (e) => {e.stopPropagation(); menu.classList.toggle('hidden'); });
          document.addEventListener('click', (e) => {if(!menu.contains(e.target) && e.target !== btn) menu.classList.add('hidden'); });
        </script>
      </div>

      <!-- KPI cards -->
        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-neutral-100 dark:bg-neutral-600 flex items-center justify-center">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg>
            </div>
            <div>
              <div class="text-2xl font-semibold" id="kpi-active-flows">12</div>
              <div class="text-xs text-neutral-500 dark:text-neutral-400">Active Flows</div>
            </div>
          </div>
        </div>

        <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-neutral-100 dark:bg-neutral-600 flex items-center justify-center">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 9h10M7 13h6"/></svg>
            </div>
            <div>
              <div class="text-2xl font-semibold" id="kpi-transactions">425</div>
              <div class="text-xs text-neutral-500 dark:text-neutral-400">Transactions</div>
            </div>
          </div>
        </div>

        <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-neutral-100 dark:bg-neutral-600 flex items-center justify-center">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/><circle cx="12" cy="17" r="0.6"/></svg>
            </div>
            <div>
              <div class="text-2xl font-semibold" id="kpi-errors">3</div>
              <div class="text-xs text-neutral-500 dark:text-neutral-400">Errors</div>
            </div>
          </div>
        </div>

        <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-neutral-100 dark:bg-neutral-600 flex items-center justify-center">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <div>
              <div class="text-2xl font-semibold" id="kpi-latency">245ms</div>
              <div class="text-xs text-neutral-500 dark:text-neutral-400">Average Latency</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Chart + Quick Actions -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
        <!-- Chart -->
        <div class="lg:col-span-2 bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl">
          <div class="px-4 pt-4 pb-0 flex">
            <div class="text-sm font-medium">Transactions</div>
            <p id="txDate" class="ml-auto text-xs text-neutral-500"></p>
          </div>

          <div class="px-4 pb-2">
            <div class="h-56">
              <canvas id="txChart" class="h-56 w-full"></canvas>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4">
          <div class="text-center font-semibold">Quick Actions</div>
          <div class="mt-4 space-y-3">
            <button id="addIntegrationBtn" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-neutral-900 text-white hover:bg-black">
              <span>+ Add new integration</span>
            </button>

            <button id="openSandboxBtn" class="w-full px-4 py-2 rounded-lg bg-white border border-neutral-200 hover:bg-neutral-50 dark:bg-neutral-700 dark:border-neutral-600 dark:hover:bg-neutral-600">
              Test Sandbox API
            </button>

            <button id="openComplianceBtn" class="w-full px-4 py-2 rounded-lg bg-white border border-neutral-200 hover:bg-neutral-50 dark:bg-neutral-700 dark:border-neutral-600 dark:hover:bg-neutral-600">
              Generate Compliance
            </button>
          </div>
        </div>
      </section>

      <!-- Service Integrations -->
<!-- Service Integrations -->
<section class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4">
  <div class="flex items-center justify-between mb-4">
    <div class="text-sm font-medium">Service Integrations</div>
    <a href="connectors.html" class="text-xs text-blue-600 hover:underline">View All</a>
  </div>

  <!-- Integration List -->
  <div id="services-list" class="space-y-3 text-sm">

    <!-- Integration Row 1 -->
    <div class="flex items-center justify-between p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 dark:hover:bg-neutral-700 dark:border-neutral-700 transition">
      <div>
        <div class="font-medium">PayLink API</div>
        <div class="text-xs text-neutral-500">Payments Connector â€¢ Last sync: 2 mins ago</div>
      </div>
      <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">Active</span>
    </div>

    <!-- Integration Row 2 -->
    <div class="flex items-center justify-between p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 dark:hover:bg-neutral-700 dark:border-neutral-700 transition">
      <div>
        <div class="font-medium">Kora Banking Core</div>
        <div class="text-xs text-neutral-500">Banking Integration â€¢ Last sync: 10 mins ago</div>
      </div>
      <span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-700">Pending</span>
    </div>

    <!-- Integration Row 3 -->
    <div class="flex items-center justify-between p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 dark:hover:bg-neutral-700 dark:border-neutral-700 transition">
      <div>
        <div class="font-medium">FinRemit Gateway</div>
        <div class="text-xs text-neutral-500">Remittance Flow â€¢ Last sync: 45 mins ago</div>
      </div>
      <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700">Active</span>
    </div>

    <!-- Integration Row 4 -->
    <div class="flex items-center justify-between p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 dark:hover:bg-neutral-700 dark:border-neutral-700 transition">
      <div>
        <div class="font-medium">UtilityPay Service</div>
        <div class="text-xs text-neutral-500">Utility Billing â€¢ Last sync: 2 hours ago</div>
      </div>
      <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">Error</span>
    </div>

  </div>
</section>


  <!-- Modals -->
  <div id="integrationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden grid place-items-center z-50">
    <div class="bg-white dark:bg-neutral-800 border dark:border-neutral-600 rounded-xl p-6 w-11/12 sm:w-96">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Add New Integration</h2>
        <button id="closeModal" class="text-neutral-500 hover:text-neutral-900">&times;</button>
      </div>
      <form id="integration-form">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Integration Name</label>
          <input id="integration-name" type="text" class="w-full dark:bg-neutral-600 border border-neutral-300 dark:border-neutral-700 rounded px-3 py-2" placeholder="Enter integration name" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">API Key</label>
          <input id="integration-apikey" type="text" class="w-full dark:bg-neutral-600 border border-neutral-300 dark:border-neutral-700 rounded px-3 py-2" placeholder="Enter API key" required>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelModal" class="px-4 py-2 rounded-lg bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-400 dark:hover:bg-neutral-500 border dark:border-neutral-500">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded-lg bg-neutral-900 text-white hover:bg-black dark:bg-blue-600 dark:hover:bg-blue-700 border dark:border-blue-700">Add</button>
        </div>
      </form>
    </div>
  </div>

  <div id="sandboxModal" class="fixed inset-0 bg-black bg-opacity-50 hidden grid place-items-center z-50">
    <div class="bg-white dark:bg-neutral-800 border dark:border-neutral-700 rounded-xl p-6 w-11/12 sm:w-[500px]">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Test Sandbox API</h2>
        <button id="closeSandbox" class="text-neutral-500 hover:text-neutral-900">&times;</button>
      </div>
      <form id="sandbox-form">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Endpoint URL</label>
          <input type="url" class="w-full border border-neutral-300 dark:bg-neutral-600 dark:border-neutral-700 rounded px-3 py-2" placeholder="https://api.example.com/test" required>
        </div>
        <div class="mb-4">
  <label class="block text-sm font-medium mb-1">Method</label>
  <select id="sandbox-method"
          class="w-full border border-neutral-300 dark:bg-neutral-600 dark:border-neutral-700 rounded px-3 py-2">
    <option>GET</option>
    <option>POST</option>
    <option>PUT</option>
    <option>DELETE</option>
    <option>PATCH</option>
  </select>
</div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Request Body</label>
          <textarea rows="4" class="w-full border border-neutral-300 dark:bg-neutral-600 dark:border-neutral-700 rounded px-3 py-2" placeholder='{"key": "value"}'></textarea>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelSandbox" class="px-4 py-2 rounded-lg bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-400 dark:hover:bg-neutral-500 border dark:border-neutral-500">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded-lg bg-neutral-900 text-white hover:bg-black dark:bg-blue-600 dark:hover:bg-blue-700 border dark:border-blue-700">Send Request</button>
        </div>
      </form>
      <div id="sandboxResult" class="mt-3 p-3 bg-neutral-100 dark:bg-neutral-700 rounded text-xs max-h-48 overflow-auto hidden"></div>
    </div>
  </div>

  <div id="complianceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden grid place-items-center z-50">
    <div class="bg-white dark:bg-neutral-800 border dark:border-neutral-700 rounded-xl p-6 w-11/12 sm:w-[500px]">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Generate Compliance Report</h2>
        <button id="closeCompliance" class="text-neutral-500 hover:text-neutral-900">&times;</button>
      </div>
      <form id="compliance-form">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1 ">Report Type</label>
          <select class="w-full border border-neutral-300 dark:bg-neutral-600 dark:border-neutral-700 rounded px-3 py-2">
            <option>Security Audit</option>
            <option>Integration Summary</option>
            <option>Data Privacy Report</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Recipient Email</label>
          <input type="email" class="w-full border border-neutral-300 dark:bg-neutral-600 dark:border-neutral-700 rounded px-3 py-2" placeholder="you@example.com" required>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelCompliance" class="px-4 py-2 rounded-lg bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-400 dark:hover:bg-neutral-500 border dark:border-neutral-500">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded-lg bg-neutral-900 text-white hover:bg-black dark:bg-blue-600 dark:hover:bg-blue-700 border dark:border-blue-700">Generate</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script>
(() => {
const api = {
  me: '/api/dashboard/me',
  kpis: '/api/dashboard/kpis',
  series: '/api/dashboard/transactions/series',
  notifs: (limit=20) => `/api/dashboard/notifications?limit=${limit}`,
  // your backend supports per-id read and read-all; weâ€™ll use read-all after open:
  notifReadAll: '/api/dashboard/notifications/read-all',
  integrationsStatus: '/api/dashboard/integrations',
  addIntegration: '/api/dashboard/integrations',
  // Sandbox test proxy
  sandboxTest: '/api/dashboard/dev/sandbox/fetch',
  complianceGenerate: '/api/dashboard/compliance/generate', // if you add it later; otherwise leave unused
  seedDemo: '/api/dashboard/dev/seed-demo',
  // youâ€™re using Socket.IO for pushes, not SSE:
  socket: '/socket.io/socket.io.js'
};


  const $ = (id) => document.getElementById(id);
  const setText = (id, v) => { const el = $(id); if (el) el.textContent = v; };
  const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  async function fetchJson(url, options = {}) {
    const res = await fetch(url, { credentials: 'include', ...options });
    if (!res.ok) throw new Error(`${options.method||'GET'} ${url} â†’ ${res.status}`);
    return res.status === 204 ? null : res.json();
  }

  function toast(btnEl, okText='Done âœ“', revertText='Done', ms=1500) {
    if (!btnEl) return;
    const orig = btnEl.textContent;
    btnEl.textContent = okText;
    setTimeout(() => { btnEl.textContent = revertText; }, ms);
  }

  // ---------- Profile (name + avatar) ----------
  async function initProfile() {
    try {
      // backend /api/dashboard/me returns a plain user object: { id, email, org, firstName, lastName }
      const me = await fetchJson(api.me);

      // Build a friendly display name: prefer first+last, fall back to email localpart, then generic 'User'
      const fullName = [me?.firstName, me?.lastName].filter(Boolean).join(' ').trim();
      const emailLocal = (me?.email || '').split('@')[0];
      const displayName = fullName || emailLocal || 'User';

      // Update sidebar + top profile name elements
      qsa('.js-profile-name').forEach(el => el.textContent = displayName);

      // Prefer real avatar if provided, otherwise show the initial-avatar image
      if (me?.avatarUrl) {
        qsa('.js-main-pfp').forEach(img => { img.src = me.avatarUrl; img.classList.remove('hidden'); });
        qsa('.js-initial-pfp').forEach(img => img.classList.add('hidden'));
      } else {
        qsa('.js-initial-pfp').forEach(img => img.classList.remove('hidden'));
        qsa('.js-main-pfp').forEach(img => img.classList.add('hidden'));
      }

      // expose current user for other scripts (socket join)
      window.__me = me;
      // if socket already exists and is connected, join the org room
      try { if (window.__socket && window.__socket.connected && me?.org) window.__socket.emit('join-org', me.org); } catch(_){ }
    } catch (e) { console.warn('Profile load failed', e); }
  }

  // ---------- Notifications ----------
function timeAgo(tsMs){
  const s = Math.floor((Date.now() - tsMs)/1000);
  if (s < 60) return `${s}s ago`;
  const m = Math.floor(s/60); if (m < 60) return `${m}m ago`;
  const h = Math.floor(m/60); if (h < 24) return `${h}h ago`;
  const d = Math.floor(h/24); return `${d}d ago`;
}

const remove_key = 'connectify.removeNotifs';
const removeNotifs = new Set(JSON.parse(localStorage.getItem(remove_key)) || '[]');
const rmberRemove = (id) =>{
  removeNotifs.add(String(id));
  localStorage.setItem(remove_key, JSON.stringify([...removeNotifs]));
};

async function loadNotifs() {
  try {
    const items = await fetchJson(api.notifs(20)); // uses your existing helper
    const list = document.getElementById('notifList');
    const badge = document.getElementById('notifBadge');
    if (!list) return;

    const visible = items.filter(n => !removeNotifs.has(String(n.id)));

    const typeChip = (t) => {
      const T = String(t || 'info').toLowerCase();
      const map = {
        info:  'bg-blue-100 text-blue-700',
        warn:  'bg-yellow-100 text-yellow-800',
        error: 'bg-red-100 text-red-700'
      };
      const cls = map[T] || 'bg-neutral-100 text-neutral-700';
      const label = T.charAt(0).toUpperCase() + T.slice(1);
      return `<span class="text-[10px] px-1.5 py-0.5 rounded ${cls}">${label}</span>`;
    };

    if (!visible.length) {
      list.innerHTML = `<div class="p-3 text-xs text-neutral-500">No notifications</div>`;
    } else {
        list.innerHTML = visible.map(n => `
        <div class="relative p-3 hover:bg-neutral-50 dard:hover:bg-neutral-600">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              ${typeChip(n.type)}
              <div class="text-sm font-medium">${n.title || 'Notification'}</div>
            </div>
            <div class="text-[10px] text-neutral-500 dark:text-gray-200">${n.ts ? timeAgo(n.ts) : ''}</div>
          </div>
          <div class="mt-1 pr-8 text-xs text-neutral-600 dark:text-gray-200">${n.message || ''}</div>
          ${!n.isRead ? `<span class="mt-2 inline-block h-1.5 w-1.5 rounded-full bg-red-500"></span>` : ''}

          <button class="js-notif-bin absolute bottom-2 right-2 p-1.5 rounded hover:bg-neutral-100" data-id="${n.id}" aria-label="Remove">
            <svg class="w-4 h-4 text-gray-800 dark:text-white" aria-hidden="true" width="24" height="24" fill="none" viewBox="0 0 24 24">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 7h14m-9 3v8m4-8v8M10 3h4a1 1 0 0 1 1 1v3H9V4a1 1 0 0 1 1-1ZM6 7h12v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7Z"/>
            </svg>
          </button>
        </div>
      `).join('');
    }

    const unread = visible.filter(n => !n.isRead).length;
    badge.textContent = unread ? String(unread) : '';
    badge.classList.toggle('hidden', unread === 0);

    if(!list._wired){
      list.wired = true;
      list.addEventListener('click', async(e) =>{
        const bin = e.target.closest('.js-notif-bin');
        if(!bin) return;

        const id = bin.dataset.id;
        remberRemove(id);

        const row = bin.closest('[data-id]');
        row?.remove();
      })
    }

    // Optional auto mark-all (keep or remove)
    // if (items.some(n => !n.isRead)) {
    //   fetchJson(api.notifReadAll, { method: 'POST' }).catch(()=>{});
    // }
  } catch (e) {
    console.warn('Notifications failed', e);
  }
}
window.loadNotifs = loadNotifs;
document.addEventListener('DOMContentLoaded', () => {
  const mark = $('notifMarkAll');
  if (mark) {
    mark.addEventListener('click', async () => {
      try {
        await fetchJson(api.notifReadAll, { method: 'POST' });
        await loadNotifs();
      } catch {}
    });
  }
});


  (function initNotifUI(){
    const btn = $('notifBtn'), menu = $('notifMenu');
    if (!btn || !menu) return;

    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      menu.classList.toggle('hidden');
      if (!menu.classList.contains('hidden')) {
        await loadNotifs();
        // Mark all notifications as read when menu is opened
        try {
          await fetchJson(api.notifReadAll, { method: 'POST' });
          await loadNotifs(); // Refresh to update badges
        } catch {}
      }
    });
    document.addEventListener('click', (e) => {
      if (!menu.contains(e.target) && e.target !== btn) menu.classList.add('hidden');
    });
  })();

  // ---------- KPI + Chart ----------
  let chart;
  async function loadKpis() {
    const k = await fetchJson(api.kpis);
    setText('kpi-active-flows', k.activeFlows ?? 0);
    setText('kpi-transactions', k.transactions ?? 0);
    setText('kpi-errors', k.errors ?? 0);
    setText('kpi-latency', (k.avgLatencyMs ?? 0) + 'ms');
  }
  async function loadSeries() {
    const { points = [] } = await fetchJson(api.series);
    return points.map(p => ({ x: new Date(Number(p.t)), y: p.count }));
  }
  async function initChart() {
    const canvas = $('txChart');
    if (!canvas) return;
    const data = await loadSeries();
    const ds = [{ data, borderWidth: 2, tension: 0.3, borderColor: '#000', pointRadius: 0 }];
    chart = new Chart(canvas, {
      type: 'line',
      data: { datasets: ds },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            displayColors: false,
            callbacks: {
              title(items){
                const d = new Date(items[0].parsed.x);
                const hoverDate = d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' });
                const t = d.getHours(), suffix = t >= 12 ? 'pm' : 'am', hour12 = (t % 12) || 12;
                return `${hoverDate}      ${hour12}:00 ${suffix}`;
              },
              label(item){ return `Transactions: ${item.parsed.y}`; }
            }
          }
        },
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: { type: 'time', time: { unit: 'hour', displayFormats: { hour: 'HH:mm' }}, ticks: { autoSkip: true, maxTicksLimit: 6 }, grid: { display: false }},
          y: { beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });
  }

  // public refresh for seed-demo
  window.__refreshDashboard = async () => {
    await loadKpis();
    if (chart) {
      chart.data.datasets[0].data = await loadSeries();
      chart.update();
    }
  };

  // ---------- Service Integrations list ----------
  async function initServices() {
    const rows = await fetchJson(api.integrationsStatus);
    const wrap = document.getElementById('services-list'); // add this line
     if (!wrap) return;
    wrap.innerHTML = rows.map(r => {
      const status = r.status || 'pending';
      const badge = (s) => {
        const S = String(s).toLowerCase();
        const map = {
          active:  ['bg-green-100','text-green-700'],
          pending: ['bg-yellow-100','text-yellow-700', 'animate-pulse'],
          error:   ['bg-red-100','text-red-700']
        };
        const cls = (map[S] || ['bg-neutral-100','text-neutral-700']).join(' ');
        return `<span class="px-2 py-1 text-xs font-medium rounded-full ${cls}">${s[0].toUpperCase()+s.slice(1)}</span>`;
      };
      const syncTime = r.lastChecked ? timeAgo(new Date(r.lastChecked).getTime()) : 'â€”';
      return `
        <div class="flex items-center justify-between p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 dark:hover:bg-neutral-700 dark:border-neutral-700 transition">
          <div>
            <div class="font-medium">${r.name}</div>
            <div class="text-xs text-neutral-500">Integration â€¢ Last sync: ${syncTime}</div>
          </div>
          ${badge(status)}
        </div>`;
    }).join('');

  }

  // ---------- Modals: open/close + submit ----------
  // Add Integration
  (function(){
    const modal = $('integrationModal');
    const openBtn = $('addIntegrationBtn');
    const close = $('closeModal');
    const cancel = $('cancelModal');
    if (!modal || !openBtn) return;

    const hide = () => modal.classList.add('hidden');
    const show = () => modal.classList.remove('hidden');

    openBtn.addEventListener('click', show);
    close?.addEventListener('click', hide);
    cancel?.addEventListener('click', hide);
    window.addEventListener('click', e => { if (e.target === modal) hide(); });

    const form = $('integration-form');
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = $('integration-name')?.value?.trim();
      const apiKey = $('integration-apikey')?.value?.trim();
      if (!name || !apiKey) return;

      try {
        // First add the integration - it will be in pending state
        await fetchJson(api.addIntegration, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, apiKey })
        });
        hide();
        await initServices(); // Show initial pending state
        
        // Setup polling to check for status changes
        let attempts = 0;
        const maxAttempts = 10; // Try for about 30 seconds (10 * 3s)
        const pollInterval = setInterval(async () => {
          attempts++;
          const rows = await fetchJson(api.integrationsStatus);
          const integration = rows.find(r => r.name === name);
          
          if (integration && integration.status !== 'pending') {
            // Status changed from pending - stop polling
            clearInterval(pollInterval);
            await initServices(); // Update the UI one final time
          } else if (attempts >= maxAttempts) {
            // Give up after max attempts
            clearInterval(pollInterval);
          }
        }, 3000); // Poll every 3 seconds

      } catch (err) {
        alert('Failed to add integration. Check API key.');
      }
    });
  })();

  // Sandbox modal + request proxy
  (function(){
    const modal = $('sandboxModal');
    const openBtn = $('openSandboxBtn');
    const close = $('closeSandbox');
    const cancel = $('cancelSandbox');
    if (!modal || !openBtn) return;

    const hide = () => { modal.classList.add('hidden'); const r = $('sandboxResult'); if(r) r.classList.add('hidden'); };
    const show = () => modal.classList.remove('hidden');

    openBtn.addEventListener('click', show);
    close?.addEventListener('click', hide);
    cancel?.addEventListener('click', hide);
    window.addEventListener('click', e => { if (e.target === modal) hide(); });

    const form = $('sandbox-form');
    const resultEl = $('sandboxResult');
form?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const url = form.querySelector('input[type="url"]')?.value?.trim();
  const methodSel = $('sandbox-method');
  const picked = methodSel ? methodSel.value : 'GET';

  let bodyText = form.querySelector('textarea')?.value ?? '';
  bodyText = bodyText.trim();

  if (!url) { alert('Enter endpoint URL'); return; }
  if (!resultEl) return;

  resultEl.classList.remove('hidden');
  resultEl.textContent = 'Testingâ€¦';

  try {
    // If GET/HEAD, force no body. Otherwise parse/forward body if provided.
    let parsedBody;
    if (picked === 'GET' || picked === 'HEAD') {
      parsedBody = undefined;
    } else if (bodyText !== '') {
      try { parsedBody = JSON.parse(bodyText); }
      catch { parsedBody = bodyText; } // allow raw text
    } else {
      parsedBody = undefined;
    }

    // Perform proxy POST and handle both success and proxy-error shapes
    const fetchResp = await fetch(api.sandboxTest, {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url, method: picked, body: parsedBody })
    });

    // try to parse JSON; fall back to raw text
    let resp;
    try {
      resp = await fetchResp.json();
    } catch (err) {
      const raw = await fetchResp.text().catch(() => '');
      resp = { error: 'invalid_json_response', raw };
    }

    // If the proxy returned a non-2xx, show an error view with any provided error/duration
    if (!fetchResp.ok) {
      resultEl.innerHTML = `
        <div class="font-medium">Proxy Error${fetchResp.status ? `: ${fetchResp.status}` : ''}</div>
        <div class="text-[11px] text-neutral-500 mt-1">Duration: ${resp.durationMs ?? 'n/a'} ms â€¢ Content-Type: ${resp.contentType || 'n/a'}</div>
        <pre class="text-xs whitespace-pre-wrap mt-2">${resp.error ? String(resp.error) : (resp.raw || JSON.stringify(resp, null, 2))}</pre>
        <div class="mt-2 text-[11px] text-neutral-500">Headers:</div>
        <pre class="text-[11px] whitespace-pre-wrap">${JSON.stringify(resp.headers || {}, null, 2)}</pre>`;
      return;
    }

    const prettyBody = (() => {
      if (typeof resp.body === 'string') {
        try { return JSON.stringify(JSON.parse(resp.body), null, 2); }
        catch { return resp.body; }
      }
      return JSON.stringify(resp.body, null, 2);
    })();

    resultEl.innerHTML =
      `<div class="font-medium">Status: ${resp.status} ${resp.statusText ?? ''}</div>` +
      `<div class="text-[11px] text-neutral-500 mt-1">Duration: ${resp.durationMs} ms â€¢ Content-Type: ${resp.contentType || 'n/a'}</div>` +
      `<pre class="text-xs whitespace-pre-wrap mt-2">${prettyBody}</pre>` +
      `<div class="mt-2 text-[11px] text-neutral-500">Headers:</div>` +
      `<pre class="text-[11px] whitespace-pre-wrap">${JSON.stringify(resp.headers, null, 2)}</pre>` +
      (resp.truncated ? `<div class="mt-2 text-[11px] text-yellow-700">Body truncated at 512 KB.</div>` : '');
  } catch (err) {
    resultEl.textContent = 'Error: ' + (err.message || err);
  }
});


  })();

// Compliance
(function(){
  const modal = $('complianceModal');
  const openBtn = $('openComplianceBtn');
  const close = $('closeCompliance');
  const cancel = $('cancelCompliance');

  const hide = () => modal.classList.add('hidden');
  const show = () => modal.classList.remove('hidden');

  openBtn?.addEventListener('click', show);
  close?.addEventListener('click', hide);
  cancel?.addEventListener('click', hide);
  window.addEventListener('click', e => { if (e.target === modal) hide(); });

  // Placeholder submit (no backend call yet)
  const form = $('compliance-form');
  form?.addEventListener('submit', (e) => {
    e.preventDefault();
    alert('Compliance report generation coming soon.');
    hide();
  });
})();
  
// ---------- Live updates via SSE (fallback to 30s polling) ----------
function startSSE() {
  return false; // disable SSE; Socket.IO handles real-time
}

async function initAll() {
  setText('txDate', new Date().toLocaleDateString());
  await initProfile();
  await Promise.all([loadKpis(), initChart(), initServices(), loadNotifs()]);
  setInterval(() => window.__refreshDashboard(), 30000);
  setInterval(() => initServices(), 10000);
  startSSE();
}

document.addEventListener('DOMContentLoaded', initAll);
})();

</script>
<script>
  // Graceful JSON fetch that auto-redirects on 401 (optional but recommended)
  async function fetchJsonAuth(url, options = {}) {
    const res = await fetch(url, { credentials: 'include', ...options });
    if (res.status === 401) {
      // Unauthenticated -> back to login
      window.location.href = 'login.html';
      return Promise.reject(new Error('401'));
    }
    if (!res.ok) throw new Error(`${options.method || 'GET'} ${url} â†’ ${res.status}`);
    return res.status === 204 ? null : res.json();
  }

  // Bind Sign Out
  (function initLogout(){
    const btn = document.getElementById('logoutBtn');
    if (!btn) return;

    btn.addEventListener('click', async (e) => {
      e.preventDefault();

      // 1) Ask backend to clear the httpOnly session cookie
      try {
        await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      } catch (_) {
        // ignore network errors â€“ weâ€™ll still clean up locally
      }

      // 2) Keep theme, clear everything else
      const THEME_KEY = 'connectify.theme';
      const theme = localStorage.getItem(THEME_KEY);

      try { sessionStorage.clear(); } catch(_) {}
      try { localStorage.clear(); } catch(_) {}

      if (theme) localStorage.setItem(THEME_KEY, theme);

      // 3) Extra belt-and-braces if your cookie is NOT httpOnly (dev only)
      // document.cookie = 'token=; Max-Age=0; path=/;';

      // 4) Hop to login
      window.location.href = 'login.html';
    });
  })();
</script>

<!-- ðŸ‘‡ Add this block right before </body> -->
<script src="/socket.io/socket.io.js"></script>
<script>
  (function initSocket(){
    const socket = io({ withCredentials: true });
    // expose socket to other scripts
    window.__socket = socket;

    socket.on('connect', () => {
      console.log('âœ… Connected to Socket.IO');
      // if we already have the current user, join the org room
      try { if (window.__me && window.__me.org) socket.emit('join-org', window.__me.org); } catch(_){}
    });

    // When backend emits updates
    socket.on('notifications:update', async () => {
      if (typeof loadNotifs === 'function') await loadNotifs();
    });

    socket.on('kpis:update', () => window.__refreshDashboard?.());
    socket.on('series:update', () => window.__refreshDashboard?.());
    socket.on('integrations:update', () => initServices?.());
  })();
</script>


</body>
</html>
