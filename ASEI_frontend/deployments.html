<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deployments</title>

  <!-- Tailwind CDN + darkMode config -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' } </script>

  <!-- Custom Animations -->
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translate(-50%, -20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
    .animate-fade-in {
      animation: fadeIn 0.2s ease-out;
    }
    .animate-slide-down {
      animation: slideDown 0.3s ease-out;
    }
  </style>

  <!-- graph/chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>


  <!-- Persisted theme -->
  <script>
    (function () {
      const KEY = 'connectify.theme';
      const saved = localStorage.getItem(KEY);
      if (saved === 'dark') document.documentElement.classList.add('dark');
      else {
        document.documentElement.classList.remove('dark');
        if (saved !== 'light') localStorage.setItem(KEY, 'light');
      }
    })();
  </script>

  <link rel="icon" type="image/png" href="images/connectify_logo.png" />
  <!-- Shared APIs -->
  <script src="js/flowDesignerAPI.js"></script>
</head>
<body class="bg-neutral-50 text-neutral-900 dark:bg-neutral-900 dark:text-neutral-100">

  <!-- Sidebar -->
  <aside class="fixed inset-y-0 left-0 w-60 bg-neutral-100 text-neutral-900 dark:bg-neutral-800/40 dark:text-neutral-100 flex flex-col">
    <div class="px-4 py-4 flex items-center gap-2 border-b border-neutral-400 dark:border-gray-400/70">
      <img src="images/connectify_logo.png" alt="Logo" class="h-8 w-auto">
      <span>Connectify</span>
    </div>

      <nav class="p-2 text-sm space-y-1 flex-1">
        <a href="asei_dashboard.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor" d="M13.5 8.183V4.817q0-.357.234-.587t.58-.23h4.88q.347 0 .576.23t.23.587v3.366q0 .358-.234.587q-.234.23-.58.23h-4.88q-.346 0-.576-.23t-.23-.587M4 11.2V4.8q0-.34.234-.57t.58-.23h4.88q.347 
          0 .576.23t.23.57v6.4q0 .34-.234.57t-.58.23h-4.88q-.346 0-.576-.23T4 11.2m9.5 8v-6.4q0-.34.234-.57t.58-.23h4.88q.347 0 .576.23t.23.57v6.4q0 .34-.234.57t-.58.23h-4.88q-.346 0-.576-.23t-.23-.57M4 19.183v-3.366q0-.357.234-.587t.58-.23h4.88q.347 0 .576.23t.23.587v3.366q0 .358-.234.587q-.234.23-.58.23h-4.88q-.346 0-.576-.23T4 19.183M5 11h4.5V5H5zm9.5 8H19v-6h-4.5zm0-11H19V5h-4.5zM5 19h4.5v-3H5zm4.5-3"/>
            </svg></span><span class="hidden sm:inline">Dashboard</span></a>
        
        <a href="flow_designer.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor" d="M11.5 12.5h-5q-.213 0-.356-.144T6 11.999t.144-.356t.356-.143h5v-5q0-.213.144-.356T12.001 6t.356.144t.143.356v5h5q.213 0 .356.144t.144.357t-.144.356t-.356.143h-5v5q0 .213-.144.356t-.357.144t-.356-.144t-.143-.356z"/>
          </svg></span><span class="hidden sm:inline">Flow Designer</span></a>
        
        <a href="connectors.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-5 w-5 -translate-x-[1px]" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M4.513 19.487c2.512 2.392 5.503 1.435 6.7.466c.618-.501.897-.825 
          1.136-1.065c.837-.777.784-1.555.24-2.177c-.219-.249-1.616-1.591-2.956-2.967c-.694-.694-1.172-1.184-1.582-1.58c-.547-.546-1.026-1.172-1.744-1.154c-.658 0-1.136.58-1.735 1.179c-.688.688-1.196 1.555-1.375 2.333c-.539 2.273.299 3.888 1.316 4.965Zm0 0L2 21.999M19.487 4.515c-2.513-2.394-5.494-1.42-6.69-.45c-.62.502-.898.826-1.138 1.066c-.837.778-.784 1.556-.239 2.178c.078.09.31.32.635.644m7.432-3.438c1.017 1.077 1.866 
            2.71 1.327 4.985c-.18.778-.688 1.645-1.376 2.334c-.598.598-1.077 1.179-1.735 1.179c-.718.018-1.09-.502-1.639-1.048m3.423-7.45L22 2m-5.936 9.964c-.41-.395-.994-.993-1.688-1.687c-.858-.882-1.74-1.75-2.321-2.325m4.009 4.012l-1.562 1.525m-3.99-3.984l1.543-1.553"/>
              </svg></span><span class="hidden sm:inline">Connectors</span></a>
        
        <a href="templates.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-5 w-5 -translate-x-[1px]" viewBox="0 0 24 24"><path fill="currentColor" d="M13 9h1v2h-3V7h2zm5.5 0l-2.12-2.12l1.25-1.25L20 8v2h-2v1h-3V9zM13 3.5V2h-1v2h1v2h-2V4H9V2H8v2H6v1H4V4c0-1.11.89-2 2-2h8l2.36 2.36l-1.25 1.25zM20 20a2 2 0 0 1-2 
          2h-2v-2h2v-1h2zm-2-5h2v3h-2zm-6 7v-2h3v2zm-4 0v-2h3v2zm-2 0a2 2 0 0 1-2-2v-2h2v2h1v2zm-2-8h2v3H4zm0-4h2v3H4zm14 1h2v3h-2zM4 6h2v3H4z"/>
            </svg></span><span class="hidden sm:inline">Templates</span></a>
        
        <a href="deployments.html" class="flex items-center gap-2 px-3 py-2 rounded bg-neutral-300 dark:bg-neutral-800"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px] -translate-x-[-2px] -translate-y-[-3px]" viewBox="0 0 24 24"><path fill="currentColor" d="M4.18 7c-.473 0-.88.294-.972.703l-1.189 5.25a1 1 0 0 0-.019.172c0 .483.444.875.99.875h11.02q.098 0 .194-.017c.537-.095.885-.556.778-1.03l-1.19-5.25C13.7 7.294 13.293 7 12.822 7zM5 6v1h7V6h.825c.946 
          0 1.76.606 1.946 1.447l1.19 5.4c.215.975-.482 1.923-1.556 2.118a2 2 0 0 1-.39.035H2.985C1.888 15 1 14.194 1 13.2q0-.178.039-.353l1.19-5.4C2.414 6.606 3.229 6 4.174 6z"/><path fill="currentColor" d="M5.99 1.399a.5.5 0 0 0-.98.202l2.058 9.945c.327 1.582 2.58 1.6 2.933.023l1.845-8.274L12.6 4.3a.5.5 0 0 0 .8-.6l-1.5-2a.5.5 0 0 0-.7-.1l-2 1.5a.5.5 0 1 0 .6.8l1.065-.799l-1.84 8.25c-.118.526-.869.52-.978-.008z"/>
            </svg></span><span class="hidden sm:inline">Deployments</span></a>
        
        <a href="monitoring.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px] -translate-x-[1px]" viewBox="0 0 24 24"><path fill="currentColor" d="M4 20.5q-.214 0-.357-.144T3.5 20v-.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T7.5 
          20v-5.288q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.213 0-.356-.144T11.5 20v-3.288q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T15.5 20v-4.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T19.5 20v-8.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 
            .213-.144.356t-.357.144M14 11.437q-.304 0-.598-.12q-.295-.12-.538-.34l-2.422-2.421q-.173-.173-.442-.173t-.442.173L4.354 13.76q-.146.146-.357.153q-.21.006-.356-.16q-.141-.145-.135-.349t.14-.338l5.218-5.218q.243-.24.538-.35q.294-.11.598-.11t.609.11t.527.35l2.422 2.421q.173.173.442.173t.442-.173l5.204-5.203q.146-.147.357-.153q.21-.007.357.158q.14.146.134.35t-.14.339l-5.217 5.217q-.224.22-.528.34t-.609.12"/>
              </svg></span><span class="hidden sm:inline">Monitoring</span></a>
        
        <a href="settings.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24">
          <path fill="currentColor" d="M10.96 21q-.349 0-.605-.229q-.257-.229-.319-.571l-.263-2.092q-.479-.145-1.036-.454q-.556-.31-.947-.664l-1.915.824q-.317.14-.644.03t-.504-.415L3.648 15.57q-.177-.305-.104-.638t.348-.546l1.672-1.25q-.045-.272-.073-.559q-.03-.288-.03-.559q0-.252.03-.53q.028-.278.073-.626l-1.672-1.25q-.275-.213-.338-.555t.113-.648l1.06-1.8q.177-.287.504-.406t.644.021l1.896.804q.448-.373.97-.673q.52-.3 
          1.013-.464l.283-2.092q.061-.342.318-.571T10.96 3h2.08q.349 0 .605.229q.257.229.319.571l.263 2.112q.575.202 1.016.463t.909.654l1.992-.804q.318-.14.645-.021t.503.406l1.06 1.819q.177.306.104.638t-.348.547L18.36 10.92q.082.31.092.569t.01.51q0 
          .233-.02.491q-.019.259-.088.626l1.69 1.27q.275.213.358.546t-.094.638l-1.066 1.839q-.176.306-.513.415q-.337.11-.654-.03l-1.923-.824q-.467.393-.94.673t-.985.445l-.264 2.111q-.061.342-.318.571t-.605.23zm.04-1h1.956l.369-2.708q.756-.2 
          1.36-.549q.606-.349 1.232-.956l2.495 1.063l.994-1.7l-2.189-1.644q.125-.427.166-.786q.04-.358.04-.72q0-.38-.04-.72t-.166-.747l2.227-1.683l-.994-1.7l-2.552 1.07q-.454-.499-1.193-.935q-.74-.435-1.4-.577L13 
          4h-1.994l-.312 2.689q-.756.161-1.39.52q-.633.358-1.26.985L5.55 7.15l-.994 1.7l2.169 1.62q-.125.336-.175.73t-.05.82q0 .38.05.755t.156.73l-2.15 1.645l.994 1.7l2.475-1.05q.589.594 1.222.953q.634.359 1.428.559zm.973-5.5q1.046 0 1.773-.727T14.473 12t-.727-1.773t-1.773-.727q-1.052 0-1.776.727T9.473 12t.724 1.773t1.776.727M12 12"/>
            </svg></span><span class="hidden sm:inline">Settings</span></a>
      </nav>

    <div class="relative">
      <div id="profileBtn" class="w-full px-4 py-4 flex items-center gap-2 border-t border-neutral-400 dark:border-gray-400/70 text-left">
        <img id="initialSidebarPfp" src="images/default_avatar.png" class="js-initial-pfp h-8 w-8 rounded-full object-cover" alt="O Pfp"/>
        <img id="mainPfp" class="js-main-pfp h-8 w-8 rounded-full object-cover hidden" alt="N Pfp"/>
        <span class="text-sm font-medium">Insert User Name</span>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="ml-60 p-4 sm:p-6 overflow-x-auto space-y-6">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
      <h2 class="text-2xl font-semibold">Deployments</h2>
      <button id="newDeploymentBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded w-full sm:w-auto">+ New Deployment</button>
    </div>

    <!-- KPI Cards -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4 shadow-sm">
        <div id="kpiActive" class="text-2xl font-semibold text-green-600">0</div>
        <div class="text-xs text-neutral-500 dark:text-neutral-400">Active Deployments</div>
      </div>
      <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4 shadow-sm">
        <div id="kpiInProgress" class="text-2xl font-semibold text-yellow-600">0</div>
        <div class="text-xs text-neutral-500 dark:text-neutral-400">In Progress</div>
      </div>
      <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4 shadow-sm">
        <div id="kpiFailed" class="text-2xl font-semibold text-red-600">0</div>
        <div class="text-xs text-neutral-500 dark:text-neutral-400">Failed</div>
      </div>
      <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4 shadow-sm">
        <div id="kpiTotal" class="text-2xl font-semibold text-neutral-700 dark:text-neutral-200">0</div>
        <div class="text-xs text-neutral-500 dark:text-neutral-400">Total Deployments</div>
      </div>
    </section>

    <!-- Overview -->
    <section class="bg-white dark:bg-neutral-800 rounded-xl p-6 shadow-sm border border-neutral-200 dark:border-neutral-700">
      <h3 class="text-lg font-semibold mb-2">Deployment Overview</h3>
      <p class="text-sm text-neutral-500 dark:text-neutral-400 mb-4">
        This dashboard provides insights into your current and past deployments.
      </p>
      <div class="px-4 pt-4 pb-0 flex">
        <p id="deployDate" class="ml-auto text-xs text-neutral-500 dark:text-neutral-400"></p>
      </div>

      <div class="px-4 pb-4">
        <div class="h-48">
          <canvas id="deployChart" class="h-48 w-full"></canvas>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="bg-white dark:bg-neutral-800 rounded shadow border border-neutral-200 dark:border-neutral-700">
      <div class="flex justify-between items-center p-4 border-b border-neutral-100 dark:border-neutral-700">
        <h3 class="font-semibold text-lg">Recent Deployments</h3>
        <select id="envFilter" class="border rounded px-3 py-2 text-sm bg-white dark:bg-neutral-700 border-neutral-300 dark:border-neutral-600">
          <option value="">All Environments</option>
          <option value="production">Production</option>
          <option value="test">Test</option>
          <option value="sandbox">Sandbox</option>
        </select>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-neutral-200 dark:bg-neutral-700">
            <tr>
              <th class="p-3 text-left">Flow Name</th>
              <th class="p-3 text-left">Environment</th>
              <th class="p-3 text-left">Version</th>
              <th class="p-3 text-left">Status</th>
              <th class="p-3 text-left">Deployed At</th>
              <th class="p-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="deploymentsTbody">
            <!-- populated dynamically -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Activity -->
    <section class="bg-white dark:bg-neutral-800 rounded-xl p-6 shadow-sm border border-neutral-200 dark:border-neutral-700">
      <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
      <ul id="recentActivityList" class="space-y-4 text-sm">
        <li class="text-neutral-500 dark:text-neutral-400 text-center py-4">Loading activity...</li>
      </ul>
    </section>

    <!-- Info -->
    <section class="bg-white dark:bg-neutral-800 rounded-xl p-6 shadow-sm border border-neutral-200 dark:border-neutral-700">
      <h3 class="text-lg font-semibold mb-3">About Deployments</h3>
      <div class="space-y-3 text-sm text-neutral-600 dark:text-neutral-400">
        <p>
          Deployments allow you to execute your configured data flows across different environments, ensuring your integrations work as expected before going live.
        </p>
        
        <div class="border-l-4 border-blue-500 pl-3 py-2 bg-blue-50 dark:bg-blue-900/20">
          <p class="font-semibold text-neutral-900 dark:text-neutral-100 mb-1">Environments:</p>
          <ul class="space-y-1 ml-2">
            <li class="flex items-center gap-2">
              <span class="h-2 w-2 bg-green-500 rounded-full"></span>
              <strong class="text-green-600 dark:text-green-400">Sandbox</strong> - Testing environment with mock data
            </li>
            <li class="flex items-center gap-2">
              <span class="h-2 w-2 bg-yellow-500 rounded-full"></span>
              <strong class="text-yellow-600 dark:text-yellow-400">Test</strong> - Pre-production environment for validation
            </li>
            <li class="flex items-center gap-2">
              <span class="h-2 w-2 bg-red-500 rounded-full"></span>
              <strong class="text-red-600 dark:text-red-400">Production</strong> - Live environment with real data
            </li>
          </ul>
        </div>

        <p>
          <strong>Tip:</strong> Always test your flows in Sandbox and Test environments before deploying to Production to avoid disruptions.
        </p>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="deployModal" class="fixed inset-0 bg-black/50 hidden grid place-items-center z-50">
    <div class="bg-white dark:bg-neutral-800 rounded-xl p-6 w-11/12 sm:w-96 border border-neutral-200 dark:border-neutral-700">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">New Deployment</h2>
        <button id="closeDeploy" class="text-neutral-500 hover:text-neutral-900 dark:hover:text-neutral-200">&times;</button>
      </div>
      <form id="deployForm">
        <div class="mb-3">
          <label class="block text-sm font-medium mb-1">Flow Name</label>
          <select id="deployFlow" required class="w-full border border-neutral-300 dark:border-neutral-600 rounded px-3 py-2 bg-white dark:bg-neutral-600">
            <option value="" disabled selected>Select a flow</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="block text-sm font-medium mb-1">Environment</label>
          <select id="deployEnvironment" class="w-full border border-neutral-300 dark:border-neutral-600 rounded px-3 py-2 bg-white dark:bg-neutral-600">
            <option value="production">Production</option>
            <option value="test">Test</option>
            <option value="sandbox" selected>Sandbox</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="block text-sm font-medium mb-1">Version</label>
          <input id="deployVersion" type="text" class="w-full border border-neutral-300 dark:border-neutral-600 rounded px-3 py-2 bg-white dark:bg-neutral-600" placeholder="Optional (uses latest)">
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="cancelDeploy" class="px-4 py-2 rounded-lg bg-neutral-20 hover:bg-neutral-300 dark:bg-neutral-400 dark:hover:bg-neutral-500 border dark:border-neutral-500">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Deploy</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script>
  // Modal logic
    const modal = document.getElementById("deployModal");
    const newBtn = document.getElementById("newDeploymentBtn");
    const closeBtn = document.getElementById("closeDeploy");
    const cancelBtn = document.getElementById("cancelDeploy");

    function openModal() { modal.classList.remove("hidden"); }
    function closeModal() { modal.classList.add("hidden"); }

    newBtn?.addEventListener("click", openModal);
    closeBtn?.addEventListener("click", closeModal);
    cancelBtn?.addEventListener("click", closeModal);
    window.addEventListener("click", e => { if (e.target === modal) closeModal(); });

    document.getElementById("deployForm").addEventListener("submit", e => {
      e.preventDefault();
      closeModal();
      showNotification("Deployment initiated successfully!", "success");
    });
  </script>

    <!-- Data wiring + Chart (real data) -->
    <script>
  const $ = (id) => document.getElementById(id);

  function currentThemeIsDark() {
    return document.documentElement.classList.contains('dark');
  }

  // Fetch current user and set name
  async function loadUser() {
    try {
      const res = await fetch('/api/dashboard/me', { credentials: 'include' });
      if (!res.ok) return;
      const me = await res.json();
      const name = [me.firstName, me.lastName].filter(Boolean).join(' ') || me.email || 'User';
      const profileBtn = document.getElementById('profileBtn');
      if (profileBtn) {
        const span = profileBtn.querySelector('span');
        if (span) span.textContent = name;
      }
    } catch (e) {
      console.warn('Failed to load user', e);
    }
  }

  // Store executions globally for filtering
  let allExecutions = [];

  // Map flow status to badge styling
  function statusBadge(status) {
    const s = String(status || '').toLowerCase();
    const styles = {
      active: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300',
      draft: 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300',
      inactive: 'bg-neutral-200 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-200'
    };
    const cls = styles[s] || styles.inactive;
    const label = s ? s.charAt(0).toUpperCase() + s.slice(1) : 'Inactive';
    return `<span class="px-2 py-1 ${cls} text-xs rounded">${label}</span>`;
  }

  // Render flows into table and KPIs
  async function loadDeployments() {
    try {
      const flows = await FlowAPI.getAllFlows();

      // Populate flow dropdown in modal
      const flowSelect = document.getElementById('deployFlow');
      if (flowSelect) {
        flowSelect.innerHTML = '<option value="" disabled selected>Select a flow</option>' +
          flows.map(f => `<option value="${f.id}">${f.name || '(unnamed flow)'}${f.latest_version ? ` (v${f.latest_version})` : ''}</option>`).join('');
      }

      // Table rows: show recent executions (deployments)
      const tbody = $('deploymentsTbody');
      let execs = [];
      try {
        const res = await fetch('/api/executions/recent?limit=100', { credentials: 'include' });
        if (res.ok) {
          execs = await res.json();
          allExecutions = execs; // Store globally for filtering
          console.log('âœ… Loaded executions:', execs.length, execs);
        } else {
          console.warn('âš ï¸ API returned status:', res.status);
        }
      } catch (err) {
        console.error('âŒ Failed to fetch executions:', err);
      }

      // Calculate KPIs from execution data
      const total = execs.length;
      const active = execs.filter(e => {
        const status = (e.status || '').toLowerCase();
        return status === 'completed';
      }).length;
      const inProgress = execs.filter(e => {
        const status = (e.status || '').toLowerCase();
        return status === 'running' || status === 'pending' || status === 'queued';
      }).length;
      const failed = execs.filter(e => {
        const status = (e.status || '').toLowerCase();
        return status === 'failed' || status === 'error';
      }).length;
      
      $('kpiTotal').textContent = total;
      $('kpiActive').textContent = active;
      $('kpiInProgress').textContent = inProgress;
      $('kpiFailed').textContent = failed;

      console.log('ðŸ“Š KPIs - Total:', total, 'Active:', active, 'In Progress:', inProgress, 'Failed:', failed);
      console.log('ðŸ“Š Rendering table with', execs.length, 'executions');
      renderExecutions(execs);
      renderRecentActivity(execs.slice(0, 5)); // Show top 5 most recent
    } catch (e) {
      console.error('Failed to load deployments', e);
    }
  }

  // Render recent activity feed
  function renderRecentActivity(execs) {
    const activityList = $('recentActivityList');
    if (!activityList) return;

    if (!execs || execs.length === 0) {
      activityList.innerHTML = '<li class="text-neutral-500 dark:text-neutral-400 text-center py-4">No recent activity</li>';
      return;
    }

    activityList.innerHTML = execs.map(e => {
      const environment = e.triggerData?.environment || 'sandbox';
      const envDisplay = environment.charAt(0).toUpperCase() + environment.slice(1);
      const status = (e.status || '').toLowerCase();
      
      // Determine status color and icon
      let statusColor, statusIcon, statusText;
      if (status === 'completed') {
        statusColor = 'bg-green-500';
        statusText = 'successfully deployed to';
      } else if (status === 'running') {
        statusColor = 'bg-yellow-500';
        statusText = 'deployment in progress for';
      } else if (status === 'failed') {
        statusColor = 'bg-red-500';
        statusText = 'deployment failed for';
      } else {
        statusColor = 'bg-neutral-500';
        statusText = 'deployment status unknown for';
      }

      const envColor = {
        production: 'text-red-600 dark:text-red-400 font-semibold',
        test: 'text-yellow-600 dark:text-yellow-400',
        sandbox: 'text-green-600 dark:text-green-400'
      }[environment] || 'text-neutral-600 dark:text-neutral-400';

      const timeStr = e.startedAt ? new Date(e.startedAt).toLocaleString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric', 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      }) : 'Unknown time';

      return `
        <li class="flex items-start gap-3">
          <span class="h-3 w-3 mt-1 ${statusColor} rounded-full flex-shrink-0"></span>
          <div class="flex-1 min-w-0">
            <p class="break-words"><strong>${e.flowName || 'Unknown Flow'}</strong> ${statusText} <span class="${envColor}">${envDisplay}</span>.</p>
            <p class="text-neutral-500 dark:text-neutral-400 text-xs">${timeStr}</p>
          </div>
        </li>
      `;
    }).join('');
  }

  // Helper function to render execution badge
  function badgeForExec(s) {
    const map = {
      running: 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300',
      completed: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300',
      failed: 'bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300',
      cancelled: 'bg-neutral-200 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-200'
    };
    const k = (s||'').toLowerCase();
    const cls = map[k] || map.cancelled;
    const label = k ? k.charAt(0).toUpperCase() + k.slice(1) : 'Unknown';
    return `<span class="px-2 py-1 ${cls} text-xs rounded">${label}</span>`;
  }

  // Render executions to table
  function renderExecutions(execs) {
    const tbody = $('deploymentsTbody');
    if (!tbody) return;

    if (!execs || execs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-neutral-500">No deployments found</td></tr>';
      return;
    }

    tbody.innerHTML = execs.map(e => {
      // Extract environment from triggerData
      const environment = e.triggerData?.environment || 'sandbox';
      const envDisplay = environment.charAt(0).toUpperCase() + environment.slice(1);
      const envColor = {
        production: 'text-red-600 dark:text-red-400 font-semibold',
        test: 'text-yellow-600 dark:text-yellow-400',
        sandbox: 'text-green-600 dark:text-green-400'
      }[environment] || 'text-neutral-600 dark:text-neutral-400';
      
      const ver = e.version ? `v${e.version}` : '-';
      const when = e.startedAt ? new Date(e.startedAt).toLocaleString() : '-';
      return `
        <tr class="border-t border-neutral-200 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-700/50" data-environment="${environment}">
          <td class="p-3">${e.flowName || '(unnamed flow)'}</td>
          <td class="p-3"><span class="${envColor}">${envDisplay}</span></td>
          <td class="p-3">${ver}</td>
          <td class="p-3">${badgeForExec(e.status)}</td>
          <td class="p-3 text-xs text-neutral-500 dark:text-neutral-400">${when}</td>
          <td class="p-3 space-x-2">
            <button class="px-2 py-1 bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 rounded text-xs" data-exec-id="${e.id}" data-action="details">Details</button>
          </td>
        </tr>`;
    }).join('');
  }

  // Filter executions by environment
  function filterExecutions(environment) {
    if (!environment) {
      renderExecutions(allExecutions);
      return;
    }
    const filtered = allExecutions.filter(e => {
      const env = e.triggerData?.environment || 'sandbox';
      return env === environment;
    });
    renderExecutions(filtered);
  }

  // Show execution details modal
  async function showExecutionDetails(executionId) {
    try {
      const response = await fetch(`/api/executions/${executionId}`, { credentials: 'include' });
      if (!response.ok) throw new Error('Failed to load execution details');
      
      const execution = await response.json();
      const stepsResponse = await fetch(`/api/executions/${executionId}/steps`, { credentials: 'include' });
      const steps = stepsResponse.ok ? await stepsResponse.json() : [];
      
      // Create modal content
      const environment = execution.triggerData?.environment || 'sandbox';
      const modalHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" id="detailsModal">
          <div class="bg-white dark:bg-neutral-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[80vh] overflow-auto">
            <div class="flex justify-between items-center p-6 border-b border-neutral-200 dark:border-neutral-700">
              <h2 class="text-xl font-semibold">Execution Details</h2>
              <button onclick="document.getElementById('detailsModal').remove()" class="text-neutral-500 hover:text-neutral-700 dark:hover:text-neutral-300 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <p class="text-sm text-neutral-500 dark:text-neutral-400">Execution ID</p>
                  <p class="font-mono text-sm">${execution.id}</p>
                </div>
                <div>
                  <p class="text-sm text-neutral-500 dark:text-neutral-400">Flow</p>
                  <p>${execution.flowName || 'Unknown'}</p>
                </div>
                <div>
                  <p class="text-sm text-neutral-500 dark:text-neutral-400">Environment</p>
                  <p class="capitalize">${environment}</p>
                </div>
                <div>
                  <p class="text-sm text-neutral-500 dark:text-neutral-400">Status</p>
                  <p>${badgeForExec(execution.status)}</p>
                </div>
                <div>
                  <p class="text-sm text-neutral-500 dark:text-neutral-400">Started At</p>
                  <p class="text-sm">${execution.startedAt ? new Date(execution.startedAt).toLocaleString() : '-'}</p>
                </div>
                <div>
                  <p class="text-sm text-neutral-500 dark:text-neutral-400">Completed At</p>
                  <p class="text-sm">${execution.completedAt ? new Date(execution.completedAt).toLocaleString() : '-'}</p>
                </div>
              </div>
              ${steps.length > 0 ? `
                <div class="mt-6">
                  <h3 class="font-semibold mb-3">Execution Steps</h3>
                  <div class="space-y-2">
                    ${steps.map((step, index) => `
                      <div class="border border-neutral-200 dark:border-neutral-700 rounded p-3">
                        <div class="flex justify-between items-start gap-3">
                          <div class="flex-1">
                            <span class="font-medium">${step.node_id || 'Step ' + (index + 1)}</span>
                            ${step.node_type ? `<span class="text-xs text-neutral-500 dark:text-neutral-400 ml-2">(${step.node_type}${step.node_kind ? ': ' + step.node_kind : ''})</span>` : ''}
                            ${step.started_at ? `<p class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">Started: ${new Date(step.started_at).toLocaleTimeString()}</p>` : ''}
                          </div>
                          ${badgeForExec(step.status)}
                        </div>
                        ${step.error_message ? `<p class="text-xs text-red-600 dark:text-red-400 mt-2">Error: ${step.error_message}</p>` : ''}
                        ${step.execution_time_ms ? `<p class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">Execution time: ${step.execution_time_ms}ms</p>` : ''}
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : '<p class="text-neutral-500 text-sm">No step details available</p>'}
            </div>
            <div class="flex justify-between p-6 border-t border-neutral-200 dark:border-neutral-700">
              <button onclick="deleteExecution('${executionId}')" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">Delete</button>
              <button onclick="document.getElementById('detailsModal').remove()" class="px-4 py-2 bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 rounded">Close</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    } catch (error) {
      console.error('Failed to show execution details:', error);
      showNotification('Failed to load execution details: ' + error.message, 'error');
    }
  }

  // Show custom confirmation modal
  function showConfirmModal(title, message, onConfirm) {
    const modalHTML = `
      <div class="fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center" id="confirmModal">
        <div class="bg-white dark:bg-neutral-800 rounded-lg shadow-xl max-w-md w-full mx-4 animate-fade-in">
          <div class="p-6">
            <div class="flex items-center gap-3 mb-4">
              <div class="h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                <svg class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-neutral-900 dark:text-neutral-100">${title}</h3>
              </div>
            </div>
            <p class="text-neutral-600 dark:text-neutral-400 mb-6">${message}</p>
            <div class="flex gap-3 justify-end">
              <button onclick="document.getElementById('confirmModal').remove()" class="px-4 py-2 bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 rounded transition-colors">
                Cancel
              </button>
              <button id="confirmBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition-colors">
                Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add click handler to confirm button
    document.getElementById('confirmBtn')?.addEventListener('click', () => {
      document.getElementById('confirmModal')?.remove();
      onConfirm();
    });
  }

  // Show custom notification
  function showNotification(message, type = 'success') {
    const colors = {
      success: 'bg-green-600',
      error: 'bg-red-600',
      info: 'bg-blue-600'
    };
    
    const icons = {
      success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',
      error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>',
      info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'
    };
    
    const notificationHTML = `
      <div class="fixed top-4 left-1/2 -translate-x-1/2 z-[70] animate-slide-down" id="notification">
        <div class="${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px]">
          <svg class="h-6 w-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            ${icons[type]}
          </svg>
          <span class="flex-1">${message}</span>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', notificationHTML);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      document.getElementById('notification')?.remove();
    }, 5000);
  }

  // Delete execution with custom modal
  async function deleteExecution(executionId) {
    showConfirmModal(
      'Delete Execution',
      'Are you sure you want to delete this execution? This action cannot be undone and will remove all execution logs and steps.',
      async () => {
        try {
          const response = await fetch(`/api/executions/${executionId}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error(`Failed to delete execution: ${response.status}`);
          }

          // Close the details modal
          document.getElementById('detailsModal')?.remove();

          // Reload the deployments table
          await loadDeployments();

          // Show success notification
          showNotification('Execution deleted successfully', 'success');
          console.log('âœ… Execution deleted successfully');
        } catch (error) {
          console.error('Failed to delete execution:', error);
          showNotification('Failed to delete execution: ' + error.message, 'error');
        }
      }
    );
  }

  // Chart â€“ use real transactions series as proxy for deployment activity
  let deployChart;
  async function initDeployChart() {
    try {
      const canvas = $('deployChart');
      if (!canvas) {
        console.error('âŒ Canvas element "deployChart" not found');
        return;
      }
      console.log('âœ… Canvas found:', canvas);

      // update timestamp
      const stamp = $('deployDate');
      if (stamp) {
        const d = new Date();
        stamp.textContent = `Updated: ${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;
      }

      // fetch series
      let points = [];
      try {
        const res = await fetch('/api/dashboard/transactions/series', { credentials: 'include' });
        if (res.ok) {
          const js = await res.json();
          points = (js.points || []).map(p => ({ x: p.t, y: p.count }));
          console.log('âœ… Loaded series data:', points.length, 'points');
        } else {
          console.warn('âš ï¸ Series API returned status:', res.status);
        }
      } catch (e) {
        console.warn('Failed to load series', e);
      }

      // Ensure we have a continuous series (last 24h, hourly buckets)
      const ONE_HOUR = 60 * 60 * 1000;
      const end = Date.now();
      const start = end - 23 * ONE_HOUR;
      const byHour = new Map(points.map(p => [Math.floor(p.x / ONE_HOUR) * ONE_HOUR, p.y]));
      const data = [];
      for (let t = start; t <= end; t += ONE_HOUR) {
        const key = Math.floor(t / ONE_HOUR) * ONE_HOUR;
        data.push({ x: key, y: byHour.get(key) ?? 0 });
      }
      console.log('ðŸ“Š Chart data prepared:', data.length, 'data points');

      // dark mode
      const lineColor = currentThemeIsDark() ? '#a8b3cf' : '#1f2937';
      const gridColor = currentThemeIsDark() ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)';
      const tickColor = currentThemeIsDark() ? '#cbd5e1' : '#475569';

      const smallSeries = data.filter(p => p.y !== undefined).length < 2;

      deployChart = new Chart(canvas, {
      type: 'line',
      data: { datasets: [{ label: 'Transactions', data, borderWidth: 2, tension: 0.35, borderColor: lineColor, fill: false, pointRadius: smallSeries ? 2 : 0, pointHitRadius: 10 }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: { legend: { display: false }, tooltip: { displayColors: false, callbacks: { title(items){ const d = new Date(items[0].parsed.x); return d.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'2-digit'}); }, label(item){ return `Count: ${item.parsed.y}`; } } } },
        scales: {
          x: { type: 'time', time: { unit: 'hour', displayFormats: { hour: 'HH:mm' }, tooltipFormat: 'HH:mm' }, grid: { color: gridColor, drawOnChartArea: false }, ticks: { color: tickColor, maxTicksLimit: 7 } },
          y: { beginAtZero: true, suggestedMax: Math.max(...data.map(p => p.y)) + 1, ticks: { precision: 0, color: tickColor }, grid: { color: gridColor } }
        }
      }
    });
      console.log('âœ… Chart initialized successfully');
    } catch (err) {
      console.error('âŒ Failed to initialize chart:', err);
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await loadUser();
    await loadDeployments();
    await initDeployChart();

    // Environment filter dropdown
    const envFilter = document.getElementById('envFilter');
    envFilter?.addEventListener('change', (e) => {
      filterExecutions(e.target.value);
    });

    // Details button click handler (event delegation)
    const deploymentsTable = document.getElementById('deploymentsTbody');
    deploymentsTable?.addEventListener('click', async (e) => {
      const detailsBtn = e.target.closest('[data-action="details"]');
      if (detailsBtn) {
        const executionId = detailsBtn.getAttribute('data-exec-id');
        if (executionId) {
          await showExecutionDetails(executionId);
        }
      }
    });

    // Wire up deployment form to actually trigger a deploy (activate flow)
    const form = document.getElementById('deployForm');
    const flowSelect = document.getElementById('deployFlow');
    const envSelect = document.getElementById('deployEnvironment');
    const versionInput = document.getElementById('deployVersion');
    
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const flowId = flowSelect?.value;
      if (!flowId) return;
      
      const environment = envSelect?.value || 'sandbox';
      const version = versionInput?.value?.trim() || null;
      
      try {
        // First, activate the flow if it's not already active
        await FlowAPI.updateFlowStatus(flowId, 'active');
        
        // Then start an execution with the selected environment
        const response = await fetch('/api/executions/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            flowId,
            triggerType: 'deploy',
            triggerData: {
              environment,
              version,
              deployedAt: new Date().toISOString()
            }
          })
        });
        
        if (!response.ok) {
          throw new Error(`Deployment failed: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('âœ… Deployment started:', result);
        
        closeModal();
        showNotification('Deployment started successfully!', 'success');
        // refresh table and KPIs
        await loadDeployments();
      } catch (err) {
        console.error('âŒ Deployment error:', err);
        showNotification('Failed to deploy: ' + (err?.message || err), 'error');
      }
    });

    // Inline deploy button in fallback flow table
    const tbody = document.getElementById('deploymentsTbody');
    tbody?.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('[data-action="deployFlow"]');
      if (!btn) return;
      const flowId = btn.getAttribute('data-flow-id');
      if (!flowId) return;
      btn.disabled = true;
      try {
        await FlowAPI.updateFlowStatus(flowId, 'active');
        await loadDeployments();
        showNotification('Flow deployed successfully!', 'success');
      } catch (err) {
        showNotification('Failed to deploy: ' + (err?.message || err), 'error');
      } finally {
        btn.disabled = false;
      }
    });
  });
    </script>

<!-- Profile Picture Loading Script -->
<script>
  const imageStore = 'connectify.pfpUrl';
  function applyPfpToDOM(pfpUrl) {
    document.querySelectorAll('.js-main-pfp').forEach(img => {
      img.src = pfpUrl;
      img.classList.remove("hidden");
    });
    document.querySelectorAll(".js-initial-pfp").forEach(el => el.classList.add("hidden"));
  }
  
  document.addEventListener('DOMContentLoaded', async () => {
    // Load from backend first
    try {
      const res = await fetch('/api/auth/me', { credentials: 'include' });
      if (res.ok) {
        const data = await res.json();
        if (data.user?.profilePicture) {
          applyPfpToDOM(data.user.profilePicture);
          return;
        }
      }
    } catch (e) {
      console.warn("Could not load profile picture from backend:", e);
    }
    
    // Fallback to localStorage
    const saveImg = localStorage.getItem(imageStore);
    if (saveImg) applyPfpToDOM(saveImg);
  });
</script>

</body>
</html>
