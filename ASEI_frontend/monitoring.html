<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitoring</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { darkMode: 'class' };
</script>

<!-- graph/chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
<script>
  (function () {
    const KEY = 'connectify.theme';
    const saved = localStorage.getItem(KEY);
    if (saved === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
      if (saved !== 'light') localStorage.setItem(KEY, 'light');
    }
  })();
</script>
<link rel="icon" type="image/png" href="images/connectify_logo.png">
<!-- Shared APIs -->
<script src="js/flowDesignerAPI.js"></script>

<!-- Custom Animations -->
<style>
  @keyframes slideDown {
    from { opacity: 0; transform: translate(-50%, -20px); }
    to { opacity: 1; transform: translate(-50%, 0); }
  }
  .animate-slide-down {
    animation: slideDown 0.3s ease-out;
  }
</style>
</head>
<body class="bg-neutral-50 text-neutral-900 dark:bg-neutral-900 dark:text-neutral-100">


  <!-- Sidebar -->
    <aside class="fixed inset-y-0 left-0 w-60 bg-neutral-100 text-neutral-900 dark:bg-neutral-800/40 dark:text-neutral-100 flex flex-col">
      <div class="px-4 py-4 flex items-center gap-2 border-b border-neutral-400 dark:border-gray-400/70">
        <img src="images/connectify_logo.png" alt="Logo" class="h-8 w-auto">
        <span>Connectify</span>
      </div>

      <nav class="p-2 text-sm space-y-1 flex-1">
        <a href="asei_dashboard.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor" d="M13.5 8.183V4.817q0-.357.234-.587t.58-.23h4.88q.347 0 .576.23t.23.587v3.366q0 .358-.234.587q-.234.23-.58.23h-4.88q-.346 0-.576-.23t-.23-.587M4 11.2V4.8q0-.34.234-.57t.58-.23h4.88q.347 
          0 .576.23t.23.57v6.4q0 .34-.234.57t-.58.23h-4.88q-.346 0-.576-.23T4 11.2m9.5 8v-6.4q0-.34.234-.57t.58-.23h4.88q.347 0 .576.23t.23.57v6.4q0 .34-.234.57t-.58.23h-4.88q-.346 0-.576-.23t-.23-.57M4 19.183v-3.366q0-.357.234-.587t.58-.23h4.88q.347 0 .576.23t.23.587v3.366q0 .358-.234.587q-.234.23-.58.23h-4.88q-.346 0-.576-.23T4 19.183M5 11h4.5V5H5zm9.5 8H19v-6h-4.5zm0-11H19V5h-4.5zM5 19h4.5v-3H5zm4.5-3"/>
            </svg></span><span class="hidden sm:inline">Dashboard</span></a>
        
        <a href="flow_designer.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor" d="M11.5 12.5h-5q-.213 0-.356-.144T6 11.999t.144-.356t.356-.143h5v-5q0-.213.144-.356T12.001 6t.356.144t.143.356v5h5q.213 0 .356.144t.144.357t-.144.356t-.356.143h-5v5q0 .213-.144.356t-.357.144t-.356-.144t-.143-.356z"/>
          </svg></span><span class="hidden sm:inline">Flow Designer</span></a>
        
        <a href="connectors.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-5 w-5 -translate-x-[1px]" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M4.513 19.487c2.512 2.392 5.503 1.435 6.7.466c.618-.501.897-.825 
          1.136-1.065c.837-.777.784-1.555.24-2.177c-.219-.249-1.616-1.591-2.956-2.967c-.694-.694-1.172-1.184-1.582-1.58c-.547-.546-1.026-1.172-1.744-1.154c-.658 0-1.136.58-1.735 1.179c-.688.688-1.196 1.555-1.375 2.333c-.539 2.273.299 3.888 1.316 4.965Zm0 0L2 21.999M19.487 4.515c-2.513-2.394-5.494-1.42-6.69-.45c-.62.502-.898.826-1.138 1.066c-.837.778-.784 1.556-.239 2.178c.078.09.31.32.635.644m7.432-3.438c1.017 1.077 1.866 
            2.71 1.327 4.985c-.18.778-.688 1.645-1.376 2.334c-.598.598-1.077 1.179-1.735 1.179c-.718.018-1.09-.502-1.639-1.048m3.423-7.45L22 2m-5.936 9.964c-.41-.395-.994-.993-1.688-1.687c-.858-.882-1.74-1.75-2.321-2.325m4.009 4.012l-1.562 1.525m-3.99-3.984l1.543-1.553"/>
              </svg></span><span class="hidden sm:inline">Connectors</span></a>
        
        <a href="templates.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-5 w-5 -translate-x-[1px]" viewBox="0 0 24 24"><path fill="currentColor" d="M13 9h1v2h-3V7h2zm5.5 0l-2.12-2.12l1.25-1.25L20 8v2h-2v1h-3V9zM13 3.5V2h-1v2h1v2h-2V4H9V2H8v2H6v1H4V4c0-1.11.89-2 2-2h8l2.36 2.36l-1.25 1.25zM20 20a2 2 0 0 1-2 
          2h-2v-2h2v-1h2zm-2-5h2v3h-2zm-6 7v-2h3v2zm-4 0v-2h3v2zm-2 0a2 2 0 0 1-2-2v-2h2v2h1v2zm-2-8h2v3H4zm0-4h2v3H4zm14 1h2v3h-2zM4 6h2v3H4z"/>
            </svg></span><span class="hidden sm:inline">Templates</span></a>
        
        <a href="deployments.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px] -translate-x-[-2px] -translate-y-[-3px]" viewBox="0 0 24 24"><path fill="currentColor" d="M4.18 7c-.473 0-.88.294-.972.703l-1.189 5.25a1 1 0 0 0-.019.172c0 .483.444.875.99.875h11.02q.098 0 .194-.017c.537-.095.885-.556.778-1.03l-1.19-5.25C13.7 7.294 13.293 7 12.822 7zM5 6v1h7V6h.825c.946 
          0 1.76.606 1.946 1.447l1.19 5.4c.215.975-.482 1.923-1.556 2.118a2 2 0 0 1-.39.035H2.985C1.888 15 1 14.194 1 13.2q0-.178.039-.353l1.19-5.4C2.414 6.606 3.229 6 4.174 6z"/><path fill="currentColor" d="M5.99 1.399a.5.5 0 0 0-.98.202l2.058 9.945c.327 1.582 2.58 1.6 2.933.023l1.845-8.274L12.6 4.3a.5.5 0 0 0 .8-.6l-1.5-2a.5.5 0 0 0-.7-.1l-2 1.5a.5.5 0 1 0 .6.8l1.065-.799l-1.84 8.25c-.118.526-.869.52-.978-.008z"/>
            </svg></span><span class="hidden sm:inline">Deployments</span></a>
        
        <a href="monitoring.html" class="flex items-center gap-2 px-3 py-2 rounded bg-neutral-300 dark:bg-neutral-800"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px] -translate-x-[1px]" viewBox="0 0 24 24"><path fill="currentColor" d="M4 20.5q-.214 0-.357-.144T3.5 20v-.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T7.5 
          20v-5.288q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.213 0-.356-.144T11.5 20v-3.288q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T15.5 20v-4.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T19.5 20v-8.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 
            .213-.144.356t-.357.144M14 11.437q-.304 0-.598-.12q-.295-.12-.538-.34l-2.422-2.421q-.173-.173-.442-.173t-.442.173L4.354 13.76q-.146.146-.357.153q-.21.006-.356-.16q-.141-.145-.135-.349t.14-.338l5.218-5.218q.243-.24.538-.35q.294-.11.598-.11t.609.11t.527.35l2.422 2.421q.173.173.442.173t.442-.173l5.204-5.203q.146-.147.357-.153q.21-.007.357.158q.14.146.134.35t-.14.339l-5.217 5.217q-.224.22-.528.34t-.609.12"/>
              </svg></span><span class="hidden sm:inline">Monitoring</span></a>
        
        <a href="settings.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24">
          <path fill="currentColor" d="M10.96 21q-.349 0-.605-.229q-.257-.229-.319-.571l-.263-2.092q-.479-.145-1.036-.454q-.556-.31-.947-.664l-1.915.824q-.317.14-.644.03t-.504-.415L3.648 15.57q-.177-.305-.104-.638t.348-.546l1.672-1.25q-.045-.272-.073-.559q-.03-.288-.03-.559q0-.252.03-.53q.028-.278.073-.626l-1.672-1.25q-.275-.213-.338-.555t.113-.648l1.06-1.8q.177-.287.504-.406t.644.021l1.896.804q.448-.373.97-.673q.52-.3 
          1.013-.464l.283-2.092q.061-.342.318-.571T10.96 3h2.08q.349 0 .605.229q.257.229.319.571l.263 2.112q.575.202 1.016.463t.909.654l1.992-.804q.318-.14.645-.021t.503.406l1.06 1.819q.177.306.104.638t-.348.547L18.36 10.92q.082.31.092.569t.01.51q0 
          .233-.02.491q-.019.259-.088.626l1.69 1.27q.275.213.358.546t-.094.638l-1.066 1.839q-.176.306-.513.415q-.337.11-.654-.03l-1.923-.824q-.467.393-.94.673t-.985.445l-.264 2.111q-.061.342-.318.571t-.605.23zm.04-1h1.956l.369-2.708q.756-.2 
          1.36-.549q.606-.349 1.232-.956l2.495 1.063l.994-1.7l-2.189-1.644q.125-.427.166-.786q.04-.358.04-.72q0-.38-.04-.72t-.166-.747l2.227-1.683l-.994-1.7l-2.552 1.07q-.454-.499-1.193-.935q-.74-.435-1.4-.577L13 
          4h-1.994l-.312 2.689q-.756.161-1.39.52q-.633.358-1.26.985L5.55 7.15l-.994 1.7l2.169 1.62q-.125.336-.175.73t-.05.82q0 .38.05.755t.156.73l-2.15 1.645l.994 1.7l2.475-1.05q.589.594 1.222.953q.634.359 1.428.559zm.973-5.5q1.046 0 1.773-.727T14.473 12t-.727-1.773t-1.773-.727q-1.052 0-1.776.727T9.473 12t.724 1.773t1.776.727M12 12"/>
            </svg></span><span class="hidden sm:inline">Settings</span></a>
      </nav>

    <div class="relative">
      <div id="profileBtn" class="w-full px-4 py-4 flex items-center gap-2 border-t border-neutral-400 dark:border-gray-400/70 text-left">

          <img id="initialSidebarPfp" src="images/default_avatar.png" class="js-initial-pfp h-8 w-8 rounded-full object-cover" alt="O Pfp"/>
          <img id="mainPfp" class="js-main-pfp h-8 w-8 rounded-full object-cover hidden" alt="N Pfp"/>
          <span id="sidebarUsername" class="text-sm font-medium">Loading...</span>
      </div>

    </div>
  </aside>




<main class="p-6 ml-60 overflow-x-auto space-y-6">
  <h2 class="text-2xl font-semibold mb-4">Monitoring Dashboard</h2>

  <!-- KPI Cards -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4 shadow-sm">
      <div id="kpiUptime" class="text-2xl font-semibold text-green-600">--</div>
      <div class="text-xs text-neutral-500 dark:text-neutral-400">Success Rate (24h)</div>
    </div>
    <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4 shadow-sm">
      <div id="kpiTotal" class="text-2xl font-semibold text-blue-600">--</div>
      <div class="text-xs text-neutral-500 dark:text-neutral-400">Total Executions (24h)</div>
    </div>
    <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4 shadow-sm">
      <div id="kpiRunning" class="text-2xl font-semibold text-orange-600">--</div>
      <div class="text-xs text-neutral-500 dark:text-neutral-400">Currently Running</div>
    </div>
    <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4 shadow-sm">
      <div id="kpiAvgTime" class="text-2xl font-semibold text-indigo-600">--</div>
      <div class="text-xs text-neutral-500 dark:text-neutral-400">Avg. Execution Time</div>
    </div>
  </section>

  <!-- Charts Section -->
  <section class="bg-white dark:bg-neutral-800 ounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
    <h3 class="text-lg font-semibold mb-2">Performance Overview</h3>
      <div class="px-4 pt-4 pb-0 flex">
       <p id="monitorDate" class="ml-auto text-xs text-neutral-500 dark:text-neutral-400"></p>
      </div>

      <div class="px-4 pb-4">
        <div class="h-48">
          <canvas id="monitorChart" class="h-48 w-full"></canvas>
        </div>
      </div>
  </section>

  <!-- Health and Alerts -->
  <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
    <h3 class="text-lg font-semibold mb-4">System Health & Alerts</h3>
    <ul id="healthAlerts" class="divide-y divide-neutral-200 dark:divide-neutral-700 text-sm">
      <li class="py-3 text-neutral-500 dark:text-neutral-400 text-center">Loading health status...</li>
    </ul>
  </section>

  <!-- Execution Summary -->
  <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Execution Logs</h3>
      <button id="downloadLogsBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">Download Logs</button>
    </div>

    <!-- Filters -->
    <div class="flex space-x-3 mb-4">
      <select id="statusFilter" class="border dark:bg-neutral-700 dark:border-neutral-800 rounded px-3 py-2">
        <option value="">All Status</option>
        <option value="completed">Success</option>
        <option value="failed">Error</option>
        <option value="running">Running</option>
      </select>
      <label class="flex items-center space-x-2">
        <input id="autoRefresh" type="checkbox" class="form-checkbox"> <span class="text-sm">Auto Refresh (30s)</span>
      </label>
    </div>

    <!-- Logs Table -->
    <div class="overflow-x-auto bg-white dark:bg-neutral-700 rounded shadow">
      <table class="w-full text-sm">
        <thead class="bg-neutral-200 dark:bg-neutral-800/90">
          <tr>
            <th class="p-3 text-left">Flow</th>
            <th class="p-3 text-left">Environment</th>
            <th class="p-3 text-left">Timestamp</th>
            <th class="p-3 text-left">Status</th>
            <th class="p-3 text-left">Duration</th>
            <th class="p-3 text-left">Details</th>
          </tr>
        </thead>
        <tbody id="logsTableBody" class="dark:bg-neutral-700">
          <tr>
            <td colspan="6" class="p-6 text-center text-neutral-500 dark:text-neutral-400">Loading execution logs...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Recent Activity -->
  <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
    <h3 class="text-lg font-semibold mb-4">Recent Monitoring Events</h3>
    <ul id="recentEvents" class="space-y-4 text-sm">
      <li class="text-neutral-500 dark:text-neutral-400 text-center py-4">Loading recent events...</li>
    </ul>
  </section>

</main>

<!-- Sidebar PFP Script -->
<script>
  const imageStore = 'connectify.pfpUrl';
  function applyPfpToDOM(pfpUrl) {
    document.querySelectorAll('.js-main-pfp').forEach(img => {
      img.src = pfpUrl;
      img.classList.remove("hidden");
    });
    document.querySelectorAll(".js-initial-pfp").forEach(el => el.classList.add("hidden"));
  }
  document.addEventListener('DOMContentLoaded', async () => {
    // Load from backend first
    try {
      const res = await fetch('/api/auth/me', { credentials: 'include' });
      if (res.ok) {
        const data = await res.json();
        if (data.user?.profilePicture) {
          applyPfpToDOM(data.user.profilePicture);
          return;
        }
      }
    } catch (e) {
      console.warn("Could not load profile picture from backend:", e);
    }
    
    // Fallback to localStorage
    const saveImg = localStorage.getItem(imageStore);
    if (saveImg) applyPfpToDOM(saveImg);
  });
</script>

<!-- Monitoring Data Script -->
<script>
  const $ = (id) => document.getElementById(id);
  let allExecutions = [];
  let autoRefreshInterval;

  // Show custom notification
  function showNotification(message, type = 'success') {
    const colors = {
      success: 'bg-green-600',
      error: 'bg-red-600',
      info: 'bg-blue-600'
    };
    
    const icons = {
      success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',
      error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>',
      info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'
    };
    
    const notificationHTML = `
      <div class="fixed top-4 left-1/2 -translate-x-1/2 z-[70] animate-slide-down" id="notification">
        <div class="${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px]">
          <svg class="h-6 w-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            ${icons[type]}
          </svg>
          <span class="flex-1">${message}</span>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', notificationHTML);
    setTimeout(() => document.getElementById('notification')?.remove(), 5000);
  }

  // Helper function to render execution badge
  function badgeForExec(s) {
    const map = {
      running: 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300',
      completed: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300',
      failed: 'bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300',
      cancelled: 'bg-neutral-200 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-200'
    };
    const k = (s||'').toLowerCase();
    const cls = map[k] || map.cancelled;
    const label = k ? k.charAt(0).toUpperCase() + k.slice(1) : 'Unknown';
    return `<span class="px-2 py-1 ${cls} text-xs rounded">${label}</span>`;
  }

  // Load monitoring data
  async function loadMonitoringData() {
    try {
      const res = await fetch('/api/executions/recent?limit=100', { credentials: 'include' });
      if (!res.ok) throw new Error('Failed to fetch executions');
      
      allExecutions = await res.json();
      console.log('âœ… Loaded executions for monitoring:', allExecutions.length);
      
      updateKPIs(allExecutions);
      renderLogsTable(allExecutions);
      renderHealthAlerts(allExecutions);
      renderRecentEvents(allExecutions.slice(0, 10));
    } catch (error) {
      console.error('Failed to load monitoring data:', error);
      showNotification('Failed to load monitoring data', 'error');
    }
  }

  // Update KPIs
  function updateKPIs(execs) {
    const now = Date.now();
    const dayAgo = now - (24 * 60 * 60 * 1000);
    
    // Filter last 24 hours
    const last24h = execs.filter(e => {
      const startedAt = e.startedAt ? new Date(e.startedAt).getTime() : 0;
      return startedAt >= dayAgo;
    });
    
    const total = last24h.length;
    const completed = last24h.filter(e => (e.status || '').toLowerCase() === 'completed').length;
    const running = execs.filter(e => (e.status || '').toLowerCase() === 'running').length;
    
    // Calculate success rate
    const successRate = total > 0 ? ((completed / total) * 100).toFixed(2) + '%' : '100%';
    
    // Calculate average execution time
    const executionsWithTime = last24h.filter(e => e.startedAt && e.completedAt);
    let avgTime = '--';
    if (executionsWithTime.length > 0) {
      const totalMs = executionsWithTime.reduce((sum, e) => {
        const start = new Date(e.startedAt).getTime();
        const end = new Date(e.completedAt).getTime();
        return sum + (end - start);
      }, 0);
      const avgMs = totalMs / executionsWithTime.length;
      avgTime = avgMs < 1000 ? Math.round(avgMs) + 'ms' : (avgMs / 1000).toFixed(2) + 's';
    }
    
    $('kpiUptime').textContent = successRate;
    $('kpiTotal').textContent = total;
    $('kpiRunning').textContent = running;
    $('kpiAvgTime').textContent = avgTime;
  }

  // Render logs table
  function renderLogsTable(execs) {
    const tbody = $('logsTableBody');
    if (!tbody) return;
    
    const statusFilter = $('statusFilter')?.value || '';
    const filtered = statusFilter ? execs.filter(e => (e.status || '').toLowerCase() === statusFilter) : execs;
    
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-neutral-500 dark:text-neutral-400">No execution logs found</td></tr>';
      return;
    }
    
    tbody.innerHTML = filtered.slice(0, 20).map(e => {
      const environment = e.triggerData?.environment || 'sandbox';
      const envDisplay = environment.charAt(0).toUpperCase() + environment.slice(1);
      const envColor = {
        production: 'text-red-600 dark:text-red-400',
        test: 'text-yellow-600 dark:text-yellow-400',
        sandbox: 'text-green-600 dark:text-green-400'
      }[environment] || 'text-neutral-600 dark:text-neutral-400';
      
      const timeStr = e.startedAt ? new Date(e.startedAt).toLocaleString() : 'Unknown';
      
      let duration = '--';
      if (e.startedAt && e.completedAt) {
        const ms = new Date(e.completedAt).getTime() - new Date(e.startedAt).getTime();
        duration = ms < 1000 ? ms + 'ms' : (ms / 1000).toFixed(2) + 's';
      } else if ((e.status || '').toLowerCase() === 'running') {
        duration = 'Running...';
      }
      
      return `
        <tr class="border-t border-neutral-200 dark:border-neutral-600 hover:bg-neutral-50 dark:hover:bg-neutral-600/50">
          <td class="p-3">${e.flowName || 'Unknown Flow'}</td>
          <td class="p-3"><span class="${envColor} font-medium">${envDisplay}</span></td>
          <td class="p-3 text-xs">${timeStr}</td>
          <td class="p-3">${badgeForExec(e.status)}</td>
          <td class="p-3 text-xs">${duration}</td>
          <td class="p-3"><button onclick="viewExecutionDetails('${e.id}')" class="px-2 py-1 bg-blue-600/90 hover:bg-blue-700 text-white rounded text-xs">View</button></td>
        </tr>
      `;
    }).join('');
  }

  // Render health alerts
  function renderHealthAlerts(execs) {
    const alertsList = $('healthAlerts');
    if (!alertsList) return;
    
    const alerts = [];
    
    // Check for failed executions in last hour
    const hourAgo = Date.now() - (60 * 60 * 1000);
    const recentFailed = execs.filter(e => {
      const startedAt = e.startedAt ? new Date(e.startedAt).getTime() : 0;
      const status = (e.status || '').toLowerCase();
      return startedAt >= hourAgo && status === 'failed';
    });
    
    if (recentFailed.length > 0) {
      alerts.push({
        severity: 'error',
        message: `<strong>${recentFailed.length} execution(s)</strong> failed in the last hour.`,
        color: 'text-red-600 dark:text-red-400'
      });
    }
    
    // Check for running executions
    const running = execs.filter(e => (e.status || '').toLowerCase() === 'running');
    if (running.length > 0) {
      alerts.push({
        severity: 'warning',
        message: `<strong>${running.length} execution(s)</strong> currently in progress.`,
        color: 'text-yellow-600 dark:text-yellow-400'
      });
    }
    
    // Check overall health
    const completed = execs.filter(e => (e.status || '').toLowerCase() === 'completed');
    if (completed.length > recentFailed.length) {
      alerts.push({
        severity: 'healthy',
        message: `<strong>System</strong> responding normally with ${completed.length} successful executions.`,
        color: 'text-green-600 dark:text-green-400'
      });
    }
    
    if (alerts.length === 0) {
      alertsList.innerHTML = '<li class="py-3 text-neutral-500 dark:text-neutral-400 text-center">No health alerts</li>';
      return;
    }
    
    alertsList.innerHTML = alerts.map(alert => `
      <li class="py-3 flex items-center justify-between">
        <span>${alert.message}</span>
        <span class="${alert.color} font-medium capitalize">${alert.severity}</span>
      </li>
    `).join('');
  }

  // Render recent events
  function renderRecentEvents(execs) {
    const eventsList = $('recentEvents');
    if (!eventsList) return;
    
    if (execs.length === 0) {
      eventsList.innerHTML = '<li class="text-neutral-500 dark:text-neutral-400 text-center py-4">No recent events</li>';
      return;
    }
    
    eventsList.innerHTML = execs.map(e => {
      const status = (e.status || '').toLowerCase();
      const environment = e.triggerData?.environment || 'sandbox';
      const envDisplay = environment.charAt(0).toUpperCase() + environment.slice(1);
      
      let statusColor, eventText;
      if (status === 'completed') {
        statusColor = 'bg-green-500';
        eventText = `<strong>${e.flowName || 'Flow'}</strong> completed successfully in ${envDisplay}.`;
      } else if (status === 'failed') {
        statusColor = 'bg-red-500';
        eventText = `<strong>${e.flowName || 'Flow'}</strong> failed in ${envDisplay} environment.`;
      } else if (status === 'running') {
        statusColor = 'bg-yellow-400';
        eventText = `<strong>${e.flowName || 'Flow'}</strong> execution started in ${envDisplay}.`;
      } else {
        statusColor = 'bg-neutral-400';
        eventText = `<strong>${e.flowName || 'Flow'}</strong> status: ${status}.`;
      }
      
      const timeStr = e.startedAt ? new Date(e.startedAt).toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      }) : 'Unknown time';
      
      return `
        <li class="flex items-start gap-3">
          <span class="h-3 w-3 mt-1 ${statusColor} rounded-full flex-shrink-0"></span>
          <div class="flex-1">
            <p>${eventText}</p>
            <p class="text-neutral-500 dark:text-neutral-400 text-xs">${timeStr}</p>
          </div>
        </li>
      `;
    }).join('');
  }

  // View execution details (redirect to deployments page)
  function viewExecutionDetails(executionId) {
    window.location.href = `deployments.html?execution=${executionId}`;
  }

  // Download logs as CSV
  function downloadLogs() {
    if (allExecutions.length === 0) {
      showNotification('No logs to download', 'error');
      return;
    }

    // Get filtered executions
    const statusFilter = $('statusFilter')?.value || '';
    const filtered = statusFilter ? allExecutions.filter(e => (e.status || '').toLowerCase() === statusFilter) : allExecutions;

    // Create CSV content
    const headers = ['Flow Name', 'Environment', 'Status', 'Started At', 'Completed At', 'Duration (ms)', 'Execution ID'];
    const rows = filtered.map(e => {
      const environment = e.triggerData?.environment || 'sandbox';
      const startedAt = e.startedAt ? new Date(e.startedAt).toISOString() : '';
      const completedAt = e.completedAt ? new Date(e.completedAt).toISOString() : '';
      
      let duration = '';
      if (e.startedAt && e.completedAt) {
        duration = new Date(e.completedAt).getTime() - new Date(e.startedAt).getTime();
      }
      
      return [
        `"${(e.flowName || 'Unknown').replace(/"/g, '""')}"`,
        environment,
        e.status || 'unknown',
        startedAt,
        completedAt,
        duration,
        e.id
      ].join(',');
    });

    const csv = [headers.join(','), ...rows].join('\n');
    
    // Create download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `execution-logs-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showNotification(`Downloaded ${filtered.length} execution logs`, 'success');
  }

  // Setup filters and auto-refresh
  function setupInteractions() {
    // Status filter
    $('statusFilter')?.addEventListener('change', () => {
      renderLogsTable(allExecutions);
    });
    
    // Download logs button
    $('downloadLogsBtn')?.addEventListener('click', downloadLogs);
    
    // Auto refresh toggle
    $('autoRefresh')?.addEventListener('change', (e) => {
      if (e.target.checked) {
        autoRefreshInterval = setInterval(loadMonitoringData, 30000); // 30 seconds
        showNotification('Auto-refresh enabled (30s)', 'info');
      } else {
        clearInterval(autoRefreshInterval);
        showNotification('Auto-refresh disabled', 'info');
      }
    });
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    loadMonitoringData();
    setupInteractions();
    loadUserName();
  });
  
  // Load and display user name
  async function loadUserName() {
    try {
      const res = await fetch('/api/auth/me', { credentials: 'include' });
      if (!res.ok) return;
      
      const data = await res.json();
      if (data.user) {
        const fullName = `${data.user.firstName || ''} ${data.user.lastName || ''}`.trim();
        const sidebarUsername = document.getElementById('sidebarUsername');
        if (sidebarUsername) {
          sidebarUsername.textContent = fullName || 'User';
        }
      }
    } catch (error) {
      console.error('Failed to load user name:', error);
    }
  }
</script>

    <!-- Chart -->
<script>
  // Load real execution data for chart
  async function loadSeries() {
    try {
      const res = await fetch('/api/executions/recent?limit=500', { credentials: 'include' });
      if (!res.ok) throw new Error('Failed to fetch data');
      
      const executions = await res.json();
      
      // Group executions by hour for the last 24 hours
      const now = new Date();
      const dataMap = new Map();
      
      // Initialize all hours in the last 24 hours with 0
      for (let i = 23; i >= 0; i--) {
        const d = new Date(now);
        d.setHours(now.getHours() - i, 0, 0, 0);
        dataMap.set(d.getTime(), 0);
      }
      
      // Count executions per hour
      executions.forEach(exec => {
        if (!exec.startedAt) return;
        const execDate = new Date(exec.startedAt);
        const hourKey = new Date(execDate);
        hourKey.setMinutes(0, 0, 0);
        
        const key = hourKey.getTime();
        if (dataMap.has(key)) {
          dataMap.set(key, dataMap.get(key) + 1);
        }
      });
      
      // Convert to array format for Chart.js
      return Array.from(dataMap.entries())
        .map(([x, y]) => ({ x, y }))
        .sort((a, b) => a.x - b.x);
    } catch (error) {
      console.error('Failed to load chart data:', error);
      // Return empty array on error
      return [];
    }
  }

  function currentThemeIsDark() {
    return document.documentElement.classList.contains('dark');
  }

  let monitorChart;
  async function initMonitorChart() {
    const canvas = $('monitorChart');
    if (!canvas) return;

    // update timestamp
    const stamp = $('monitorDate');
    if (stamp) {
      const d = new Date();
      stamp.textContent = `Updated: ${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;
    }
    
    const data = await loadSeries();

    // dark mode colors
    const lineColor = currentThemeIsDark() ? '#a8b3cf' : '#1f2937';
    const gridColor = currentThemeIsDark() ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)';
    const tickColor = currentThemeIsDark() ? '#cbd5e1' : '#475569';



    monitorChart = new Chart(canvas, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Executions per Hour',
          data,
          borderWidth: 2,
          tension: 0.35,
          borderColor: lineColor,
          fill: false,
          pointRadius: 0,
          pointHitRadius: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {mode: 'index', intersect: false},
        plugins: {
          legend: {display: false},
          tooltip: {
            displayColors: false,
            callbacks: {
              title(items){
                const d = new Date(items[0].parsed.x);
                return d.toLocaleString(undefined, {month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit'});
              },
              label(item) { return `Executions: ${item.parsed.y}`;}
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {unit: 'hour', displayFormats: {hour: 'HH:mm'}, tooltipFormat: 'HH:mm'},
            grid: {color: gridColor, drawOnChartArea: false},
            ticks: {color: tickColor, maxTicksLimit: 12}
          },
          y: {
            beginAtZero: true,
            ticks: {precision: 0, color: tickColor},
            grid: {color: gridColor}
          }
        }
      }
    });
  }
  document.addEventListener('DOMContentLoaded', initMonitorChart);
</script>

</body>
</html>