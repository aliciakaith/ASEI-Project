<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connectors</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="images/connectify_logo.png">
</head>
<body class="bg-neutral-100 text-neutral-900">


<!-- Sidebar -->
    <aside class="fixed inset-y-0 left-0 w-60 bg-neutral-900 text-neutral-100 flex flex-col">
      <div class="px-4 py-4 flex items-center gap-2 border-b border-neutral-800">
        <img src="images/connectify_logo.png" alt="Logo" class="h-8 w-auto">
        <span>Connectify</span>
      </div>

    <nav class="p-2 text-sm space-y-1 flex-1">
      <a href="asei_dashboard.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-800/70">üè† <span class="hidden sm:inline">Dashboard</span></a>
      <a href="flow_designer.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-800/70">üõ† <span class="hidden sm:inline">Flow Designer</span></a>
      <a href="connectors.html" class="flex items-center gap-2 px-3 py-2 rounded bg-neutral-800">üîå <span class="hidden sm:inline">Connectors</span></a>
      <a href="templates.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-800/70">üìë <span class="hidden sm:inline">Templates</span></a>
      <a href="deployments.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-800/70">üöÄ <span class="hidden sm:inline">Deployments</span></a>
      <a href="monitoring.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-800/70">üìä <span class="hidden sm:inline">Monitoring</span></a>
      <a href="settings.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-800/70">‚öôÔ∏è <span class="hidden sm:inline">Settings</span></a>
    </nav>

    <div class="relative">
      <button id="profileBtn" class="w-full px-4 py-4 flex items-center gap-2 border-t border-neutral-800 text-left hover:bg-neutral-800/60">

          <img id="initialSidebarPfp" src="images/default_avatar.png" class="js-initial-pfp h-8 w-8 rounded-full object-cover" alt="O Pfp"/>
          <img id="mainPfp" class="js-main-pfp h-8 w-8 rounded-full object-cover hidden" alt="N Pfp"/>
          <span class="text-sm font-medium">Insert User Name</span>
      </button>

      <div id="profileMenu" class="absolute hidden bottom-full left-3 left-3 right-3 mt-4 rounded-lg bg-neutral-800 border border-neutral-700 text-neutral-200 shadow-xl z-50">
          <button class="px-3 py-3 text-red-400 w-full hover:bg-neutral-700">Sign Out</button>
      </div>
    </div>
    <script>
      const btn = document.getElementById('profileBtn');
      const menu = document.getElementById('profileMenu');
      btn.addEventListener('click', (e) => {
          e.stopPropagation();
          menu.classList.toggle('hidden');
      });

      document.addEventListener('click', (e) =>{
          if(!menu.contains(e.target) && e.target !== btn){
              menu.classList.add('hidden');
          }
      });
    </script>
  </aside>

  <!-- Main Content -->
  <main class="ml-40 md:ml-64 p-4 sm:p-6">
    <h2 class="text-xl font-semibold mb-4">Connectors</h2>

    <!-- Add Connector -->
    <div class="mb-4 flex flex-col sm:flex-row gap-2">
      <input type="text" placeholder="Search connectors..." class="w-full sm:w-1/3 border rounded px-3 py-2">
      <button  onclick="openMtnModal()" class="px-4 py-2 bg-blue-600 text-white rounded w-full sm:w-auto">+ Add Connector</button>
    </div>

    <!-- Connectors Table -->
    <div class="overflow-x-auto bg-white rounded shadow">
      <table class="w-full text-sm">
        <thead class="bg-neutral-200">
          <tr>
            <th class="p-3 text-left">Connector</th>
            <th class="p-3 text-left">Type</th>
            <th class="p-3 text-left">Status</th>
            <th class="p-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-t">
            <td class="p-3">MTN Mobile Money</td>
            <td class="p-3">API</td>
            <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">Active</span></td>
            <td class="p-3 space-x-2">
              <button class="px-2 py-1 text-xs bg-gray-200 rounded">Edit</button>
              <button class="px-2 py-1 text-xs bg-red-500 text-white rounded">Delete</button>
            </td>
          </tr>
          <tr class="border-t">
            <td class="p-3">Airtel Payments</td>
            <td class="p-3">Database</td>
            <td class="p-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded">Pending</span></td>
            <td class="p-3 space-x-2">
              <button class="px-2 py-1 text-xs bg-gray-200 rounded">Edit</button>
              <button class="px-2 py-1 text-xs bg-red-500 text-white rounded">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

<!-- Update sidebar Pfp -->
<script>
  const imageStore = 'connectify.pfpUrl';
  function applyPfpToDOM(pfpUrl){
    document.querySelectorAll('.js-main-pfp').forEach(img =>{
      img.src = pfpUrl;
      img.classList.remove("hidden");
    });
    document.querySelectorAll(".js-initial-pfp, .js-hover-pfp").forEach(element =>{
      element.classList.add("hidden");
    });
  }
  document.addEventListener('DOMContentLoaded', () =>{
    const saveImg = localStorage.getItem(imageStore);
    if(saveImg) applyPfpToDOM(saveImg);
  })

</script>
  </main>
  <!-- Add Connection (MTN) Modal -->
<div id="mtnConnModal" class="hidden fixed inset-0 z-50 bg-black/40">
  <div class="mx-auto mt-24 max-w-lg bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold mb-4">Add MTN Connection</h2>
    <div class="space-y-3">
      <input id="mtn_label" class="w-full border p-2 rounded" placeholder="Label e.g. MTN Sandbox">
      <input id="mtn_subscriptionKey" class="w-full border p-2 rounded" placeholder="Subscription Key (Primary key)">
      <input id="mtn_apiUserId" class="w-full border p-2 rounded" placeholder="API User ID (UUID)">
      <input id="mtn_apiKey" class="w-full border p-2 rounded" placeholder="API Key (from /apikey)">
      <input id="mtn_baseUrl" class="w-full border p-2 rounded" value="https://sandbox.momodeveloper.mtn.com">
      <input id="mtn_callbackUrl" class="w-full border p-2 rounded" placeholder="Callback URL (optional)">
      <div id="mtn_test_result" class="text-sm"></div>
      <div class="flex gap-2 justify-end pt-2">
        <button onclick="closeMtnModal()" class="px-3 py-2 border rounded">Cancel</button>
        <button onclick="testMtnConnection()" class="px-3 py-2 bg-blue-600 text-white rounded">Test</button>
        <button id="mtn_save_btn" onclick="saveMtnConnection()" disabled class="px-3 py-2 bg-green-600 text-white rounded opacity-50">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- existing scripts, including your profile & PFP ones -->

<script>
  // JS for MTN API integration
  const BACKEND_URL = "http://localhost:3001";

  function openMtnModal(){ document.getElementById('mtnConnModal').classList.remove('hidden'); }
  function closeMtnModal(){ document.getElementById('mtnConnModal').classList.add('hidden'); }

  async function testMtnConnection(){
    const cfg = {
      subscriptionKey: document.getElementById('mtn_subscriptionKey').value.trim(),
      apiUserId:       document.getElementById('mtn_apiUserId').value.trim(),
      apiKey:          document.getElementById('mtn_apiKey').value.trim(),
      baseUrl:         document.getElementById('mtn_baseUrl').value.trim(),
      targetEnvironment: "sandbox",
      callbackUrl:     document.getElementById('mtn_callbackUrl').value.trim() || null
    };
    const label = document.getElementById('mtn_label').value.trim();
    const res = await fetch(`${BACKEND_URL}/api/connections/test`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ provider:'mtn', env:'sandbox', label: label || 'MTN', config: cfg })
    });
    const j = await res.json();
    const el = document.getElementById('mtn_test_result');
    if (j.ok){
      el.textContent = 'Connected ‚úÖ Token: ' + j.tokenPreview;
      const b = document.getElementById('mtn_save_btn');
      b.disabled = false; b.classList.remove('opacity-50');
    } else {
      el.textContent = 'Failed ‚ùå ' + (j.error?.message || JSON.stringify(j.error || j));
    }
  }

  async function saveMtnConnection(){
    const cfg = {
      subscriptionKey: document.getElementById('mtn_subscriptionKey').value.trim(),
      apiUserId:       document.getElementById('mtn_apiUserId').value.trim(),
      apiKey:          document.getElementById('mtn_apiKey').value.trim(),
      baseUrl:         document.getElementById('mtn_baseUrl').value.trim(),
      targetEnvironment: "sandbox",
      callbackUrl:     document.getElementById('mtn_callbackUrl').value.trim() || null
    };
    const label = document.getElementById('mtn_label').value.trim();
    const res = await fetch(`${BACKEND_URL}/api/connections`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ provider:'mtn', env:'sandbox', label, config: cfg })
    });
    const j = await res.json();
    if (j.id){
      closeMtnModal();
      alert('Saved connection: ' + j.label);
    } else {
      alert('Save failed: ' + JSON.stringify(j));
    }
  }
</script>
</body>
</html>
