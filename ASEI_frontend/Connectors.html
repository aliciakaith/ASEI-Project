<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Connectors</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' };</script>

  <script>
    (function () {
      const KEY = 'connectify.theme';
      const saved = localStorage.getItem(KEY);
      if (saved === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
        if (saved !== 'light') localStorage.setItem(KEY, 'light');
      }
    })();
  </script>
  <link rel="icon" type="image/png" href="images/connectify_logo.png">
</head>
<body class="bg-neutral-50 text-neutral-900 dark:bg-neutral-900 dark:text-neutral-100">

<!-- Sidebar (UNCHANGED) -->
<aside class="fixed inset-y-0 left-0 w-60 bg-neutral-100 text-neutral-900 dark:bg-neutral-800/40 dark:text-neutral-100 flex flex-col">
  <div class="px-4 py-4 flex items-center gap-2 border-b border-neutral-400 dark:border-gray-400/70">
    <img src="images/connectify_logo.png" alt="Logo" class="h-8 w-auto">
    <span>Connectify</span>
  </div>

  <nav class="p-2 text-sm space-y-1 flex-1">
    <a href="asei_dashboard.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700">
      <span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]">
        <svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor" d="M13.5 8.183V4.817q0-.357.234-.587t.58-.23h4.88q.347 0 .576.23t.23.587v3.366q0 .358-.234.587q-.234.23-.58.23h-4.88q-.346 0-.576-.23t-.23-.587M4 11.2V4.8q0-.34.234-.57t.58-.23h4.88q.347 0 .576.23t.23.57v6.4q0 .34-.234.57t-.58.23h-4.88q-.346 0-.576-.23T4 11.2m9.5 8v-6.4q0-.34.234-.57t.58-.23h4.88q.347 0 .576.23t.23.57v6.4q0 .34-.234.57t-.58.23h-4.88q-.346 0-.576-.23t-.23-.57M4 19.183v-3.366q0-.357.234-.587t.58-.23h4.88q.347 0 .576.23t.23.587v3.366q0 .358-.234.587q-.234.23-.58.23h-4.88q-.346 0-.576-.23T4 19.183M5 11h4.5V5H5zm9.5 8H19v-6h-4.5zm0-11H19V5h-4.5zM5 19h4.5v-3H5zm4.5-3"/></svg>
      </span>
      <span class="hidden sm:inline">Dashboard</span>
    </a>

    <a href="flow_designer.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700">
      <span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]">
        <svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor" d="M11.5 12.5h-5q-.213 0-.356-.144T6 11.999t.144-.356t.356-.143h5v-5q0-.213.144-.356T12.001 6t.356.144t.143.356v5h5q.213 0 .356.144t.144.357t-.144.356t-.356.143h-5v5q0 .213-.144.356t-.357.144t-.356-.144t-.143-.356z"/></svg>
      </span>
      <span class="hidden sm:inline">Flow Designer</span>
    </a>

    <a href="connectors.html" class="flex items-center gap-2 px-3 py-2 rounded bg-neutral-300 dark:bg-neutral-800">
      <span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]">
        <svg class="h-5 w-5 -translate-x-[1px]" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M4.513 19.487c2.512 2.392 5.503 1.435 6.7.466c.618-.501.897-.825 1.136-1.065c.837-.777.784-1.555.24-2.177c-.219-.249-1.616-1.591-2.956-2.967c-.694-.694-1.172-1.184-1.582-1.58c-.547-.546-1.026-1.172-1.744-1.154c-.658 0-1.136.58-1.735 1.179c-.688.688-1.196 1.555-1.375 2.333c-.539 2.273.299 3.888 1.316 4.965Zm0 0L2 21.999M19.487 4.515c-2.513-2.394-5.494-1.42-6.69-.45c-.62.502-.898.826-1.138 1.066c-.837.778-.784 1.556-.239 2.178c.078.09.31.32.635.644m7.432-3.438c1.017 1.077 1.866 2.71 1.327 4.985c-.18.778-.688 1.645-1.376 2.334c-.598.598-1.077 1.179-1.735 1.179c-.718.018-1.09-.502-1.639-1.048m3.423-7.45L22 2m-5.936 9.964c-.41-.395-.994-.993-1.688-1.687c-.858-.882-1.74-1.75-2.321-2.325m4.009 4.012l-1.562 1.525m-3.99-3.984l1.543-1.553"/></svg>
      </span>
      <span class="hidden sm:inline">Connectors</span>
    </a>

    <a href="templates.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700">
      <span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]">
        <svg class="h-5 w-5 -translate-x-[1px]" viewBox="0 0 24 24"><path fill="currentColor" d="M13 9h1v2h-3V7h2zm5.5 0l-2.12-2.12l1.25-1.25L20 8v2h-2v1h-3V9zM13 3.5V2h-1v2h1v2h-2V4H9V2H8v2H6v1H4V4c0-1.11.89-2 2-2h8l2.36 2.36l-1.25 1.25zM20 20a2 2 0 0 1-2 2h-2v-2h2v-1h2zm-2-5h2v3h-2zm-6 7v-2h3v2zm-4 0v-2h3v2zm-2 0a2 2 0 0 1-2-2v-2h2v2h1v2zm-2-8h2v3H4zm0-4h2v3H4zm14 1h2v3h-2zM4 6h2v3H4z"/></svg>
      </span>
      <span class="hidden sm:inline">Templates</span>
    </a>

    <a href="deployments.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700">
      <span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]">
        <svg class="h-[24px] w-[24px] -translate-x-[-2px] -translate-y-[-3px]" viewBox="0 0 24 24"><path fill="currentColor" d="M4.18 7c-.473 0-.88.294-.972.703l-1.189 5.25a1 1 0 0 0-.019.172c0 .483.444.875.99.875h11.02q.098 0 .194-.017c.537-.095.885-.556.778-1.03l-1.19-5.25C13.7 7.294 13.293 7 12.822 7zM5 6v1h7V6h.825c.946 0 1.76.606 1.946 1.447l1.19 5.4c.215.975-.482 1.923-1.556 2.118a2 2 0 0 1-.39.035H2.985C1.888 15 1 14.194 1 13.2q0-.178.039-.353l1.19-5.4C2.414 6.606 3.229 6 4.174 6z"/><path fill="#90a4ae" d="M5.99 1.399a.5.5 0 0 0-.98.202l2.058 9.945c.327 1.582 2.58 1.6 2.933.023l1.845-8.274L12.6 4.3a.5.5 0 0 0 .8-.6l-1.5-2a.5.5 0 0 0-.7-.1l-2 1.5a.5.5 0 1 0 .6.8l1.065-.799l-1.84 8.25c-.118.526-.869.52-.978-.008z"/></svg>
      </span>
      <span class="hidden sm:inline">Deployments</span>
    </a>

    <a href="monitoring.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700">
      <span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]">
        <svg class="h-[24px] w-[24px] -translate-x-[1px]" viewBox="0 0 24 24"><path fill="currentColor" d="M4 20.5q-.214 0-.357-.144T3.5 20v-.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T7.5 20v-5.288q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.213 0-.356-.144T11.5 20v-3.288q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T15.5 20v-4.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T19.5 20v-8.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144M14 11.437q-.304 0-.598-.12q-.295-.12-.538-.34l-2.422-2.421q-.173-.173-.442-.173t-.442.173L4.354 13.76q-.146.146-.357.153q-.21.006-.356-.16q-.141-.145-.135-.349t.14-.338l5.218-5.218q.243-.24.538-.35q.294-.11.598-.11t.609.11t.527.35l2.422 2.421q.173.173.442.173t.442-.173l5.204-5.203q.146-.147.357-.153q.21-.007.357.158q.14.146.134.35t-.14.339l-5.217 5.217q-.224.22-.528.34t-.609.12"/></svg>
      </span>
      <span class="hidden sm:inline">Monitoring</span>
    </a>

    <a href="settings.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700">
      <span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]">
        <svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor" d="M10.96 21q-.349 0-.605-.229q-.257-.229-.319-.571l-.263-2.092q-.479-.145-1.036-.454q-.556-.31-.947-.664l-1.915.824q-.317.14-.644.03t-.504-.415L3.648 15.57q-.177-.305-.104-.638t.348-.546l1.672-1.25q-.045-.272-.073-.559q-.03-.288-.03-.559q0-.252.03-.53q.028-.278.073-.626l-1.672-1.25q-.275-.213-.338-.555t.113-.648l1.06-1.8q.177-.287.504-.406t.644.021l1.896.804q.448-.373.97-.673q.52-.3 1.013-.464l.283-2.092q.061-.342.318-.571T10.96 3h2.08q.349 0 .605.229q.257.229.319.571l.263 2.112q.575.202 1.016.463t.909.654l1.992-.804q.318-.14.645-.021t.503.406l1.06 1.819q.177.306.104.638t-.348.547L18.36 10.92q.082.31.092.569t.01.51q0 .233-.02.491q-.019.259-.088.626l1.69 1.27q.275.213.358.546t-.094.638l-1.066 1.839q-.176.306-.513.415q-.337.11-.654-.03l-1.923-.824q-.467.393-.94.673t-.985.445l-.264 2.111q-.061.342-.318.571t-.605.23zm.04-1h1.956l.369-2.708q.756-.2 1.36-.549q.606-.349 1.232-.956l2.495 1.063l.994-1.7l-2.189-1.644q.125-.427.166-.786q.04-.358.04-.72q0-.38-.04-.72t-.166-.747l2.227-1.683l-.994-1.7l-2.552 1.07q-.454-.499-1.193-.935q-.74-.435-1.4-.577L13 4h-1.994l-.312 2.689q-.756.161-1.39.52q-.633.358-1.26.985L5.55 7.15l-.994 1.7l2.169 1.62q-.125.336-.175.73t-.05.82q0 .38.05.755t.156.73l-2.15 1.645l.994 1.7l2.475-1.05q.589.594 1.222.953q.634.359 1.428.559zm.973-5.5q1.046 0 1.773-.727T14.473 12t-.727-1.773t-1.773-.727q-1.052 0-1.776.727T9.473 12t.724 1.773t1.776.727M12 12"/></svg>
      </span>
      <span class="hidden sm:inline">Settings</span>
    </a>
  </nav>

  <div class="relative">
    <div id="profileBtn" class="w-full px-4 py-4 flex items-center gap-2 border-t border-neutral-400 dark:border-gray-400/70 text-left">
      <img id="initialSidebarPfp" src="images/default_avatar.png" class="js-initial-pfp h-8 w-8 rounded-full object-cover" alt="O Pfp"/>
      <img id="mainPfp" class="js-main-pfp h-8 w-8 rounded-full object-cover hidden" alt="N Pfp"/>
      <span class="text-sm font-medium">Insert User Name</span>
    </div>
  </div>
</aside>

<!-- Main Content (original structure preserved) -->
<main class="ml-60 p-4 sm:p-6">
  <h2 class="text-xl font-semibold mb-4">Connectors</h2>

  <!-- KPI Summary -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4">
      <div class="text-2xl font-semibold" id="totalConnectors">8</div>
      <div class="text-xs text-neutral-500 dark:text-neutral-400">Total Connectors</div>
    </div>
    <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4">
      <div class="text-2xl font-semibold text-green-600" id="activeConnectors">5</div>
      <div class="text-xs text-neutral-500 dark:text-neutral-400">Active</div>
    </div>
    <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4">
      <div class="text-2xl font-semibold text-yellow-600" id="pendingConnectors">2</div>
      <div class="text-xs text-neutral-500 dark:text-neutral-400">Pending</div>
    </div>
    <div class="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-xl p-4">
      <div class="text-2xl font-semibold text-red-600" id="failedConnectors">1</div>
      <div class="text-xs text-neutral-500 dark:text-neutral-400">Failed</div>
    </div>
  </section>

  <!-- Add Connector -->
  <div class="mb-4 flex flex-col sm:flex-row gap-2">
    <input id="searchBox" type="text" placeholder="Search connectors..." class="w-full sm:w-1/3 border rounded px-3 py-2 dark:bg-neutral-600 dark:border-neutral-700">
    <button onclick="openAddIntegrationModal()" class="px-4 py-2 bg-green-600/90 hover:bg-green-700 text-white rounded w-full sm:w-auto">+ Add Integration</button>
    <button onclick="openMtnModal()" class="px-4 py-2 bg-blue-600/90 hover:bg-blue-700 text-white rounded w-full sm:w-auto">+ Add MTN Connector</button>
    <button onclick="openFlwModal()" class="px-4 py-2 bg-purple-600/90 hover:bg-purple-700 text-white rounded w-full sm:w-auto">+ Add Flutterwave Connector</button>
  </div>

  <!-- Integrations Table (aligned with Dashboard > Integrations) -->
  <div class="overflow-x-auto bg-white rounded shadow">
    <table class="w-full text-sm">
      <thead class="bg-neutral-200 dark:bg-neutral-800/90">
        <tr>
          <th class="p-3 text-left">Integration</th>
          <th class="p-3 text-left">Status</th>
          <th class="p-3 text-left">Last Checked</th>
          <th class="p-3 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="connectorTable">
        <!-- rows injected dynamically -->
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="hidden text-center text-neutral-500 mt-10">
    <p>No connectors found. Click <span class="text-blue-600 font-medium cursor-pointer" onclick="openMtnModal()">+ Add Connector</span> to create one.</p>
  </div>
</main>

<!-- Add Connection (MTN) Modal (UNCHANGED FIELDS) -->
<div id="mtnConnModal" class="hidden fixed inset-0 z-50 bg-black/40 flex items-center justify-center">
  <div class="mx-auto bg-white dark:bg-neutral-800 rounded-lg shadow p-6 w-full max-w-lg">
    <h2 class="text-lg font-semibold mb-4">Add MTN Connection</h2>
    <div class="space-y-3">
      <input id="mtn_label" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="Label e.g. MTN Production, MTN Test, etc.">
      <input id="mtn_subscriptionKey" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="Subscription Key (Primary key)">
      <input id="mtn_apiUserId" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="API User ID (UUID)">
      <input id="mtn_apiKey" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="API Key (from /apikey)">
      <div>
        <label class="block text-sm mb-1 text-neutral-600 dark:text-neutral-400">Target Environment</label>
        <select id="mtn_targetEnvironment" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700">
          <option value="sandbox">Sandbox</option>
          <option value="test">Test</option>
          <option value="production">Production</option>
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1 text-neutral-600 dark:text-neutral-400">Base URL (auto-filled)</label>
        <input id="mtn_baseUrl" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-700" value="https://sandbox.momodeveloper.mtn.com" readonly>
      </div>
      <input id="mtn_callbackUrl" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="Callback URL (optional)">
      <div id="mtn_test_result" class="text-sm pt-1"></div>
      <div class="flex gap-2 justify-end pt-3">
        <button onclick="closeMtnModal()" class="px-3 py-2 border dark:bg-neutral-700 dark:hover:bg-neutral-600/40 dark:border-neutral-600/40 rounded">Cancel</button>
        <button onclick="testMtnConnection()" class="px-3 py-2 bg-blue-600 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded">Test</button>
        <button id="mtn_save_btn" onclick="saveMtnConnection()" disabled class="px-3 py-2 bg-green-600 text-white rounded opacity-50">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Flutterwave Modal (NEW) -->
<div id="flwConnModal" class="hidden fixed inset-0 z-50 bg-black/40 flex items-center justify-center">
  <div class="mx-auto bg-white dark:bg-neutral-800 rounded-lg shadow p-6 w-full max-w-lg">
    <h2 class="text-lg font-semibold mb-4">Add Flutterwave Connection</h2>
    <div class="space-y-3">
      <input id="flw_label" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="Label e.g. Flutterwave Sandbox">
      <input id="flw_publicKey" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="Public Key">
      <input id="flw_secretKey" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="Secret Key">
      <input id="flw_encryptionKey" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="Encryption Key (optional)">
      <input id="flw_baseUrl" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" value="https://api.flutterwave.com/v3">
      <div id="flw_test_result" class="text-sm pt-1"></div>
      <div class="flex gap-2 justify-end pt-3">
        <button onclick="closeFlwModal()" class="px-3 py-2 border dark:bg-neutral-700 dark:hover:bg-neutral-600/40 dark:border-neutral-600/40 rounded">Cancel</button>
        <button onclick="testFlwConnection()" class="px-3 py-2 bg-blue-600 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded">Test</button>
        <button id="flw_save_btn" onclick="saveFlwConnection()" disabled class="px-3 py-2 bg-green-600 text-white rounded opacity-50">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Integration Modal -->
<div id="editIntegrationModal" class="hidden fixed inset-0 z-50 bg-black/40 flex items-center justify-center">
  <div class="mx-auto bg-white dark:bg-neutral-800 rounded-lg shadow p-6 w-full max-w-lg">
    <h2 class="text-lg font-semibold mb-4">Edit Integration</h2>
    <div class="space-y-3">
      <div>
        <label class="block text-sm font-medium mb-1">Integration Name</label>
        <input id="edit_integration_name" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="e.g. Stripe">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">API Key</label>
        <input id="edit_integration_apiKey" type="password" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="Enter API key">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Test URL (optional)</label>
        <input id="edit_integration_testUrl" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="https://api.example.com/test">
      </div>
      <div id="edit_integration_result" class="text-sm pt-1"></div>
      <div class="flex gap-2 justify-end pt-3">
        <button onclick="closeEditIntegrationModal()" class="px-3 py-2 border dark:bg-neutral-700 dark:hover:bg-neutral-600/40 dark:border-neutral-600/40 rounded">Cancel</button>
        <button onclick="saveEditedIntegration()" class="px-3 py-2 bg-blue-600 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded">Save</button>
        <button onclick="saveAndVerifyIntegration()" class="px-3 py-2 bg-green-600 text-white rounded">Save & Verify</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Integration Modal -->
<div id="addIntegrationModal" class="hidden fixed inset-0 z-50 bg-black/40 flex items-center justify-center">
  <div class="mx-auto bg-white dark:bg-neutral-800 rounded-lg shadow p-6 w-full max-w-lg">
    <h2 class="text-lg font-semibold mb-4">Add New Integration</h2>
    <div class="space-y-3">
      <div>
        <label class="block text-sm font-medium mb-1">Integration Name <span class="text-red-500">*</span></label>
        <input id="add_integration_name" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="e.g. Stripe, PayPal, Square">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">API Key <span class="text-red-500">*</span></label>
        <input id="add_integration_apiKey" type="password" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="Enter API key">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Test URL (optional)</label>
        <input id="add_integration_testUrl" class="w-full border p-2 rounded dark:bg-neutral-600 dark:border-neutral-700" placeholder="https://api.example.com/test">
        <p class="text-xs text-neutral-500 mt-1">URL to test connectivity. Auto-verification will run if provided.</p>
      </div>
      <div id="add_integration_result" class="text-sm pt-1"></div>
      <div class="flex gap-2 justify-end pt-3">
        <button onclick="closeAddIntegrationModal()" class="px-3 py-2 border dark:bg-neutral-700 dark:hover:bg-neutral-600/40 dark:border-neutral-600/40 rounded">Cancel</button>
        <button onclick="saveNewIntegration()" class="px-3 py-2 bg-green-600 text-white rounded">Add Integration</button>
      </div>
    </div>
  </div>
</div>
<script>
/* ===============================
   CONFIG
================================= */
const BACKEND_URL = "http://localhost:3001";

const ENDPOINTS = {
  // Dashboard integrations (source of truth for display)
  integrations: () => `${BACKEND_URL}/api/dashboard/integrations`,
  integrationsAdd: () => `${BACKEND_URL}/api/dashboard/integrations`,
  integrationsPatch: (id) => `${BACKEND_URL}/api/dashboard/integrations/${encodeURIComponent(id)}`,
  integrationsDelete: (id) => `${BACKEND_URL}/api/dashboard/integrations/${encodeURIComponent(id)}`,
  integrationsVerify: (id) => `${BACKEND_URL}/api/dashboard/integrations/${encodeURIComponent(id)}/verify`,

  // Connections (MTN) – verify first, then save
  mtnTest:     () => `${BACKEND_URL}/api/connections/test`,    // POST body { provider:'mtn', env, label, config:{} }
  mtnSave:     () => `${BACKEND_URL}/api/connections`,         // POST same body to persist
  mtnBalance:  (connectionId) => `${BACKEND_URL}/api/mtn/balance?connectionId=${encodeURIComponent(connectionId)}`,

  // Flutterwave-specific routes (mounted at /api in your backend)
  flwSave:     `${BACKEND_URL}/api/connectors/flutterwave`,         // POST {label, publicKey, secretKey, encryptionKey}
  flwTest:     `${BACKEND_URL}/api/connectors/flutterwave/test`     // POST {connectorId}
};

/* ===============================
   USER CONTEXT HELPERS
   (Try several places for userId; no HTML changes needed)
================================= */
function getUserId() {
  // Prefer a stable localStorage key if you already set one on login
  const keys = [
    'connectify.userId',
    'connectify.user.id',
    'user.id',
    'uid'
  ];
  for (const k of keys) {
    const v = localStorage.getItem(k);
    if (v) return v;
  }
  // Try cookie
  const m = document.cookie.match(/(?:^|;\s*)uid=([^;]+)/);
  if (m) return decodeURIComponent(m[1]);
  // Last resort (works with your /api/connectors file store for dev)
  return 'demo';
}

function defaultHeaders() {
  const uid = getUserId();
  return { 'Content-Type': 'application/json', 'x-user-id': uid };
}

/* ===============================
   STATE
================================= */
let integrations = []; // [{ id, name, status, lastChecked }]
let justSavedIds = { mtn: null, flutterwave: null };
let pendingMtnPayload = null; // cache after successful test

/* ===============================
   UI: open/close modals
   (support both function names for Flutterwave button)
================================= */
function openMtnModal(){ 
  const modal = document.getElementById('mtnConnModal');
  modal?.classList.remove('hidden');
  
  // Set up environment change handler to update baseUrl
  const envSelect = document.getElementById('mtn_targetEnvironment');
  const baseUrlInput = document.getElementById('mtn_baseUrl');
  
  const updateBaseUrl = () => {
    const env = envSelect.value;
    const urls = {
      sandbox: 'https://sandbox.momodeveloper.mtn.com',
      test: 'https://sandbox.momodeveloper.mtn.com', // MTN uses same sandbox URL for test
      production: 'https://proxy.momoapi.mtn.com' // Production URL
    };
    baseUrlInput.value = urls[env] || urls.sandbox;
  };
  
  // Update URL when environment changes
  envSelect.removeEventListener('change', updateBaseUrl); // Remove old listener
  envSelect.addEventListener('change', updateBaseUrl);
  
  // Set initial URL
  updateBaseUrl();
}
function closeMtnModal(){ document.getElementById('mtnConnModal')?.classList.add('hidden'); }

function openFlwModal(){ document.getElementById('flwConnModal')?.classList.remove('hidden'); }
function closeFlwModal(){ document.getElementById('flwConnModal')?.classList.add('hidden'); }

// In case your button calls a different name:
function openFlutterwaveModal(){ openFlwModal(); }
function closeFlutterwaveModal(){ closeFlwModal(); }

/* ===============================
   LIST + RENDER
================================= */
async function loadIntegrations() {
  try {
    const res = await fetch(ENDPOINTS.integrations(), { credentials: 'include' });
    integrations = await res.json();
  } catch (err) {
    console.warn('Failed to load integrations', err);
    integrations = [];
  }
  renderTable();
  updateKPIs();
}

function badge(status) {
  const map = {
    Active:  'bg-green-100 text-green-700',
    Pending: 'bg-yellow-100 text-yellow-700',
    Failed:  'bg-red-100 text-red-700'
  };
  const cls = map[status] || 'bg-neutral-100 text-neutral-700';
  return `<span class="px-2 py-1 ${cls} text-xs rounded">${status || '—'}</span>`;
}

function renderTable() {
  const tbody = document.getElementById('connectorTable');
  const empty = document.getElementById('emptyState');

  // be robust to the original HTML not having an id on the search box
  const searchEl = document.getElementById('searchBox') || document.querySelector('input[placeholder="Search connectors..."]');
  const q = (searchEl?.value || '').toLowerCase();

  const rows = integrations.filter(i =>
    (i.name || '').toLowerCase().includes(q) ||
    (i.status || '').toLowerCase().includes(q)
  );

  tbody.innerHTML = rows.map(i => `
    <tr class="border-t hover:bg-neutral-50 dark:bg-neutral-600 dark:border-neutral-400">
      <td class="p-3">${i.name}</td>
      <td class="p-3">${badge((i.status || '').charAt(0).toUpperCase() + (i.status || '').slice(1))}</td>
      <td class="p-3 text-neutral-500 text-xs dark:text-neutral-400">${i.lastChecked ? new Date(i.lastChecked).toLocaleString() : '—'}</td>
      <td class="p-3 space-x-2">
        <button class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-500 rounded" onclick="editIntegration('${i.id}')">Edit</button>
        <button class="px-2 py-1 text-xs bg-red-500 text-white rounded" onclick="deleteIntegration('${i.id}')">Delete</button>
      </td>
    </tr>
  `).join('');

  empty?.classList.toggle('hidden', rows.length > 0);
  // table is already wrapped in .overflow-x-auto in your HTML, so it will be responsive
}

function updateKPIs() {
  const total   = integrations.length;
  const active  = integrations.filter(i => (i.status || '').toLowerCase() === 'active').length;
  const pending = integrations.filter(i => (i.status || '').toLowerCase() === 'pending').length;
  const failed  = integrations.filter(i => (i.status || '').toLowerCase() === 'error' || (i.status || '').toLowerCase() === 'failed').length;

  document.getElementById('totalConnectors').textContent  = total;
  document.getElementById('activeConnectors').textContent = active;
  document.getElementById('pendingConnectors').textContent= pending;
  document.getElementById('failedConnectors').textContent = failed;
}

/* Actions: Edit + Delete integrations (uses dashboard endpoints) */
let editingIntegrationId = null;

function openEditIntegrationModal() {
  document.getElementById('editIntegrationModal')?.classList.remove('hidden');
}

function closeEditIntegrationModal() {
  document.getElementById('editIntegrationModal')?.classList.add('hidden');
  document.getElementById('edit_integration_result').textContent = '';
  editingIntegrationId = null;
}

function openAddIntegrationModal() {
  document.getElementById('addIntegrationModal')?.classList.remove('hidden');
  // Clear form
  document.getElementById('add_integration_name').value = '';
  document.getElementById('add_integration_apiKey').value = '';
  document.getElementById('add_integration_testUrl').value = '';
  document.getElementById('add_integration_result').textContent = '';
}

function closeAddIntegrationModal() {
  document.getElementById('addIntegrationModal')?.classList.add('hidden');
}

async function saveNewIntegration() {
  const resultEl = document.getElementById('add_integration_result');
  resultEl.textContent = 'Creating integration...';
  resultEl.className = 'text-sm text-blue-600 pt-1';

  const name = document.getElementById('add_integration_name').value.trim();
  const apiKey = document.getElementById('add_integration_apiKey').value.trim();
  const testUrl = document.getElementById('add_integration_testUrl').value.trim();

  if (!name) {
    resultEl.textContent = '⚠️ Integration name is required.';
    resultEl.className = 'text-sm text-red-600 pt-1';
    return;
  }

  if (!apiKey) {
    resultEl.textContent = '⚠️ API Key is required.';
    resultEl.className = 'text-sm text-red-600 pt-1';
    return;
  }

  try {
    const res = await fetch(ENDPOINTS.integrationsAdd(), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ name, apiKey, testUrl: testUrl || null })
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || 'Failed to create integration');
    }

    resultEl.textContent = '✅ Integration created! Verification will run shortly.';
    resultEl.className = 'text-sm text-green-600 pt-1';
    
    await loadIntegrations();
    setTimeout(() => closeAddIntegrationModal(), 1500);
  } catch (err) {
    resultEl.textContent = '❌ Failed: ' + (err.message || 'Unknown error');
    resultEl.className = 'text-sm text-red-600 pt-1';
  }
}

async function deleteIntegration(id) {
  if (!confirm('Delete this integration?')) return;
  try {
    const res = await fetch(ENDPOINTS.integrationsDelete(id), {
      method: 'DELETE',
      credentials: 'include'
    });
    if (!res.ok && res.status !== 204) throw new Error('Delete failed');
    await loadIntegrations();
  } catch (err) {
    alert('Failed to delete integration: ' + (err.message || 'Unknown error'));
  }
}

async function editIntegration(id) {
  const item = integrations.find(x => String(x.id) === String(id));
  if (!item) return alert('Integration not found');

  editingIntegrationId = id;
  document.getElementById('edit_integration_name').value = item.name || '';
  document.getElementById('edit_integration_apiKey').value = '';
  document.getElementById('edit_integration_testUrl').value = item.testUrl || '';
  openEditIntegrationModal();
}

async function saveEditedIntegration() {
  const resultEl = document.getElementById('edit_integration_result');
  resultEl.textContent = 'Saving...';
  resultEl.className = 'text-sm text-blue-600 pt-1';

  const name = document.getElementById('edit_integration_name').value.trim();
  const testUrl = document.getElementById('edit_integration_testUrl').value.trim();

  if (!name) {
    resultEl.textContent = '⚠️ Name is required.';
    resultEl.className = 'text-sm text-red-600 pt-1';
    return;
  }

  try {
    const res = await fetch(ENDPOINTS.integrationsPatch(editingIntegrationId), {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ name, testUrl })
    });
    if (!res.ok) throw new Error('Update failed');

    resultEl.textContent = '✅ Saved successfully!';
    resultEl.className = 'text-sm text-green-600 pt-1';
    
    await loadIntegrations();
    setTimeout(() => closeEditIntegrationModal(), 1000);
  } catch (err) {
    resultEl.textContent = '❌ Failed: ' + (err.message || 'Unknown error');
    resultEl.className = 'text-sm text-red-600 pt-1';
  }
}

async function saveAndVerifyIntegration() {
  const resultEl = document.getElementById('edit_integration_result');
  resultEl.textContent = 'Saving and verifying...';
  resultEl.className = 'text-sm text-blue-600 pt-1';

  const name = document.getElementById('edit_integration_name').value.trim();
  const apiKey = document.getElementById('edit_integration_apiKey').value.trim();
  const testUrl = document.getElementById('edit_integration_testUrl').value.trim();

  if (!name) {
    resultEl.textContent = '⚠️ Name is required.';
    resultEl.className = 'text-sm text-red-600 pt-1';
    return;
  }

  if (!apiKey) {
    resultEl.textContent = '⚠️ API Key is required for verification.';
    resultEl.className = 'text-sm text-red-600 pt-1';
    return;
  }

  try {
    // 1) Update name and test URL
    const pRes = await fetch(ENDPOINTS.integrationsPatch(editingIntegrationId), {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ name, testUrl })
    });
    if (!pRes.ok) throw new Error('Update failed');

    // 2) Trigger verification
    const vRes = await fetch(ENDPOINTS.integrationsVerify(editingIntegrationId), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ apiKey })
    });
    if (!vRes.ok && vRes.status !== 202) throw new Error('Verification request failed');

    resultEl.textContent = '✅ Saved and verification started!';
    resultEl.className = 'text-sm text-green-600 pt-1';
    
    await loadIntegrations();
    setTimeout(() => closeEditIntegrationModal(), 1500);
  } catch (err) {
    resultEl.textContent = '❌ Failed: ' + (err.message || 'Unknown error');
    resultEl.className = 'text-sm text-red-600 pt-1';
  }
}

/* ===============================
   MTN: Test + Save
   (real test by calling /api/mtn/collections/balance after save)
================================= */
async function testMtnConnection() {
  const el = document.getElementById('mtn_test_result');
  const btn = document.getElementById('mtn_save_btn');
  el.textContent = 'Testing MTN connection...';
  el.className = 'text-sm text-blue-600';

  // Gather fields
  const payload = {
    provider: 'mtn',
    env: 'sandbox',
    label: (document.getElementById('mtn_label').value || '').trim(),
    config: {
      subscriptionKey: (document.getElementById('mtn_subscriptionKey').value || '').trim(),
      apiUserId:       (document.getElementById('mtn_apiUserId').value || '').trim(),
      apiKey:          (document.getElementById('mtn_apiKey').value || '').trim(),
      baseUrl:         (document.getElementById('mtn_baseUrl').value || '').trim(),
      callbackUrl:     (document.getElementById('mtn_callbackUrl').value || '').trim()
    }
  };

  // Basic required fields
  if (!payload.config.subscriptionKey || !payload.config.apiUserId || !payload.config.apiKey || !payload.config.baseUrl) {
    el.textContent = '⚠️ Please fill in Subscription Key, API User ID, API Key, Base URL.';
    el.className = 'text-sm text-red-600';
    return;
  }

  try {
    // 1) Verify credentials without persisting
    const tRes = await fetch(ENDPOINTS.mtnTest(), {
      method: 'POST',
      headers: defaultHeaders(),
      credentials: 'include',
      body: JSON.stringify(payload)
    });
    if (!tRes.ok) throw new Error(`Verification failed (${tRes.status})`);
    const tData = await tRes.json();
    // cache for Save
    pendingMtnPayload = payload;

    el.textContent = `✅ Verified (token ok, exp ${tData.expiresIn || '—'}s). Click Save to persist.`;
    el.className = 'text-sm text-green-600 font-medium';
    btn.disabled = false; btn.classList.remove('opacity-50');
  } catch (err) {
    console.error('MTN Test Error:', err);
    el.textContent = '❌ MTN connection failed: ' + (err.message || 'Unknown error');
    el.className = 'text-sm text-red-600';
    btn.disabled = true; if (!btn.classList.contains('opacity-50')) btn.classList.add('opacity-50');
  }
}

async function saveMtnConnection() {
  const el = document.getElementById('mtn_test_result');
  el.textContent = 'Saving MTN connection...';
  el.className = 'text-sm text-blue-600';

  try {
    const toSave = pendingMtnPayload || {
      provider: 'mtn',
      env: 'sandbox',
      label: (document.getElementById('mtn_label').value || '').trim(),
      config: {
        subscriptionKey: (document.getElementById('mtn_subscriptionKey').value || '').trim(),
        apiUserId:       (document.getElementById('mtn_apiUserId').value || '').trim(),
        apiKey:          (document.getElementById('mtn_apiKey').value || '').trim(),
        targetEnvironment: (document.getElementById('mtn_targetEnvironment').value || 'sandbox').trim(),
        baseUrl:         (document.getElementById('mtn_baseUrl').value || '').trim(),
        callbackUrl:     (document.getElementById('mtn_callbackUrl').value || '').trim()
      }
    };

    const sRes = await fetch(ENDPOINTS.mtnSave(), {
      method: 'POST',
      headers: defaultHeaders(),
      credentials: 'include',
      body: JSON.stringify(toSave)
    });
    if (!sRes.ok) throw new Error(`Save failed (${sRes.status})`);
    const saved = await sRes.json();

    // Optional: quick balance check
    try {
      const bRes = await fetch(ENDPOINTS.mtnBalance(saved.id), { credentials: 'include' });
      if (!bRes.ok) throw new Error('Balance failed');
    } catch (_) {}

    pendingMtnPayload = null;
    closeMtnModal();
    alert('✅ MTN connection saved successfully!');
    await loadIntegrations();
  } catch (err) {
    el.textContent = '❌ Save failed: ' + (err.message || 'Unknown error');
    el.className = 'text-sm text-red-600';
  }
}

/* ===============================
   FLUTTERWAVE: Test + Save
   (uses your /api/connectors/flutterwave + /api/connectors/flutterwave/test)
================================= */
async function testFlwConnection() {
  const el  = document.getElementById('flw_test_result');
  const btn = document.getElementById('flw_save_btn');
  el.textContent = 'Testing Flutterwave connection...';
  el.className = 'text-sm text-blue-600';

  const label          = (document.getElementById('flw_label').value || '').trim();
  const publicKey      = (document.getElementById('flw_publicKey').value || '').trim();
  const secretKey      = (document.getElementById('flw_secretKey').value || '').trim();
  const encryptionKey  = (document.getElementById('flw_encryptionKey').value || '').trim();
  const baseUrl        = (document.getElementById('flw_baseUrl')?.value || '').trim(); // optional

  if (!publicKey || !secretKey || !encryptionKey) {
    el.textContent = '⚠️ Please fill in Public Key, Secret Key, and Encryption Key.';
    el.className = 'text-sm text-red-600';
    return;
  }

  try {
    // 1) Save securely via your flutterwave route (it returns the created connector)
    const resSave = await fetch(ENDPOINTS.flwSave, {
      method: 'POST',
      headers: defaultHeaders(),
      credentials: 'include',
      body: JSON.stringify({ label, publicKey, secretKey, encryptionKey, baseUrl })
    });
    if (!resSave.ok) throw new Error('Save failed');
    const saved = await resSave.json();
    justSavedIds.flutterwave = saved.id;

    // 2) Test that saved connector by id
    const resTest = await fetch(ENDPOINTS.flwTest, {
      method: 'POST',
      headers: defaultHeaders(),
      credentials: 'include',
      body: JSON.stringify({ connectorId: saved.id })
    });
    const testData = await resTest.json();
    if (!resTest.ok || testData.ok === false) {
      throw new Error(testData.error || 'API key verification failed');
    }

    el.textContent = '✅ Flutterwave connected successfully!';
    el.className = 'text-sm text-green-600 font-medium';
    btn.disabled = false; btn.classList.remove('opacity-50');

  await loadIntegrations();
  } catch (err) {
    console.error('Flutterwave Test Error:', err);
    el.textContent = '❌ Flutterwave connection failed: ' + (err.message || 'Unknown error');
    el.className = 'text-sm text-red-600';
    btn.disabled = true; if (!btn.classList.contains('opacity-50')) btn.classList.add('opacity-50');
  }
}

async function saveFlwConnection() {
  if (justSavedIds.flutterwave) {
    closeFlwModal();
    alert('✅ Flutterwave connection saved successfully!');
    justSavedIds.flutterwave = null;
    return;
  }
  // If user clicks Save without testing first, do a simple save
  const el = document.getElementById('flw_test_result');
  el.textContent = 'Saving Flutterwave connection...';
  el.className = 'text-sm text-blue-600';

  try {
    const label          = (document.getElementById('flw_label').value || '').trim();
    const publicKey      = (document.getElementById('flw_publicKey').value || '').trim();
    const secretKey      = (document.getElementById('flw_secretKey').value || '').trim();
    const encryptionKey  = (document.getElementById('flw_encryptionKey').value || '').trim();
    const baseUrl        = (document.getElementById('flw_baseUrl')?.value || '').trim();

    const res = await fetch(ENDPOINTS.flwSave, {
      method: 'POST',
      headers: defaultHeaders(),
      credentials: 'include',
      body: JSON.stringify({ label, publicKey, secretKey, encryptionKey, baseUrl })
    });
    if (!res.ok) throw new Error('Save failed');

    closeFlwModal();
    alert('✅ Flutterwave connection saved successfully!');
  await loadIntegrations();
  } catch (err) {
    el.textContent = '❌ Save failed: ' + (err.message || 'Unknown error');
    el.className = 'text-sm text-red-600';
  }
}

/* ===============================
   BOOT
================================= */
document.addEventListener('DOMContentLoaded', async () => {
  // live search (works even if your input has no id)
  const searchEl = document.getElementById('searchBox') || document.querySelector('input[placeholder="Search connectors..."]');
  if (searchEl) searchEl.addEventListener('input', renderTable);

  loadIntegrations();

  // Load user profile to display name
  try {
    const res = await fetch(`${BACKEND_URL}/api/dashboard/me`, { credentials: 'include' });
    if (res.ok) {
      const me = await res.json();
      const fullName = [me?.firstName, me?.lastName].filter(Boolean).join(' ').trim();
      const emailLocal = (me?.email || '').split('@')[0];
      const displayName = fullName || emailLocal || 'User';
      
      // Update profile name in sidebar
      const profileNameEl = document.querySelector('.text-sm.font-medium');
      if (profileNameEl && profileNameEl.textContent === 'Insert User Name') {
        profileNameEl.textContent = displayName;
      }
    }
  } catch (e) {
    console.warn('Failed to load user profile', e);
  }

  // keep your profile image behavior intact
  const imageStore = 'connectify.pfpUrl';
  
  // Load from backend first
  fetch('/api/auth/me', { credentials: 'include' })
    .then(res => res.ok ? res.json() : null)
    .then(data => {
      if (data?.user?.profilePicture) {
        document.querySelectorAll('.js-main-pfp').forEach(img => { img.src = data.user.profilePicture; img.classList.remove('hidden'); });
        document.querySelectorAll('.js-initial-pfp').forEach(el => el.classList.add('hidden'));
      } else {
        // Fallback to localStorage
        const savedImg = localStorage.getItem(imageStore);
        if (savedImg) {
          document.querySelectorAll('.js-main-pfp').forEach(img => { img.src = savedImg; img.classList.remove('hidden'); });
          document.querySelectorAll('.js-initial-pfp').forEach(el => el.classList.add('hidden'));
        }
      }
    })
    .catch(e => {
      console.warn("Could not load profile picture from backend:", e);
      // Fallback to localStorage
      const savedImg = localStorage.getItem(imageStore);
      if (savedImg) {
        document.querySelectorAll('.js-main-pfp').forEach(img => { img.src = savedImg; img.classList.remove('hidden'); });
        document.querySelectorAll('.js-initial-pfp').forEach(el => el.classList.add('hidden'));
      }
    });
});
</script>

</body>
</html>