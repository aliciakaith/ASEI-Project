<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Settings</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { darkMode: 'class' };
</script>

<script>
  (function () {
    const KEY = 'connectify.theme';
    const saved = localStorage.getItem(KEY);
    if (saved === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
      if (saved !== 'light') localStorage.setItem(KEY, 'light');
    }
  })();
</script>

<link rel="icon" type="image/png" href="images/connectify_logo.png">

<!-- Custom Animations -->
<style>
  @keyframes slideDown {
    from { opacity: 0; transform: translate(-50%, -20px); }
    to { opacity: 1; transform: translate(-50%, 0); }
  }
  .animate-slide-down {
    animation: slideDown 0.3s ease-out;
  }
</style>
</head>
<body class="min-h-screen bg-neutral-50 text-neutral-900 dark:bg-neutral-900 dark:text-neutral-100 transition-colors">



  <!-- Sidebar -->
    <aside class="fixed inset-y-0 left-0 w-60
              bg-neutral-100 text-neutral-900
              dark:bg-neutral-800/40 dark:text-neutral-100
              flex flex-col transition-colors">

      <div class="px-4 py-4 flex items-center gap-2 border-b border-neutral-400 dark:border-gray-400/70">
        <img src="images/connectify_logo.png" alt="Logo" class="h-8 w-auto">
        <span>Connectify</span>
      </div>

      <nav class="p-2 text-sm space-y-1 flex-1">
        <a href="asei_dashboard.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor" d="M13.5 8.183V4.817q0-.357.234-.587t.58-.23h4.88q.347 0 .576.23t.23.587v3.366q0 .358-.234.587q-.234.23-.58.23h-4.88q-.346 0-.576-.23t-.23-.587M4 11.2V4.8q0-.34.234-.57t.58-.23h4.88q.347 
          0 .576.23t.23.57v6.4q0 .34-.234.57t-.58.23h-4.88q-.346 0-.576-.23T4 11.2m9.5 8v-6.4q0-.34.234-.57t.58-.23h4.88q.347 0 .576.23t.23.57v6.4q0 .34-.234.57t-.58.23h-4.88q-.346 0-.576-.23t-.23-.57M4 19.183v-3.366q0-.357.234-.587t.58-.23h4.88q.347 0 .576.23t.23.587v3.366q0 .358-.234.587q-.234.23-.58.23h-4.88q-.346 0-.576-.23T4 19.183M5 11h4.5V5H5zm9.5 8H19v-6h-4.5zm0-11H19V5h-4.5zM5 19h4.5v-3H5zm4.5-3"/>
            </svg></span><span class="hidden sm:inline">Dashboard</span></a>
        
        <a href="flow_designer.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor" d="M11.5 12.5h-5q-.213 0-.356-.144T6 11.999t.144-.356t.356-.143h5v-5q0-.213.144-.356T12.001 6t.356.144t.143.356v5h5q.213 0 .356.144t.144.357t-.144.356t-.356.143h-5v5q0 .213-.144.356t-.357.144t-.356-.144t-.143-.356z"/>
          </svg></span><span class="hidden sm:inline">Flow Designer</span></a>
        
        <a href="connectors.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-5 w-5 -translate-x-[1px]" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M4.513 19.487c2.512 2.392 5.503 1.435 6.7.466c.618-.501.897-.825 
          1.136-1.065c.837-.777.784-1.555.24-2.177c-.219-.249-1.616-1.591-2.956-2.967c-.694-.694-1.172-1.184-1.582-1.58c-.547-.546-1.026-1.172-1.744-1.154c-.658 0-1.136.58-1.735 1.179c-.688.688-1.196 1.555-1.375 2.333c-.539 2.273.299 3.888 1.316 4.965Zm0 0L2 21.999M19.487 4.515c-2.513-2.394-5.494-1.42-6.69-.45c-.62.502-.898.826-1.138 1.066c-.837.778-.784 1.556-.239 2.178c.078.09.31.32.635.644m7.432-3.438c1.017 1.077 1.866 
            2.71 1.327 4.985c-.18.778-.688 1.645-1.376 2.334c-.598.598-1.077 1.179-1.735 1.179c-.718.018-1.09-.502-1.639-1.048m3.423-7.45L22 2m-5.936 9.964c-.41-.395-.994-.993-1.688-1.687c-.858-.882-1.74-1.75-2.321-2.325m4.009 4.012l-1.562 1.525m-3.99-3.984l1.543-1.553"/>
              </svg></span><span class="hidden sm:inline">Connectors</span></a>
        
        <a href="templates.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-5 w-5 -translate-x-[1px]" viewBox="0 0 24 24"><path fill="currentColor" d="M13 9h1v2h-3V7h2zm5.5 0l-2.12-2.12l1.25-1.25L20 8v2h-2v1h-3V9zM13 3.5V2h-1v2h1v2h-2V4H9V2H8v2H6v1H4V4c0-1.11.89-2 2-2h8l2.36 2.36l-1.25 1.25zM20 20a2 2 0 0 1-2 
          2h-2v-2h2v-1h2zm-2-5h2v3h-2zm-6 7v-2h3v2zm-4 0v-2h3v2zm-2 0a2 2 0 0 1-2-2v-2h2v2h1v2zm-2-8h2v3H4zm0-4h2v3H4zm14 1h2v3h-2zM4 6h2v3H4z"/>
            </svg></span><span class="hidden sm:inline">Templates</span></a>
        
        <a href="deployments.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px] -translate-x-[-2px] -translate-y-[-3px]" viewBox="0 0 24 24"><path fill="currentColor" d="M4.18 7c-.473 0-.88.294-.972.703l-1.189 5.25a1 1 0 0 0-.019.172c0 .483.444.875.99.875h11.02q.098 0 .194-.017c.537-.095.885-.556.778-1.03l-1.19-5.25C13.7 7.294 13.293 7 12.822 7zM5 6v1h7V6h.825c.946 
          0 1.76.606 1.946 1.447l1.19 5.4c.215.975-.482 1.923-1.556 2.118a2 2 0 0 1-.39.035H2.985C1.888 15 1 14.194 1 13.2q0-.178.039-.353l1.19-5.4C2.414 6.606 3.229 6 4.174 6z"/><path fill="currentColor" d="M5.99 1.399a.5.5 0 0 0-.98.202l2.058 9.945c.327 1.582 2.58 1.6 2.933.023l1.845-8.274L12.6 4.3a.5.5 0 0 0 .8-.6l-1.5-2a.5.5 0 0 0-.7-.1l-2 1.5a.5.5 0 1 0 .6.8l1.065-.799l-1.84 8.25c-.118.526-.869.52-.978-.008z"/>
            </svg></span><span class="hidden sm:inline">Deployments</span></a>
        
        <a href="monitoring.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px] -translate-x-[1px]" viewBox="0 0 24 24"><path fill="currentColor" d="M4 20.5q-.214 0-.357-.144T3.5 20v-.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T7.5 
          20v-5.288q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.213 0-.356-.144T11.5 20v-3.288q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T15.5 20v-4.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T19.5 20v-8.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 
            .213-.144.356t-.357.144M14 11.437q-.304 0-.598-.12q-.295-.12-.538-.34l-2.422-2.421q-.173-.173-.442-.173t-.442.173L4.354 13.76q-.146.146-.357.153q-.21.006-.356-.16q-.141-.145-.135-.349t.14-.338l5.218-5.218q.243-.24.538-.35q.294-.11.598-.11t.609.11t.527.35l2.422 2.421q.173.173.442.173t.442-.173l5.204-5.203q.146-.147.357-.153q.21-.007.357.158q.14.146.134.35t-.14.339l-5.217 5.217q-.224.22-.528.34t-.609.12"/>
              </svg></span><span class="hidden sm:inline">Monitoring</span></a>
        
        <a href="settings.html"
   class="flex items-center gap-2 px-3 py-2 rounded
          bg-neutral-300 dark:bg-neutral-800"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24">
          <path fill="currentColor" d="M10.96 21q-.349 0-.605-.229q-.257-.229-.319-.571l-.263-2.092q-.479-.145-1.036-.454q-.556-.31-.947-.664l-1.915.824q-.317.14-.644.03t-.504-.415L3.648 15.57q-.177-.305-.104-.638t.348-.546l1.672-1.25q-.045-.272-.073-.559q-.03-.288-.03-.559q0-.252.03-.53q.028-.278.073-.626l-1.672-1.25q-.275-.213-.338-.555t.113-.648l1.06-1.8q.177-.287.504-.406t.644.021l1.896.804q.448-.373.97-.673q.52-.3 
          1.013-.464l.283-2.092q.061-.342.318-.571T10.96 3h2.08q.349 0 .605.229q.257.229.319.571l.263 2.112q.575.202 1.016.463t.909.654l1.992-.804q.318-.14.645-.021t.503.406l1.06 1.819q.177.306.104.638t-.348.547L18.36 10.92q.082.31.092.569t.01.51q0 
          .233-.02.491q-.019.259-.088.626l1.69 1.27q.275.213.358.546t-.094.638l-1.066 1.839q-.176.306-.513.415q-.337.11-.654-.03l-1.923-.824q-.467.393-.94.673t-.985.445l-.264 2.111q-.061.342-.318.571t-.605.23zm.04-1h1.956l.369-2.708q.756-.2 
          1.36-.549q.606-.349 1.232-.956l2.495 1.063l.994-1.7l-2.189-1.644q.125-.427.166-.786q.04-.358.04-.72q0-.38-.04-.72t-.166-.747l2.227-1.683l-.994-1.7l-2.552 1.07q-.454-.499-1.193-.935q-.74-.435-1.4-.577L13 
          4h-1.994l-.312 2.689q-.756.161-1.39.52q-.633.358-1.26.985L5.55 7.15l-.994 1.7l2.169 1.62q-.125.336-.175.73t-.05.82q0 .38.05.755t.156.73l-2.15 1.645l.994 1.7l2.475-1.05q.589.594 1.222.953q.634.359 1.428.559zm.973-5.5q1.046 0 1.773-.727T14.473 12t-.727-1.773t-1.773-.727q-1.052 0-1.776.727T9.473 12t.724 1.773t1.776.727M12 12"/>
            </svg></span><span class="hidden sm:inline">Settings</span></a>
      </nav>

    <div class="relative">
      <div id="profileBtn" class="w-full px-4 py-4 flex items-center gap-2 border-t border-neutral-400 dark:border-gray-400/70 text-left">

          <img id="initialSidebarPfp" src="images/default_avatar.png" class="js-initial-pfp h-8 w-8 rounded-full object-cover" alt="O Pfp"/>
          <img id="mainPfp" class="js-main-pfp h-8 w-8 rounded-full object-cover hidden" alt="N Pfp"/>
          <span id="sidebarUsername" class="text-sm font-medium">Loading...</span>
      </div>

    </div>
  </aside>


<main class="p-6 ml-60">
<h2 class="text-xl font-semibold mb-4">Settings</h2>

  <div class="bg-white dark:bg-neutral-800 dark:text-neutral-50
            p-6 rounded shadow space-y-6 max-w-2xl mx-auto transition-colors">



    <!-- General -->
    <div>
      <div class="w-full px-4 py-4 flex items-center gap-2 border-neutral-800 text-left">
          <button id="pfpTrigger" class="group relative h-12 w-12 rounded-full border border-neutral-400 dark:border-gray-400 overflow-hidden cursor-pointer group dark:hover:bg-white" aria-label="Changing pfp">
          <img id="initialMainPfp" src="images/default_avatar.png" alt="avatar" class="js-initial-pfp absolute inset-0 h-full w-full bg-gray-300 transition-opacity duration-300 group-hover:opacity-0 group-hover:scale-110"/>
          <img id="hoverPfp" src="images/hover.png" alt="avatar" class="js-hover-pfp absolute inset-2 h-8 w-8 opacity-0 transition-opacity duration-300 group-hover:opacity-100"/>
          
          <img id="mainPfp" class="js-main-pfp absolute inset-0 h-12 w-12 rounded-full object-cover hidden" alt="Pfp"/>
          </button>
          <span class="font-bold mb-0" id="profileUsername">Loading...</span>
          <input type="file" id="updatePfp" accept="image/*" class="hidden">
          
      </div>
      

<div class="border-t border-gray-400 dark:border-gray-400 pt-2">
      <div class="flex items-center w-full mb-2">
        <h3 class="font-semibold mb-2">Update Profile</h3>
        <button id="editBtn" class="ml-auto px-4 py-1 bg-blue-500 hover:bg-blue-600 rounded-full">
          <label class="text-sm font-small text-white">Edit</label>
        </button>
        <button id="cancelBtn" class="hidden ml-2 px-4 py-1 bg-gray-400 hover:bg-gray-500 rounded-full">
          <label class="text-sm font-small text-white">Cancel</label>
        </button>
      </div>
      <div>
        <div>
          <label class="block text-sm font-medium">Given Names</label>
          <p id="viewFName" class="rounded px-3 py-1 w-full mb-2"></p>
          <input id="editFName" type="text" class="hidden border rounded px-3 py-2 w-full lg:w-1/2 mb-4">
        </div>

        <div>
          <label class="block text-sm font-medium"> Surname</label>
          <p id="viewLName" class="rounded px-3 py-1 w-full mb-2"></p>
          <input id="editLName" type="text" class="hidden border rounded px-3 py-2 w-full lg:w-1/2 mb-4">
        </div>

        <div>
          <label class="block text-sm font-medium">Email</label>
          <p id="viewEmail" class="rounded px-3 py-1 w-full mb-2"></p>
          <input id="editEmail" type="text" class="hidden border rounded px-3 py-2 w-full lg:w-1/2 mb-4">
        </div>

        <div class="hidden">
          <label class="block text-sm font-medium">Change Password</label>
          <input id="changePassword" type="text" class="border rounded px-3 py-2 w-full lg:w-1/2 mb-4">
        </div>

        <div class="hidden">
          <label class="block text-sm font-medium text-red-400">*Enter old password to confirm</label>
          <input type="password" id="confirmPassword" name="confirmPassword" class="border rounded px-3 py-2 w-full lg:w-1/2 mb-4">
        </div>
      </div>

<div class="border-t border-gray-400 dark:border-gray-400 py-1">

        <div class="flex flex-col mb-2">
          <label for="Theme" class="font-semibold mb-2">Theme</label>
          <div class="flex items-center gap-3">
            <input type="checkbox" id="darkmode-toggle" class="peer sr-only"/>
            <label for="darkmode-toggle" class="relative inline-block h-8 w-14 rounded-full bg-neutral-300 transition-colors peer-checked:bg-neutral-600 cursor-pointer
            after:absolute after:top-1 after:left-[3px] after:h-6 after:w-6 after:rounded-full after:bg-white after:transition-transform peer-checked:after:translate-x-[25.5px]"></label>
          </div>

        </div>
<div class="border-t border-gray-400 dark:border-gray-400 pt-1">

        <div class="mb-2">
          <h3 class="font-semibold mb-2">Security</h3>
          <label class="flex items-center space-x-2 mb-3">
            <input id="allowIpWhitelistCheckbox" type="checkbox" class="form-checkbox"> <span>Allow IP Whitelist Only</span>
          </label>
          
          <!-- IP Whitelist Management -->
          <div id="ipWhitelistSection" class="hidden mt-3 p-3 bg-neutral-100 dark:bg-neutral-800 rounded border border-neutral-300 dark:border-neutral-600">
            <div class="mb-3">
              <p class="text-sm mb-2">Your current IP: <span id="currentIpAddress" class="font-mono font-semibold">Loading...</span></p>
              <button id="addCurrentIpBtn" class="px-3 py-1.5 text-sm bg-green-500 hover:bg-green-600 text-white rounded">
                Add Current IP
              </button>
            </div>
            
            <div class="mb-3">
              <label class="block text-sm font-medium mb-1">Add IP Address</label>
              <div class="flex gap-2">
                <input id="newIpAddress" type="text" placeholder="192.168.1.1" class="flex-1 border dark:border-gray-600 bg-neutral-200 dark:bg-neutral-700 rounded px-3 py-1.5 text-sm">
                <input id="newIpDescription" type="text" placeholder="Description (optional)" class="flex-1 border dark:border-gray-600 bg-neutral-200 dark:bg-neutral-700 rounded px-3 py-1.5 text-sm">
                <button id="addIpBtn" class="px-3 py-1.5 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded whitespace-nowrap">
                  Add IP
                </button>
              </div>
            </div>
            
            <div>
              <h4 class="text-sm font-medium mb-2">Whitelisted IPs</h4>
              <div id="ipWhitelistList" class="space-y-2 max-h-48 overflow-y-auto">
                <p class="text-sm text-neutral-500">No IPs whitelisted yet</p>
              </div>
            </div>
          </div>
          
          <p class="text-xs text-neutral-600 dark:text-neutral-400 mt-2">When enabled, only requests from whitelisted IP addresses will be allowed.</p>
        </div>
<div class="border-t border-gray-400 dark:border-gray-400 pt-1">

        <div class="mb-2">
          <h3 class="font-semibold mb-2">Notifications</h3>
          <label class="flex items-center space-x-2">
            <input id="sendErrorAlertsCheckbox" type="checkbox" checked class="form-checkbox"> <span>Send error alerts</span>
          </label>
        </div>
<div class="border-t border-gray-400 dark:border-gray-400 pt-1">

          <div>
            <h3 class="font-semibold mb-2">Advance Settings</h3>
            <label class="block text-sm font-medium">API Rate Limit (requests per hour)</label>
              <input id="rateLimitInput" type="number" min="1" max="100000" value="1000" class="border dark:border-gray-600 bg-neutral-200 dark:bg-neutral-600 rounded px-3 py-2 w-full sm:w-48 mb-2">
              <p class="text-xs text-neutral-600 dark:text-neutral-400 mb-4">Maximum number of API requests you can make per hour. Set between 1-100,000.</p>
          </div>
<div class="border-t border-gray-400 dark:border-gray-400 pt-3">

    <div class="flex space-x-3 mb-4">
      <button id="saveEdit" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">Save Changes</button>
      <button id="resetEdit" class="px-4 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded">Reset</button>
    </div>

    <!-- Deactivate Account Section -->
    <div class="border-t border-red-400 dark:border-red-600 pt-4 mt-6">
      <h3 class="font-semibold text-red-600 dark:text-red-400 mb-2">Danger Zone</h3>
      <div id="activeAccountSection" class="mb-4">
        <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-3">
          Deactivating your account will disable access for 30 days. You can reactivate by logging in again within this period. After 30 days, your account and all data will be permanently deleted.
        </p>
        <button id="deactivateBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">
          Deactivate Account
        </button>
      </div>
      <div id="deactivatedAccountSection" class="hidden">
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded p-4 mb-3">
          <p class="text-red-800 dark:text-red-300 font-semibold mb-2">⚠️ Account Deactivated</p>
          <p class="text-sm text-red-700 dark:text-red-400 mb-2">
            Your account was deactivated on <span id="deactivationDate" class="font-medium"></span>.
          </p>
          <p class="text-sm text-red-700 dark:text-red-400">
            Days remaining: <span id="daysRemaining" class="font-bold text-lg"></span> days
          </p>
        </div>
        <button id="reactivateBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">
          Reactivate Account
        </button>
      </div>
    </div>

</main>
<!-- Edit profile -->
  <script>

    const editBtn = document.getElementById('editBtn');
    const editBtnLabel = editBtn.querySelector('label');
    const cancelBtn = document.getElementById('cancelBtn');
    const viewFName = document.getElementById('viewFName');
    const editFName = document.getElementById('editFName');
    const viewLName = document.getElementById('viewLName');
    const editLName = document.getElementById('editLName');
    const viewEmail = document.getElementById('viewEmail');
    const editEmail = document.getElementById('editEmail');
    const changePassword = document.getElementById('changePassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const wrapChangeP = changePassword.parentElement;
    const wrapConfirmP = confirmPassword.parentElement;
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    let editing = false;

    function toggleEdit(){
      editFName.value = viewFName.textContent || '';
      editLName.value = viewLName.textContent || '';
      editEmail.value = viewEmail.textContent ||'';

      show(editFName); show(editLName); show(editEmail); show(wrapChangeP); show(cancelBtn);
      hide(viewFName); hide(viewLName); hide (viewEmail); hide(wrapConfirmP);

      editBtnLabel.textContent = 'Save';
      editing = true;
    }

    function editNSave(){
      viewFName.textContent = editFName.value.trim();
      viewLName.textContent = editLName.value.trim();
      viewEmail.textContent = editEmail.value.trim();

      show(viewFName); show(viewLName); show(viewEmail);
      hide(editFName); hide(editLName); hide(editEmail); hide(wrapChangeP); hide(wrapConfirmP); hide(cancelBtn);

      editBtnLabel.textContent = 'Edit';
      editing = false;
    }

    function toggleCP(){
      const showCP = editFName.value.trim() || editLName.value.trim() || editEmail.value.trim() || changePassword.value.trim();
      wrapConfirmP.classList.toggle('hidden', !showCP);
    }
    [editFName, editLName, editEmail, wrapChangeP].forEach(input =>
      input.addEventListener('input', toggleCP)
    );

    function cancel(){
      editFName.value = (viewFName.textContent || '').trim();
      editLName.value = (viewLName.textContent || '').trim();
      editEmail.value = (viewEmail.textContent || '').trim();
      changePassword.value = '';
      confirmPassword.value = '';

      show(viewFName); show(viewLName); show(viewEmail);
      hide(editFName); hide(editLName); hide(editEmail); hide(wrapChangeP); hide(wrapConfirmP); hide(cancelBtn);
      editBtnLabel.textContent = 'Edit';
      editing = false;
    }

    editBtn.addEventListener('click', () => {
      if(!editing){
        toggleEdit();
      }
      else{editNSave()};
    });

    cancelBtn.addEventListener('click', cancel);

  </script>

<!-- Update sidebar & setting Pfp -->
<script>
  const pfpTrigger = document.getElementById("pfpTrigger");
  const updatePfp = document.getElementById("updatePfp");
  const imageStore = "connectify.pfpUrl";

  if(pfpTrigger && updatePfp){
    pfpTrigger.addEventListener("click", () => updatePfp.click());
    updatePfp.addEventListener("change", async (e) => {
      const file = e.target.files[0];

      if(!file){
        return;
      }

      if(!file.type.startsWith("image/")){
        alert("Please choose an image.");
        return;
      }
      const reader = new FileReader();
      reader.onload = async () =>{
        const pfpUrl = reader.result;
        try{
          localStorage.setItem(imageStore, pfpUrl);
          
          // Save to backend immediately
          const res = await fetch('/api/auth/profile', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ profilePicture: pfpUrl })
          });
          
          if (!res.ok) {
            console.warn("Could not save avatar to backend.");
          }
        }
        catch (e){
          console.warn("Could not save avatar. Try again.", e);
        }
        applyPfpToDOM(pfpUrl);
      };
      reader.readAsDataURL(file);
    });
  }
  function applyPfpToDOM(dataUrl){
    document.querySelectorAll(".js-main-pfp").forEach(img =>{
      img.src = dataUrl;
      img.classList.remove("hidden");
    });
    document.querySelectorAll(".js-initial-pfp, .js-hover-pfp").forEach(element =>{
      element.classList.add("hidden");
    });
  }
  async function hydrate(){
    // Load from backend first
    try {
      const res = await fetch('/api/auth/me', { credentials: 'include' });
      if (res.ok) {
        const data = await res.json();
        if (data.user?.profilePicture) {
          applyPfpToDOM(data.user.profilePicture);
          localStorage.setItem(imageStore, data.user.profilePicture);
          return;
        }
      }
    } catch (e) {
      console.warn("Could not load profile picture from backend:", e);
    }
    
    // Fallback to localStorage
    const saveImg = localStorage.getItem(imageStore);
    if(saveImg) applyPfpToDOM(saveImg);
  }
  document.addEventListener('DOMContentLoaded', hydrate);

</script>

<!-- Light Dark mode toggle -->
<script>
  const STORAGE_KEY = 'connectify.theme';
  const root = document.documentElement;
  const checkbox = document.getElementById('darkmode-toggle');

  const saved = localStorage.getItem(STORAGE_KEY) || 'light';
  root.classList.toggle('dark', saved === 'dark');
  if (checkbox) checkbox.checked = saved === 'dark';

  function setTheme(theme) {
    root.classList.toggle('dark', theme === 'dark');
    localStorage.setItem(STORAGE_KEY, theme);
    if (checkbox) checkbox.checked = theme === 'dark';

    console.log('Theme ->', theme, 'html.dark?', root.classList.contains('dark'));
  }

  if (checkbox) {
    checkbox.addEventListener('change', () => {
      setTheme(checkbox.checked ? 'dark' : 'light');
    });
  }
</script>

<!-- Settings Functionality -->
<script>
  let currentUser = null;
  let originalData = {};

  // Show custom notification
  function showNotification(message, type = 'success') {
    const colors = {
      success: 'bg-green-600',
      error: 'bg-red-600',
      info: 'bg-blue-600'
    };
    
    const icons = {
      success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',
      error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>',
      info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'
    };
    
    const notificationHTML = `
      <div class="fixed top-4 left-1/2 -translate-x-1/2 z-[70] animate-slide-down" id="notification">
        <div class="${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px]">
          <svg class="h-6 w-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            ${icons[type]}
          </svg>
          <span class="flex-1">${message}</span>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', notificationHTML);
    setTimeout(() => document.getElementById('notification')?.remove(), 5000);
  }

  // Load user data
  async function loadUserData() {
    try {
      const res = await fetch('/api/auth/me', { credentials: 'include' });
      
      if (!res.ok) {
        const errorData = await res.json().catch(() => ({}));
        
        // If not logged in, redirect to login
        if (res.status === 401) {
          console.log('Not authenticated, redirecting to login...');
          window.location.href = '/login.html';
          return;
        }
        
        throw new Error(errorData.error || 'Failed to load user data');
      }
      
      const data = await res.json();
      currentUser = data.user;
      
      // Update profile fields
      document.getElementById('viewFName').textContent = currentUser.firstName || '';
      document.getElementById('viewLName').textContent = currentUser.lastName || '';
      document.getElementById('viewEmail').textContent = currentUser.email || '';
      
      // Update rate limit
      const rateLimitInput = document.getElementById('rateLimitInput');
      if (rateLimitInput) {
        rateLimitInput.value = currentUser.rateLimit || 1000;
      }
      
      // Update checkboxes
      const sendErrorAlertsCheckbox = document.getElementById('sendErrorAlertsCheckbox');
      const allowIpWhitelistCheckbox = document.getElementById('allowIpWhitelistCheckbox');
      if (sendErrorAlertsCheckbox) {
        sendErrorAlertsCheckbox.checked = currentUser.sendErrorAlerts !== false;
      }
      if (allowIpWhitelistCheckbox) {
        allowIpWhitelistCheckbox.checked = currentUser.allowIpWhitelist || false;
        
        // Show IP whitelist section if enabled
        if (currentUser.allowIpWhitelist) {
          document.getElementById('ipWhitelistSection').classList.remove('hidden');
          loadCurrentIp();
          loadIpWhitelist();
        }
      }
      
      // Update profile username display
      const fullName = `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim();
      document.getElementById('profileUsername').textContent = fullName || 'User';
      document.getElementById('sidebarUsername').textContent = fullName || 'User';
      
      // Store original data
      originalData = {
        firstName: currentUser.firstName || '',
        lastName: currentUser.lastName || '',
        email: currentUser.email || '',
        rateLimit: currentUser.rateLimit || 1000,
        sendErrorAlerts: currentUser.sendErrorAlerts !== false,
        allowIpWhitelist: currentUser.allowIpWhitelist || false
      };
      
      // Check deactivation status
      if (currentUser.deactivatedAt) {
        showDeactivatedStatus(currentUser.deactivatedAt);
      }
    } catch (error) {
      console.error('Failed to load user data:', error);
      showNotification('Failed to load profile data: ' + error.message, 'error');
    }
  }

  // Save profile changes
  async function saveProfile() {
    const firstName = document.getElementById('editFName').value.trim();
    const lastName = document.getElementById('editLName').value.trim();
    const email = document.getElementById('editEmail').value.trim();
    const rateLimit = parseInt(document.getElementById('rateLimitInput').value);
    const sendErrorAlerts = document.getElementById('sendErrorAlertsCheckbox').checked;
    const allowIpWhitelist = document.getElementById('allowIpWhitelistCheckbox').checked;
    
    // Validate rate limit
    if (isNaN(rateLimit) || rateLimit < 1 || rateLimit > 100000) {
      showNotification('Rate limit must be between 1 and 100,000', 'error');
      return false;
    }
    
    try {
      const res = await fetch('/api/auth/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ 
          firstName, 
          lastName, 
          email, 
          rateLimit,
          sendErrorAlerts,
          allowIpWhitelist,
          profilePicture: localStorage.getItem(imageStore)
        })
      });
      
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Failed to update profile');
      }
      
      showNotification('Profile updated successfully!', 'success');
      await loadUserData();
      return true;
    } catch (error) {
      console.error('Failed to save profile:', error);
      showNotification(error.message, 'error');
      return false;
    }
  }

  // Deactivate account
  async function deactivateAccount() {
    if (!confirm('Are you sure you want to deactivate your account? You will have 30 days to reactivate by logging in again.')) {
      return;
    }
    
    try {
      const res = await fetch('/api/auth/deactivate', {
        method: 'POST',
        credentials: 'include'
      });
      
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Failed to deactivate account');
      }
      
      const data = await res.json();
      showNotification(data.message, 'info');
      showDeactivatedStatus(data.deactivatedAt);
    } catch (error) {
      console.error('Failed to deactivate account:', error);
      showNotification(error.message, 'error');
    }
  }

  // Reactivate account
  async function reactivateAccount() {
    try {
      const res = await fetch('/api/auth/reactivate', {
        method: 'POST',
        credentials: 'include'
      });
      
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Failed to reactivate account');
      }
      
      const data = await res.json();
      showNotification(data.message, 'success');
      hideDeactivatedStatus();
    } catch (error) {
      console.error('Failed to reactivate account:', error);
      showNotification(error.message, 'error');
    }
  }

  // Show deactivated status
  function showDeactivatedStatus(deactivatedAt) {
    const deactivationDate = new Date(deactivatedAt);
    const now = new Date();
    const daysPassed = Math.floor((now - deactivationDate) / (1000 * 60 * 60 * 24));
    const daysRemaining = Math.max(0, 30 - daysPassed);
    
    document.getElementById('deactivationDate').textContent = deactivationDate.toLocaleDateString();
    document.getElementById('daysRemaining').textContent = daysRemaining;
    
    document.getElementById('activeAccountSection').classList.add('hidden');
    document.getElementById('deactivatedAccountSection').classList.remove('hidden');
  }

  // Hide deactivated status
  function hideDeactivatedStatus() {
    document.getElementById('activeAccountSection').classList.remove('hidden');
    document.getElementById('deactivatedAccountSection').classList.add('hidden');
  }

  // Update save button handler
  document.getElementById('saveEdit')?.addEventListener('click', async () => {
    if (editing) {
      const saved = await saveProfile();
      if (saved) {
        editNSave();
      }
    } else {
      showNotification('Click Edit to modify your profile', 'info');
    }
  });

  // Update reset button
  document.getElementById('resetEdit')?.addEventListener('click', () => {
    document.getElementById('viewFName').textContent = originalData.firstName;
    document.getElementById('viewLName').textContent = originalData.lastName;
    document.getElementById('viewEmail').textContent = originalData.email;
    
    document.getElementById('editFName').value = originalData.firstName;
    document.getElementById('editLName').value = originalData.lastName;
    document.getElementById('editEmail').value = originalData.email;
    
    document.getElementById('rateLimitInput').value = originalData.rateLimit;
    document.getElementById('sendErrorAlertsCheckbox').checked = originalData.sendErrorAlerts;
    document.getElementById('allowIpWhitelistCheckbox').checked = originalData.allowIpWhitelist;
    
    showNotification('Changes reset', 'info');
  });

  // Deactivate account button
  document.getElementById('deactivateBtn')?.addEventListener('click', deactivateAccount);

  // Reactivate account button
  document.getElementById('reactivateBtn')?.addEventListener('click', reactivateAccount);

  // IP Whitelist Management
  let currentWhitelist = [];

  // Toggle IP whitelist section visibility
  document.getElementById('allowIpWhitelistCheckbox')?.addEventListener('change', (e) => {
    const section = document.getElementById('ipWhitelistSection');
    if (e.target.checked) {
      section.classList.remove('hidden');
      loadCurrentIp();
      loadIpWhitelist();
    } else {
      section.classList.add('hidden');
    }
  });

  // Load current IP address
  async function loadCurrentIp() {
    try {
      const res = await fetch('/api/ip-whitelist/current-ip', { credentials: 'include' });
      if (!res.ok) throw new Error('Failed to fetch current IP');
      
      const data = await res.json();
      document.getElementById('currentIpAddress').textContent = data.currentIp;
    } catch (error) {
      console.error('Failed to load current IP:', error);
      document.getElementById('currentIpAddress').textContent = 'Unknown';
    }
  }

  // Load IP whitelist
  async function loadIpWhitelist() {
    try {
      const res = await fetch('/api/ip-whitelist', { credentials: 'include' });
      if (!res.ok) throw new Error('Failed to fetch whitelist');
      
      const data = await res.json();
      currentWhitelist = data.whitelist || [];
      renderIpWhitelist();
    } catch (error) {
      console.error('Failed to load IP whitelist:', error);
      showNotification('Failed to load IP whitelist', 'error');
    }
  }

  // Render IP whitelist
  function renderIpWhitelist() {
    const container = document.getElementById('ipWhitelistList');
    
    if (currentWhitelist.length === 0) {
      container.innerHTML = '<p class="text-sm text-neutral-500">No IPs whitelisted yet</p>';
      return;
    }

    container.innerHTML = currentWhitelist.map(entry => `
      <div class="flex items-center justify-between p-2 bg-neutral-50 dark:bg-neutral-700 rounded text-sm">
        <div class="flex-1">
          <span class="font-mono font-semibold">${entry.ip_address}</span>
          ${entry.description ? `<span class="text-neutral-600 dark:text-neutral-400 ml-2">- ${entry.description}</span>` : ''}
          <div class="text-xs text-neutral-500">${new Date(entry.created_at).toLocaleString()}</div>
        </div>
        <button onclick="removeIpFromWhitelist('${entry.id}')" class="px-2 py-1 text-xs bg-red-500 hover:bg-red-600 text-white rounded">
          Remove
        </button>
      </div>
    `).join('');
  }

  // Add current IP to whitelist
  document.getElementById('addCurrentIpBtn')?.addEventListener('click', async () => {
    const currentIp = document.getElementById('currentIpAddress').textContent;
    if (currentIp === 'Loading...' || currentIp === 'Unknown') {
      showNotification('Current IP not available', 'error');
      return;
    }
    
    await addIpToWhitelist(currentIp, 'Current IP');
  });

  // Add IP to whitelist
  document.getElementById('addIpBtn')?.addEventListener('click', async () => {
    const ipAddress = document.getElementById('newIpAddress').value.trim();
    const description = document.getElementById('newIpDescription').value.trim();
    
    if (!ipAddress) {
      showNotification('Please enter an IP address', 'error');
      return;
    }
    
    await addIpToWhitelist(ipAddress, description);
    
    // Clear inputs
    document.getElementById('newIpAddress').value = '';
    document.getElementById('newIpDescription').value = '';
  });

  // Add IP to whitelist helper
  async function addIpToWhitelist(ipAddress, description) {
    try {
      const res = await fetch('/api/ip-whitelist', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ ipAddress, description })
      });
      
      const data = await res.json();
      
      if (!res.ok) {
        showNotification(data.error || 'Failed to add IP', 'error');
        return;
      }
      
      showNotification('IP address added to whitelist', 'success');
      await loadIpWhitelist();
    } catch (error) {
      console.error('Failed to add IP:', error);
      showNotification('Failed to add IP to whitelist', 'error');
    }
  }

  // Remove IP from whitelist (global function for onclick)
  window.removeIpFromWhitelist = async function(id) {
    if (!confirm('Remove this IP from whitelist?')) return;
    
    try {
      const res = await fetch(`/api/ip-whitelist/${id}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      
      const data = await res.json();
      
      if (!res.ok) {
        showNotification(data.error || 'Failed to remove IP', 'error');
        return;
      }
      
      showNotification('IP address removed from whitelist', 'success');
      await loadIpWhitelist();
    } catch (error) {
      console.error('Failed to remove IP:', error);
      showNotification('Failed to remove IP from whitelist', 'error');
    }
  };

  // Initialize
  document.addEventListener('DOMContentLoaded', loadUserData);
</script>



</body>
</html>