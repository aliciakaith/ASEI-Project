<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flow Designer</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = { darkMode: 'class' };
</script>

<script>
  (function () {
    const KEY = 'connectify.theme';
    const saved = localStorage.getItem(KEY);
    if (saved === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
      if (saved !== 'light') localStorage.setItem(KEY, 'light');
    }
  })();
</script>
<script src="https://unpkg.com/jsplumb@2.15.6/dist/js/jsplumb.min.js"></script>
<script src="js/flowDesignerAPI.js"></script>
<link rel="icon" type="image/png" href="images/connectify_logo.png">
<style>
  body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; }

  #canvas {
    position: relative;
    width: 100%;
    height: calc(70vh + 8px);
    background-image:
      linear-gradient(to right, #e5e7eb 1px, transparent 1px),
      linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
    background-size: 30px 30px;
    border-radius: 0.5rem;
    overflow: hidden;
  }
  .dark #canvas{
    background-image:
      linear-gradient(to right, #626976 1px, transparent 1px),
      linear-gradient(to bottom, #626976 1px, transparent 1px);
    background-size: 30px 30px;
  }

  .node {
    position: absolute;
    padding: 10px 14px;
    border-radius: 10px;
    color: #fff;
    cursor: move;
    font-size: 0.875rem;
    user-select: none;
    box-shadow: 0 2px 8px rgba(0,0,0,.12);
    border: 2px solid transparent;
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-width: 120px;
  }

  .node.start{background:#2563eb}
  .node.api{background:#16a34a}
  .node.condition{background:#eab308;color:#111}
  .node.transform{background:#8b5cf6}
  .node.end{background:#dc2626}
  .node.active{border-color:#3b82f6}

  .connector-dot {
    width: 10px;
    height: 10px;
    background-color: #1f2937;
    border-radius: 999px;
    cursor: crosshair;
  }
  .dot-left { margin-right: 8px; }
  .dot-right { margin-left: 8px; }
</style>
</head>

<body class="bg-neutral-50 text-neutral-900 dark:bg-neutral-900 dark:text-neutral-100">

<!-- Sidebar -->
<aside class="fixed inset-y-0 left-0 w-60 bg-neutral-100 text-neutral-900 dark:bg-neutral-800/40 dark:text-neutral-100 flex flex-col">
  <div class="px-4 py-4 flex items-center gap-2 border-b border-neutral-400 dark:border-gray-400/70">
    <img src="images/connectify_logo.png" alt="Logo" class="h-8 w-auto">
    <span>Connectify</span>
  </div>
      <nav class="p-2 text-sm space-y-1 flex-1">
        <a href="asei_dashboard.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor" d="M13.5 8.183V4.817q0-.357.234-.587t.58-.23h4.88q.347 0 .576.23t.23.587v3.366q0 .358-.234.587q-.234.23-.58.23h-4.88q-.346 0-.576-.23t-.23-.587M4 11.2V4.8q0-.34.234-.57t.58-.23h4.88q.347 
          0 .576.23t.23.57v6.4q0 .34-.234.57t-.58.23h-4.88q-.346 0-.576-.23T4 11.2m9.5 8v-6.4q0-.34.234-.57t.58-.23h4.88q.347 0 .576.23t.23.57v6.4q0 .34-.234.57t-.58.23h-4.88q-.346 0-.576-.23t-.23-.57M4 19.183v-3.366q0-.357.234-.587t.58-.23h4.88q.347 0 .576.23t.23.587v3.366q0 .358-.234.587q-.234.23-.58.23h-4.88q-.346 0-.576-.23T4 19.183M5 11h4.5V5H5zm9.5 8H19v-6h-4.5zm0-11H19V5h-4.5zM5 19h4.5v-3H5zm4.5-3"/>
            </svg></span><span class="hidden sm:inline">Dashboard</span></a>

        <a href="flow_designer.html" class="flex items-center gap-2 px-3 py-2 rounded bg-neutral-300 dark:bg-neutral-800"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24"><path fill="currentColor" d="M11.5 12.5h-5q-.213 0-.356-.144T6 11.999t.144-.356t.356-.143h5v-5q0-.213.144-.356T12.001 6t.356.144t.143.356v5h5q.213 0 .356.144t.144.357t-.144.356t-.356.143h-5v5q0 .213-.144.356t-.357.144t-.356-.144t-.143-.356z"/>
          </svg></span><span class="hidden sm:inline">Flow Designer</span></a>

        <a href="Connectors.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-5 w-5 -translate-x-[1px]" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M4.513 19.487c2.512 2.392 5.503 1.435 6.7.466c.618-.501.897-.825 
          1.136-1.065c.837-.777.784-1.555.24-2.177c-.219-.249-1.616-1.591-2.956-2.967c-.694-.694-1.172-1.184-1.582-1.58c-.547-.546-1.026-1.172-1.744-1.154c-.658 0-1.136.58-1.735 1.179c-.688.688-1.196 1.555-1.375 2.333c-.539 2.273.299 3.888 1.316 4.965Zm0 0L2 21.999M19.487 4.515c-2.513-2.394-5.494-1.42-6.69-.45c-.62.502-.898.826-1.138 1.066c-.837.778-.784 1.556-.239 2.178c.078.09.31.32.635.644m7.432-3.438c1.017 1.077 1.866 
            2.71 1.327 4.985c-.18.778-.688 1.645-1.376 2.334c-.598.598-1.077 1.179-1.735 1.179c-.718.018-1.09-.502-1.639-1.048m3.423-7.45L22 2m-5.936 9.964c-.41-.395-.994-.993-1.688-1.687c-.858-.882-1.74-1.75-2.321-2.325m4.009 4.012l-1.562 1.525m-3.99-3.984l1.543-1.553"/>
              </svg></span><span class="hidden sm:inline">Connectors</span></a>

        <a href="templates.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-5 w-5 -translate-x-[1px]" viewBox="0 0 24 24"><path fill="currentColor" d="M13 9h1v2h-3V7h2zm5.5 0l-2.12-2.12l1.25-1.25L20 8v2h-2v1h-3V9zM13 3.5V2h-1v2h1v2h-2V4H9V2H8v2H6v1H4V4c0-1.11.89-2 2-2h8l2.36 2.36l-1.25 1.25zM20 20a2 2 0 0 1-2 
          2h-2v-2h2v-1h2zm-2-5h2v3h-2zm-6 7v-2h3v2zm-4 0v-2h3v2zm-2 0a2 2 0 0 1-2-2v-2h2v2h1v2zm-2-8h2v3H4zm0-4h2v3H4zm14 1h2v3h-2zM4 6h2v3H4z"/>
            </svg></span><span class="hidden sm:inline">Templates</span></a>

        <a href="deployments.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px] -translate-x-[-2px] -translate-y-[-3px]" viewBox="0 0 24 24"><path fill="currentColor" d="M4.18 7c-.473 0-.88.294-.972.703l-1.189 5.25a1 1 0 0 0-.019.172c0 .483.444.875.99.875h11.02q.098 0 .194-.017c.537-.095.885-.556.778-1.03l-1.19-5.25C13.7 7.294 13.293 7 12.822 7zM5 6v1h7V6h.825c.946 
          0 1.76.606 1.946 1.447l1.19 5.4c.215.975-.482 1.923-1.556 2.118a2 2 0 0 1-.39.035H2.985C1.888 15 1 14.194 1 13.2q0-.178.039-.353l1.19-5.4C2.414 6.606 3.229 6 4.174 6z"/><path fill="#90a4ae" d="M5.99 1.399a.5.5 0 0 0-.98.202l2.058 9.945c.327 1.582 2.58 1.6 2.933.023l1.845-8.274L12.6 4.3a.5.5 0 0 0 .8-.6l-1.5-2a.5.5 0 0 0-.7-.1l-2 1.5a.5.5 0 1 0 .6.8l1.065-.799l-1.84 8.25c-.118.526-.869.52-.978-.008z"/>
            </svg></span><span class="hidden sm:inline">Deployments</span></a>

        <a href="monitoring.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px] -translate-x-[1px]" viewBox="0 0 24 24"><path fill="currentColor" d="M4 20.5q-.214 0-.357-.144T3.5 20v-.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T7.5 
          20v-5.288q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.213 0-.356-.144T11.5 20v-3.288q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T15.5 20v-4.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 .213-.144.356t-.357.144m4 0q-.212 0-.356-.144T19.5 20v-8.788q0-.213.144-.357t.357-.143t.356.143t.143.357V20q0 
            .213-.144.356t-.357.144M14 11.437q-.304 0-.598-.12q-.295-.12-.538-.34l-2.422-2.421q-.173-.173-.442-.173t-.442.173L4.354 13.76q-.146.146-.357.153q-.21.006-.356-.16q-.141-.145-.135-.349t.14-.338l5.218-5.218q.243-.24.538-.35q.294-.11.598-.11t.609.11t.527.35l2.422 2.421q.173.173.442.173t.442-.173l5.204-5.203q.146-.147.357-.153q.21-.007.357.158q.14.146.134.35t-.14.339l-5.217 5.217q-.224.22-.528.34t-.609.12"/>
              </svg></span><span class="hidden sm:inline">Monitoring</span></a>

        <a href="settings.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-400/70 dark:hover:bg-neutral-700"><span class="inline-flex h-6 w-6 shrink-0 items-center justify-center text-[#30438a] dark:text-[#90a4ae]"><svg class="h-[24px] w-[24px]" viewBox="0 0 24 24">
          <path fill="currentColor" d="M10.96 21q-.349 0-.605-.229q-.257-.229-.319-.571l-.263-2.092q-.479-.145-1.036-.454q-.556-.31-.947-.664l-1.915.824q-.317.14-.644.03t-.504-.415L3.648 15.57q-.177-.305-.104-.638t.348-.546l1.672-1.25q-.045-.272-.073-.559q-.03-.288-.03-.559q0-.252.03-.53q.028-.278.073-.626l-1.672-1.25q-.275-.213-.338-.555t.113-.648l1.06-1.8q.177-.287.504-.406t.644.021l1.896.804q.448-.373.97-.673q.52-.3 
          1.013-.464l.283-2.092q.061-.342.318-.571T10.96 3h2.08q.349 0 .605.229q.257.229.319.571l.263 2.112q.575.202 1.016.463t.909.654l1.992-.804q.318-.14.645-.021t.503.406l1.06 1.819q.177.306.104.638t-.348.547L18.36 10.92q.082.31.092.569t.01.51q0 
          .233-.02.491q-.019.259-.088.626l1.69 1.27q.275.213.358.546t-.094.638l-1.066 1.839q-.176.306-.513.415q-.337.11-.654-.03l-1.923-.824q-.467.393-.94.673t-.985.445l-.264 2.111q-.061.342-.318.571t-.605.23zm.04-1h1.956l.369-2.708q.756-.2 
          1.36-.549q.606-.349 1.232-.956l2.495 1.063l.994-1.7l-2.189-1.644q.125-.427.166-.786q.04-.358.04-.72q0-.38-.04-.72t-.166-.747l2.227-1.683l-.994-1.7l-2.552 1.07q-.454-.499-1.193-.935q-.74-.435-1.4-.577L13 
          4h-1.994l-.312 2.689q-.756.161-1.39.52q-.633.358-1.26.985L5.55 7.15l-.994 1.7l2.169 1.62q-.125.336-.175.73t-.05.82q0 .38.05.755t.156.73l-2.15 1.645l.994 1.7l2.475-1.05q.589.594 1.222.953q.634.359 1.428.559zm.973-5.5q1.046 0 1.773-.727T14.473 12t-.727-1.773t-1.773-.727q-1.052 0-1.776.727T9.473 12t.724 1.773t1.776.727M12 12"/>
            </svg></span><span class="hidden sm:inline">Settings</span></a>
      </nav>
    <div class="relative">
      <div id="profileBtn" class="w-full px-4 py-4 flex items-center gap-2 border-t border-neutral-400 dark:border-gray-400/70 text-left">

          <img id="initialSidebarPfp" src="images/default_avatar.png" class="js-initial-pfp h-8 w-8 rounded-full object-cover" alt="O Pfp"/>
          <img id="mainPfp" class="js-main-pfp h-8 w-8 rounded-full object-cover hidden" alt="N Pfp"/>
          <span class="text-sm font-medium">Insert User Name</span>
      </div>

    </div>
</aside>

<!-- Main -->
<main class="ml-60 p-6">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold">Flow Designer</h2>
  </div>

  <!-- Toolbar -->
  <div class="flex flex-col mb-2">
    <div class="text-neutral-500 text-sm text-left mb-5">Drag nodes onto the grid and connect them by dragging from the right dot to another node's left dot.</div>
    <div class="flex gap-2 w-full items-center">
      <button id="newFlowBtn" class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white border border-green-600 rounded justify-content">
        + Add Flow
      </button>
      <button id="loadFlowBtn" class="px-3 py-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-700 border dark:border-neutral-600 rounded justify-content">
        Load Flow
      </button>
      <input id="flowNameInput" type="text" placeholder="Enter Name of Flow" class="px-3 py-2 bg-neutral-100 border dark:border-neutral-600 dark:bg-neutral-700 rounded justify-content">

      <button class="ml-auto px-3 py-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-500 dark:hover:bg-gray-600 border dark:border-neutral-600 rounded justify-end" onclick="exportFlow()">Export</button>
      <button class="px-3 py-2 bg-gray-500 hover:bg-gray-600 dark:bg-gray-700 dark:hover:bg-gray-800 border dark:border-neutral-800 text-white rounded justify-end" onclick="saveFlow('draft')">Save Draft</button>
      <button class="px-3 py-2 bg-blue-500 hover:bg-blue-600 dark:bg-blue-700 dark:hover:bg-blue-800 boder dark:border-blue-800 text-white rounded justify-end" onclick="saveFlow('active')">Deploy Flow</button>
      <button id="viewExecutionsBtn" class="px-3 py-2 bg-purple-500 hover:bg-purple-600 dark:bg-purple-700 dark:hover:bg-purple-800 border dark:border-purple-800 text-white rounded justify-end hidden" onclick="viewExecutions()">Executions</button>
    </div>
  </div>

  <div class="flex flex-col gap-4">
    <!-- Node Library -->
    <aside class="col-span-12 md:col-span-3 bg-white dark:bg-neutral-800 dark:text-neutral-200 rounded shadow p-4 overflow-auto">
      <div class="text-sm font-semibold mb-3">Node Library</div>
      <div class="text-xs uppercase text-neutral-500 dark:text-neutral-400 mb-2">General</div>
      <div class="flex gap-2 mb-4">
        <button class="w-full border dark:border-neutral-700 rounded px-2 py-2 text-left text-blue-400" onclick="createNode('start')">Start</button>
        <button class="w-full border dark:border-neutral-700 rounded px-2 py-2 text-left text-blue-400" onclick="createNode('end')">End</button>
      </div>

      <div class="flex gap-1 items-center cursor-pointer" onclick="toggleMTN()">
        <span class="text-xs uppercase text-neutral-500 dark:text-neutral-400 mb-2">MTN</span>
        <!-- open arrow -->
        <svg id="openArrow" class="w-3.5 h-3.5 text-neutral-500 dark:text-neutral-400 transition-transform duration-200" fill="none" viewbox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 10l6-6 6 6" />
        </svg>
        <!-- close arrow -->
        <svg id="closeArrow" class="hidden w-3.5 h-3.5 text-neutral-500 dark:text-neutral-400 transition-transform duration-200" fill="none" viewbox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 3l6 6 6-6" />
        </svg>
      </div>
      <div id="mtnBtn" class="grid grid-cols-2 gap-2">
        <button class="w-full border dark:border-neutral-700 rounded px-2 py-2 text-left text-green-600 dark:text-green-600" onclick="createNode('mtn.requestToPay','api','Request to Pay')">Request to Pay</button>
        <button class="w-full border dark:border-neutral-700 rounded px-2 py-2 text-left text-green-600 dark:text-green-600" onclick="createNode('mtn.checkStatus','api','Check Status')">Check Status</button>
        <button class="w-full border dark:border-neutral-700 rounded px-2 py-2 text-left text-green-600 dark:text-green-600" onclick="createNode('mtn.getBalance','api','Get Balance')">Get Balance</button>
        <button class="w-full border dark:border-neutral-700 rounded px-2 py-2 text-left text-green-600 dark:text-green-600" onclick="createNode('mtn.getAccountHolder','api','Account Holder')">Account Holder</button>
      </div>

      <div class="flex gap-1 items-center cursor-pointer" onclick="toggleFW()">
        <span class="text-xs uppercase text-neutral-500 dark:text-neutral-400 mb-2 mt-5">Flutterwave</span>
        <!-- open arrow -->
        <svg id="openArrowFW" class="w-3.5 h-3.5 text-neutral-500 dark:text-neutral-400 transition-transform duration-200 translate-y-1" fill="none" viewbox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 19l6-6 6 6" />
        </svg>
        <!-- close arrow -->
        <svg id="closeArrowFW" class="hidden w-3.5 h-3.5 text-neutral-500 dark:text-neutral-400 transition-transform duration-200 translate-y-1" fill="none" viewbox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 12l6 6 6-6" />
        </svg>
      </div>
      <div id="fWBtn" class="grid grid-cols-2 gap-2">
        <button class="w-full border dark:border-neutral-700 rounded px-2 py-2 text-left text-green-600 dark:text-green-600" onclick="createNode('fW.fWPayment', 'api', 'Payment')">Payment</button>
        <button class="w-full border dark:border-neutral-700 rounded px-2 py-2 text-left text-green-600 dark:text-green-600" onclick="createNode('fW.fWVerifyPayment', 'api', 'Verify Payment')">Verify Payment</button>
      </div>
      
      <div class="mt-6">
        <button class="w-full px-3 py-2 border border-red-600 dark:border-red-700 rounded" onclick="clearCanvas()">Clear Canvas</button>
      </div>
    </aside>

    <!-- Canvas -->
    <section class="col-span-12 md:col-span-6">
      <div id="canvas" class="bg-white dark:bg-neutral-800 shadow"></div>
    </section>

    <!-- Properties -->
    <aside id="propertiesPanel" class="col-span-12 md:col-span-3 bg-white dark:bg-neutral-800 rounded shadow p-4 hidden">
      <h3 class="font-semibold mb-2">Node Properties</h3>
      <div id="propInner" class="space-y-3 text-sm">
        <p class="text-neutral-500">Select a node.</p>
      </div>
    </aside>
  </div>
</main>

<!-- JS Logic -->
<script>
let jsPlumbInstance;
let nodes = [];
let connections = [];
let currentFlowId = null;
let currentFlowName = 'New Flow';
const canvas = document.getElementById('canvas');

document.addEventListener('DOMContentLoaded', () => {
  const isDark = document.documentElement.classList.contains('dark');
  jsPlumbInstance = jsPlumb.getInstance({
    Container: canvas,
    Connector: ['Bezier', { curviness: 50 }],
    PaintStyle: { stroke: isDark ? '#70a3b3' : '#64748b', strokeWidth: 2 },
    EndpointStyle: { fill: '#1f2937', radius: 4 },
    Anchors: ['Right', 'Left'],
    ConnectionOverlays: [['Arrow', { width:10, length:10, location:1 }]]
  });

  canvas.addEventListener('click', () => {
    document.getElementById('propertiesPanel').classList.add('hidden');
  });

  // Check authentication
  checkAuth();

  // Setup load flow button
    // Setup load flow button
  document.getElementById('loadFlowBtn').addEventListener('click', () => {
    // show the executions button as soon as Load Flow is clicked
    document.getElementById('viewExecutionsBtn')?.classList.remove('hidden');
    showLoadFlowModal();
  });


  // Setup new flow button
  document.getElementById('newFlowBtn').addEventListener('click', async () => {
    if (nodes.length > 0) {
      const confirmed = await showConfirmModal(
        'Start New Flow',
        'Are you sure you want to start a new flow? Any unsaved changes will be lost.',
        'Start New Flow',
        'Cancel'
      );
      if (!confirmed) return;
    }
    clearCanvasSilent();
    currentFlowId = null;
    currentFlowName = 'New Flow';
    document.getElementById('flowNameInput').value = 'New Flow';
  });

  // Check if a template was selected
  if(typeof loadTemplate === "function"){
    loadTemplate();
  }
  
  // Check if template loaded from localStorage
  checkForTemplateLoad();
});

// Check if user is authenticated
async function checkAuth() {
  try {
    const response = await fetch('/api/dashboard/me', {
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' }
    });
    if (!response.ok) {
      window.location.href = '/login';
      return;
    }
    const userData = await response.json();
    // Update profile info if needed
    if (userData.firstName) {
      document.querySelector('#profileBtn span').textContent = `${userData.firstName} ${userData.lastName || ''}`.trim();
    }
  } catch (error) {
    console.error('Auth check failed:', error);
    window.location.href = '/login';
  }
}
// Delete Execution
async function deleteExecution(executionId) {
  const confirmed = await showConfirmModal(
    'Delete Execution',
    'Are you sure you want to delete this execution record? This action cannot be undone.',
    'Delete',
    'Cancel'
  );
  
  if (!confirmed) return;
  
  try {
    const resp = await fetch(`/api/executions/${executionId}`, {
      method: 'DELETE',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' }
    });
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({ error: 'Failed to delete' }));
      throw new Error(err.error || `HTTP ${resp.status}`);
    }
    
    // Close any open modals and refresh the executions list
    document.querySelectorAll('.modal-backdrop').forEach(m => m.remove());
    setTimeout(() => viewExecutions(), 300);
  } catch (error) {
    console.error('Failed to delete execution:', error);
    showNotification('Failed to delete execution', 'error');
  }
}


function attachNodeInteractions(el, id, name) {
  jsPlumbInstance.draggable(el, {
    grid: [10, 10],
    start: () => { el.dataset.dragging = "1"; },
    stop:  () => { setTimeout(() => { delete el.dataset.dragging; }, 0); }
  });

  el.addEventListener('click', (e) => {
    e.stopPropagation();
    if (el.dataset.dragging) return; 
    openProps(id, name);
  });

  jsPlumbInstance.makeSource(document.getElementById(id + '_right'), { parent: el, anchor:'Right' });
  jsPlumbInstance.makeTarget(document.getElementById(id + '_left'),  { parent: el, anchor:'Left'  });
}

function createNode(type, kindOverride, nameOverride) {
  const id = 'node_' + Math.random().toString(36).substr(2, 9);
  const kind = kindOverride || (type.startsWith('mtn.') || type.startsWith('fW.') ? 'api' : type);
  const name = nameOverride || type[0].toUpperCase() + type.slice(1);

  const el = document.createElement('div');
  el.className = `node ${kind}`;
  el.id = id;
  el.style.left = (60 + Math.random()*300) + 'px';
  el.style.top = (40 + Math.random()*200) + 'px';
  el.innerHTML = `
    <div class="connector-dot dot-left" id="${id}_left"></div>
    <span>${name}</span>
    <div class="connector-dot dot-right" id="${id}_right"></div>
  `;
  canvas.appendChild(el);

  jsPlumbInstance.makeSource(document.getElementById(id+'_right'), { parent: el, anchor:'Right' });
  jsPlumbInstance.makeTarget(document.getElementById(id+'_left'), { parent: el, anchor:'Left' });

  canvas.appendChild(el);
  attachNodeInteractions(el, id, name);

  nodes.push({id, type, kind, name, x:el.offsetLeft, y:el.offsetTop});
}

//properties modal
function openProps(id, name) {
  const node = nodes.find(n => n.id === id);
  const currentLabel = node?.name || name;

  const modal = document.createElement('div');
  modal.className = 'modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="modal-content bg-white dark:bg-neutral-800 rounded-lg shadow-xl w-full max-w-md mx-4 overflow-hidden">
      <div class="p-6">
        <h3 class="text-lg font-semibold mb-3 text-neutral-900 dark:text-neutral-100">Node Properties</h3>

        <label class="block text-sm font-medium mb-1">Node Label</label>
        <input id="prop_name_input"
               class="w-full dark:bg-neutral-600 border dark:border-neutral-700 rounded px-3 py-2 mb-6"
               value="${currentLabel}"/>

        <div class="flex items-center justify-between">
          <button id="remove_btn"
                  class="px-3 py-2 bg-red-500 border border-red-600 hover:bg-red-600 text-white rounded">
            Remove
          </button>
          <div class="flex gap-2">
            <button id="cancel_btn"
                    class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
              Cancel
            </button>
            <button id="save_btn"
                    class="px-3 py-2 bg-blue-500 border border-blue-600 hover:bg-blue-600 text-white rounded">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  const input = modal.querySelector('#prop_name_input');
  const saveBtn = modal.querySelector('#save_btn');
  const cancelBtn = modal.querySelector('#cancel_btn');
  const removeBtn = modal.querySelector('#remove_btn');

  // focus
  setTimeout(() => { input.focus(); input.select(); }, 50);

  const close = () => {
    modal.style.opacity = '0';
    modal.querySelector('.modal-content').style.transform = 'translateY(10px) scale(0.98)';
    setTimeout(() => modal.remove(), 180);
  };

  // Save label
  saveBtn.addEventListener('click', () => {
    const newName = input.value.trim();
    const el = document.getElementById(id);
    if (el && newName) {
      el.querySelector('span').textContent = newName;
      const n = nodes.find(n => n.id === id);
      if (n) n.name = newName;
    }
    close();
  });

removeBtn.addEventListener('click', () => {
  removeNode(id);  
  close();         
});

  cancelBtn.addEventListener('click', close);
  const onEsc = (e) => { if (e.key === 'Escape') { close(); document.removeEventListener('keydown', onEsc);} };
  document.addEventListener('keydown', onEsc);

  input.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveBtn.click(); });
}

function saveNodeLabel(id) {
  const newName = document.getElementById('prop_name').value;
  const el = document.getElementById(id);
  if (el) {
    el.querySelector('span').textContent = newName;
    // Update in nodes array
    const node = nodes.find(n => n.id === id);
    if (node) node.name = newName;
  }
}

function removeNode(id) {
  const el = document.getElementById(id)
  if(!el) return;

  if(jsPlumbInstance &&jsPlumbInstance.remove){
    jsPlumbInstance.remove(el);
  }
  else{
    jsPlumbInstance.deleteConnectionsForElement(id);
    jsPlumbInstance.removeAllEndpoints(id);
    el.remove();
  }

  // Remove from nodes array
  nodes = nodes.filter(n => n.id !== id);

  const panel = document.getElementById('propertiesPanel');
  if(panel) panel.classList.add('hidden');
}

function exportFlow() {
  const connections = jsPlumbInstance.getAllConnections().map(c=>({
    from: c.sourceId.replace('_right', ''),
    to: c.targetId.replace('_left', '')
  }));
  
  const flowData = {
    nodes: nodes.map(n => ({
      id: n.id,
      type: n.type,
      kind: n.kind,
      label: n.name,
      x: document.getElementById(n.id)?.offsetLeft || n.x,
      y: document.getElementById(n.id)?.offsetTop || n.y
    })),
    edges: connections
  };
  
  console.log(JSON.stringify(flowData, null, 2));
  
  // Download as JSON
  const blob = new Blob([JSON.stringify(flowData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentFlowName.replace(/\s+/g, '_')}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

async function saveFlow(status) {
  const flowName = document.getElementById('flowNameInput').value.trim() || 'Untitled Flow';

  try {
    // Update positions before saving
    nodes.forEach(n => {
      const el = document.getElementById(n.id);
      if (el) {
        n.x = el.offsetLeft;
        n.y = el.offsetTop;
      }
    });

    const connections = jsPlumbInstance.getAllConnections().map(c=>({
      from: c.sourceId.replace('_right', ''),
      to: c.targetId.replace('_left', '')
    }));
    
    const graph = {
      nodes: nodes.map(n => ({
        id: n.id,
        type: n.type,
        kind: n.kind,
        label: n.name,
        x: n.x,
        y: n.y
      })),
      edges: connections
    };

    // Check if flow is empty AFTER building the graph
    if (graph.nodes.length === 0) {
      showNotification('Cannot save an empty flow. Add some nodes first.', 'error');
      return;
    }

    // Create or update flow
    if (!currentFlowId) {
      // Try to reuse an existing flow with the same name to avoid duplicate errors
      try {
        const existingFlows = await FlowAPI.getAllFlows();
        const existing = Array.isArray(existingFlows) ? existingFlows.find(f => f.name === flowName) : null;
        if (existing) {
          currentFlowId = existing.id;
          currentFlowName = existing.name;
        } else {
          const flow = await FlowAPI.createFlow(flowName, 'Created from flow designer');
          currentFlowId = flow.id;
          currentFlowName = flowName;
        }
      } catch (e) {
        // Fallback to creating if listing failed
        const flow = await FlowAPI.createFlow(flowName, 'Created from flow designer');
        currentFlowId = flow.id;
        currentFlowName = flowName;
      }
    }

    // Save version
    await FlowAPI.saveFlowVersion(currentFlowId, graph);

    // Update status if deploying
    let executionResult = null;
    if (status === 'active') {
      try {
        const deployResult = await FlowAPI.updateFlowStatus(currentFlowId, 'active');
        executionResult = deployResult.execution;
        const execBtn = document.getElementById('viewExecutionsBtn');
        if (execBtn) execBtn.classList.remove('hidden');
        if (executionResult) {
          // Auto-open execution monitor after a brief delay
          setTimeout(() => viewExecutionDetails(executionResult.executionId), 1500);
        }
        showNotification('Flow deployed successfully', 'success');
      } catch (deployErr) {
        console.error('Deploy failed:', deployErr);
        showNotification('Failed to deploy flow', 'error');
      }
    } else {
      await FlowAPI.updateFlowStatus(currentFlowId, 'draft');
      showNotification('Draft saved', 'success');
    }

    document.getElementById('flowNameInput').value = currentFlowName;
  } catch (error) {
    console.error('Save failed:', error);
    showNotification(status === 'active' ? 'Failed to deploy flow. Please try again.' : 'Failed to save flow. Please try again.', 'error');
  }
}

function clearCanvas() {
  if (!confirm('Are you sure you want to clear the canvas? This will remove all nodes and connections.')) {
    return;
  }
  
  canvas.innerHTML = '';
  jsPlumbInstance.reset();
  nodes = [];
  currentFlowId = null;
  currentFlowName = 'New Flow';
  document.getElementById('flowNameInput').value = 'New Flow';

  const panel= document.getElementById('propertiesPanel');
  if(panel) panel.classList.add('hidden');
}

// Make clearCanvas async to use custom modal
async function clearCanvas() {
  // Only show confirmation if there are actually nodes on the canvas
  const hasNodes = nodes.length > 0 || canvas.children.length > 0;
  
  if (hasNodes) {
    const confirmed = await showConfirmModal(
      'Clear Canvas',
      'Are you sure you want to clear the canvas? This will remove all nodes and connections.',
      'Clear Canvas',
      'Cancel'
    );
    
    if (!confirmed) return;
  }
  
  canvas.innerHTML = '';
  jsPlumbInstance.reset();
  nodes = [];
  currentFlowId = null;
  currentFlowName = 'New Flow';
  document.getElementById('flowNameInput').value = 'New Flow';

  const panel= document.getElementById('propertiesPanel');
  if(panel) panel.classList.add('hidden');
}

// Helper function to clear without confirmation (for internal use)
function clearCanvasSilent() {
  canvas.innerHTML = '';
  jsPlumbInstance.reset();
  nodes = [];

  const panel= document.getElementById('propertiesPanel');
  if(panel) panel.classList.add('hidden');
}

// Load flow modal
async function showLoadFlowModal() {
  // button is already shown by the click handler

  let flows = [];
  try {
    flows = await FlowAPI.getAllFlows(); // may throw on 500
  } catch (err) {
    console.error('Failed to fetch flows:', err);
  }

  const hasError = !Array.isArray(flows);
  const safeFlows = Array.isArray(flows) ? flows : [];

  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white dark:bg-neutral-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-semibold">Load Flow</h3>
          <p class="text-sm text-neutral-500 dark:text-neutral-400 mt-1">
            ${hasError ? 'Couldn’t load your flows (server error).'
                        : (safeFlows.length ? 'Your saved flows' : 'No saved flows yet')}
            • <a href="templates.html" class="text-blue-500 hover:underline">Browse Templates</a>
          </p>
        </div>
      </div>

      <div class="space-y-2 mb-4" id="flowsList">
        ${hasError ? `
          <div class="p-3 border dark:border-neutral-700 rounded bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300">
            The server returned 500. Check backend logs.
          </div>
        ` : safeFlows.length ? safeFlows.map(f => `
          <div class="flow-item border dark:border-neutral-700 rounded p-3 hover:bg-neutral-100 dark:hover:bg-neutral-700 flex justify-between items-center group" data-flow-id="${f.id}">
            <div class="flex-1 cursor-pointer" onclick="loadFlowById('${f.id}')">
              <div class="font-medium">${f.name}</div>
              <div class="text-sm text-neutral-500">
                ${f.latest_version > 0
                  ? `✅ Version ${f.latest_version} • Updated: ${new Date(f.updated_at).toLocaleDateString()}`
                  : '⚠️ No design saved yet • Click to start designing'}
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 text-xs rounded ${f.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'}">${f.status || 'draft'}</span>
            </div>
          </div>
        `).join('') : `
          <div class="p-3 border dark:border-neutral-700 rounded text-neutral-600 dark:text-neutral-300">
            You don’t have any flows yet.
          </div>
        `}
      </div>

      <button class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded hover:bg-gray-400 dark:hover:bg-gray-700" onclick="this.closest('.fixed').remove()">Close</button>
    </div>
  `;
  document.body.appendChild(modal);
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}


async function loadFlowById(flowId) {
  document.getElementById('viewExecutionsBtn')?.classList.remove('hidden');
  try {
    const data = await FlowAPI.getFlow(flowId);
    
    if (!data.latestVersion || !data.latestVersion.graph) {
      // Flow exists but has no graph data - start with empty canvas
      const confirmed = await showConfirmModal(
        'Start Designing Flow',
        `"${data.flow.name}" has no saved design yet. Would you like to start designing this flow now?`,
        'Start Designing',
        'Cancel'
      );
      
      if (confirmed) {
        clearCanvasSilent();
        currentFlowId = data.flow.id;
        currentFlowName = data.flow.name;
        document.getElementById('flowNameInput').value = data.flow.name;
        document.getElementById('viewExecutionsBtn')?.classList.remove('hidden');
        
        // Close modal
        document.querySelector('.fixed.inset-0')?.remove();
      }
      return;
    }

    clearCanvasSilent();
    
    currentFlowId = data.flow.id;
    currentFlowName = data.flow.name;
    document.getElementById('flowNameInput').value = data.flow.name;
    document.getElementById('viewExecutionsBtn')?.classList.remove('hidden');
    
    try {
      renderTemplate(data.latestVersion.graph);
    } catch (e) {
      console.error('Error rendering loaded flow:', e);
      showNotification('The saved design could not be rendered', 'error');
    }
    
    // Close modal
    document.querySelector('.fixed.inset-0')?.remove();
  } catch (error) {
    console.error('Failed to load flow:', error);
    showNotification('Failed to load flow', 'error');
  }
}

// Delete flow from the Load Flow modal
async function deleteFlowFromModal(flowId, flowName) {
  const confirmed = await showConfirmModal(
    'Delete Flow',
    `Are you sure you want to delete "${flowName}"? This action cannot be undone.`,
    'Delete',
    'Cancel'
  );
  
  if (!confirmed) return;
  
  try {
    await FlowAPI.deleteFlow(flowId);
    
    // Remove the flow item from the modal
    const flowItem = document.querySelector(`.flow-item[data-flow-id="${flowId}"]`);
    if (flowItem) {
      flowItem.style.opacity = '0';
      flowItem.style.transform = 'translateX(-20px)';
      setTimeout(() => flowItem.remove(), 200);
    }
    
    // If we deleted the currently loaded flow, reset
    if (currentFlowId === flowId) {
      clearCanvasSilent();
      currentFlowId = null;
      currentFlowName = 'New Flow';
      document.getElementById('flowNameInput').value = 'New Flow';
    }
  } catch (error) {
    console.error('Failed to delete flow:', error);
    showNotification('Failed to delete flow', 'error');
  }
}

// Notification system
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  const colors = {
    success: 'bg-green-500',
    error: 'bg-red-500',
    warning: 'bg-yellow-500',
    info: 'bg-blue-500'
  };
  
  notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Check for template loaded from templates page
async function checkForTemplateLoad() {
  const template = localStorage.getItem("connectify.selectedTemplate");
  if (!template) return;

  let temp;
  try {
    temp = JSON.parse(template);
  } catch (e) {
    console.warn("Invalid template", e);
    localStorage.removeItem("connectify.selectedTemplate");
    return;
  }

  // Clear the localStorage immediately so it doesn't reload on refresh
  localStorage.removeItem("connectify.selectedTemplate");

  // Prompt user to name this template
  const templateName = temp.name || 'Untitled Template';
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="modal-content bg-white dark:bg-neutral-800 rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden">
      <div class="p-6">
        <h3 class="text-lg font-semibold mb-2 text-neutral-900 dark:text-neutral-100">Save Template as Flow</h3>
        <p class="text-neutral-600 dark:text-neutral-400 mb-4">Give your flow a name to save this template:</p>
        <input type="text" id="templateFlowName" 
          value="${templateName}" 
          placeholder="Enter flow name"
          class="w-full px-3 py-2 border dark:border-neutral-600 dark:bg-neutral-700 rounded-lg mb-6 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <div class="flex gap-3 justify-end">
          <button class="cancel-btn px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium">
            Cancel
          </button>
          <button class="save-btn px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors font-medium">
            Save Flow
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  const input = modal.querySelector('#templateFlowName');
  const saveBtn = modal.querySelector('.save-btn');
  const cancelBtn = modal.querySelector('.cancel-btn');
  
  // Focus input and select text
  setTimeout(() => {
    input.focus();
    input.select();
  }, 100);
  
  const cleanup = () => {
    modal.style.opacity = '0';
    modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
    setTimeout(() => modal.remove(), 200);
  };
  
  // Handle save
  saveBtn.addEventListener('click', async () => {
    const flowName = input.value.trim();
    if (!flowName) {
      showNotification('Please enter a flow name', 'warning');
      input.focus();
      return;
    }
    
    cleanup();
    
    // Clear canvas and load template
    clearCanvasSilent();
    currentFlowName = flowName;
    document.getElementById('flowNameInput').value = flowName;
    
    // Render template nodes
    try {
      renderTemplate(temp);
    } catch (e) {
      console.error('Error rendering template:', e);
      showNotification('Template could not be rendered. You can still edit manually.', 'warning');
    }
    
    // Auto-save as a new flow
    try {
      const flow = await FlowAPI.createFlow(flowName, `Created from template: ${templateName}`);
      currentFlowId = flow.id;
      
      // Get current graph
      const connections = jsPlumbInstance.getAllConnections().map(c=>({
        from: c.sourceId.replace('_right', ''),
        to: c.targetId.replace('_left', '')
      }));
      
      const graph = {
        nodes: nodes.map(n => ({
          id: n.id,
          type: n.type,
          kind: n.kind,
          label: n.name,
          x: document.getElementById(n.id)?.offsetLeft || n.x,
          y: document.getElementById(n.id)?.offsetTop || n.y
        })),
        edges: connections
      };
      
      // Save first version
      await FlowAPI.saveFlowVersion(currentFlowId, graph);
      
    } catch (error) {
      console.error('Failed to save template as flow:', error);
      showNotification('Failed to save flow. You can still edit and save manually.', 'warning');
    }
  });
  
  // Handle cancel
  cancelBtn.addEventListener('click', () => {
    cleanup();
  });
  
  // ESC key
  const handleEsc = (e) => {
    if (e.key === 'Escape') {
      cleanup();
      document.removeEventListener('keydown', handleEsc);
    }
  };
  document.addEventListener('keydown', handleEsc);
  
  // Enter key to save
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      saveBtn.click();
    }
  });
}

// Custom Confirmation Modal
function showConfirmModal(title, message, confirmText = 'Confirm', cancelText = 'Cancel') {
  return new Promise((resolve) => {
    const modal = document.createElement('div');
    modal.className = 'modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="modal-content bg-white dark:bg-neutral-800 rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden">
        <div class="p-6">
          <h3 class="text-lg font-semibold mb-2 text-neutral-900 dark:text-neutral-100">${title}</h3>
          <p class="text-neutral-600 dark:text-neutral-400 mb-6">${message}</p>
          <div class="flex gap-3 justify-end">
            <button class="cancel-btn px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium">
              ${cancelText}
            </button>
            <button class="confirm-btn px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors font-medium">
              ${confirmText}
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    const confirmBtn = modal.querySelector('.confirm-btn');
    const cancelBtn = modal.querySelector('.cancel-btn');
    
    const cleanup = (result) => {
      modal.style.opacity = '0';
      modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
      setTimeout(() => modal.remove(), 200);
      resolve(result);
    };
    
    confirmBtn.addEventListener('click', () => cleanup(true));
    cancelBtn.addEventListener('click', () => cleanup(false));
    modal.addEventListener('click', (e) => {
      if (e.target === modal) cleanup(false);
    });
    
    // ESC key support
    const handleEsc = (e) => {
      if (e.key === 'Escape') {
        cleanup(false);
        document.removeEventListener('keydown', handleEsc);
      }
    };
    document.addEventListener('keydown', handleEsc);
  });
}

// View Executions Modal
async function viewExecutions() {
  if (!currentFlowId) {
    showNotification('No flow loaded', 'warning');
    return;
  }

  try {
    const executions = await FlowAPI.getFlowExecutions(currentFlowId);
    
    const modal = document.createElement('div');
    modal.className = 'modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="modal-content bg-white dark:bg-neutral-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 overflow-hidden">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-neutral-900 dark:text-neutral-100">Flow Executions</h3>
            <button class="close-btn text-2xl text-neutral-500 hover:text-neutral-700 dark:hover:text-neutral-300">&times;</button>
          </div>
          
          <div class="max-h-96 overflow-y-auto">
            ${executions.length === 0 ? `
              <div class="text-center py-8 text-neutral-500">
                No executions yet. Click "Deploy Flow" to execute this flow.
              </div>
            ` : `
              <table class="w-full text-sm">
                <thead class="bg-neutral-100 dark:bg-neutral-700">
                  <tr>
                    <th class="text-left p-3">ID</th>
                    <th class="text-left p-3">Trigger</th>
                    <th class="text-left p-3">Status</th>
                    <th class="text-left p-3">Started</th>
                    <th class="text-left p-3">Duration</th>
                    <th class="text-left p-3">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${executions.map(exec => `
                    <tr class="border-b dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-700/50">
                      <td class="p-3 font-mono text-xs">${exec.id.substring(0, 8)}...</td>
                      <td class="p-3">
                        <span class="px-2 py-1 text-xs rounded ${
                          exec.trigger_type === 'manual' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :
                          exec.trigger_type === 'deploy' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' :
                          'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
                        }">${exec.trigger_type}</span>
                      </td>
                      <td class="p-3">
                        <span class="px-2 py-1 text-xs rounded ${
                          exec.status === 'completed' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                          exec.status === 'failed' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                          exec.status === 'running' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                          'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
                        }">${exec.status}</span>
                      </td>
                      <td class="p-3 text-xs">${new Date(exec.started_at).toLocaleString()}</td>
                      <td class="p-3">${exec.execution_time_ms ? `${exec.execution_time_ms}ms` : '-'}</td>
                      <td class="p-3">
                        <div class="flex gap-2">
                          <button 
                            class="text-blue-500 hover:text-blue-700 text-sm"
                            onclick="viewExecutionDetails('${exec.id}')">
                            View Details
                          </button>
                          <button 
                            class="text-red-500 hover:text-red-700 text-sm"
                            onclick="deleteExecution('${exec.id}')">
                            Delete
                          </button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `}
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    const closeBtn = modal.querySelector('.close-btn');
    closeBtn.addEventListener('click', () => modal.remove());
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  } catch (error) {
    console.error('Failed to load executions:', error);
    showNotification('Failed to load executions', 'error');
  }
}

// View Execution Details Modal
async function viewExecutionDetails(executionId) {
  try {
    const [execution, steps, logs] = await Promise.all([
      FlowAPI.getExecution(executionId),
      FlowAPI.getExecutionSteps(executionId),
      FlowAPI.getExecutionLogs(executionId, 50)
    ]);
    
    const modal = document.createElement('div');
    modal.className = 'modal-backdrop fixed inset-0 bg-black/50 flex items-center justify-center z-50';
    modal.innerHTML = `
      <div class="modal-content bg-white dark:bg-neutral-800 rounded-lg shadow-xl max-w-5xl w-full mx-4 overflow-hidden">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="text-xl font-semibold text-neutral-900 dark:text-neutral-100">Execution Details</h3>
              <p class="text-sm text-neutral-500 font-mono">${executionId}</p>
            </div>
            <button class="close-btn text-2xl text-neutral-500 hover:text-neutral-700 dark:hover:text-neutral-300">&times;</button>
          </div>
          
          <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-neutral-100 dark:bg-neutral-700 p-3 rounded">
              <div class="text-xs text-neutral-500 dark:text-neutral-400">Status</div>
              <div class="text-lg font-semibold">${execution.status}</div>
            </div>
            <div class="bg-neutral-100 dark:bg-neutral-700 p-3 rounded">
              <div class="text-xs text-neutral-500 dark:text-neutral-400">Duration</div>
              <div class="text-lg font-semibold">${execution.execution_time_ms || '-'}ms</div>
            </div>
            <div class="bg-neutral-100 dark:bg-neutral-700 p-3 rounded">
              <div class="text-xs text-neutral-500 dark:text-neutral-400">Trigger</div>
              <div class="text-lg font-semibold">${execution.trigger_type}</div>
            </div>
            <div class="bg-neutral-100 dark:bg-neutral-700 p-3 rounded">
              <div class="text-xs text-neutral-500 dark:text-neutral-400">Steps</div>
              <div class="text-lg font-semibold">${steps.length}</div>
            </div>
          </div>

          <div class="mb-4">
            <h4 class="font-semibold mb-2">Execution Steps</h4>
            <div class="max-h-48 overflow-y-auto">
              ${steps.map(step => `
                <div class="border-l-4 ${
                  step.status === 'completed' ? 'border-green-500' :
                  step.status === 'failed' ? 'border-red-500' :
                  step.status === 'running' ? 'border-yellow-500' :
                  'border-gray-300'
                } pl-3 py-2 mb-2">
                  <div class="flex justify-between">
                    <span class="font-medium">${step.node_id}</span>
                    <span class="text-sm text-neutral-500">${step.execution_time_ms ? `${step.execution_time_ms}ms` : '-'}</span>
                  </div>
                  <div class="text-xs text-neutral-500">${
                    step.node_type === 'start' ? 'Start Node' :
                    step.node_type === 'end' ? 'End Node' :
                    step.node_kind && step.node_kind !== step.node_type ? `${step.node_type} • ${step.node_kind}` :
                    step.node_type
                  }</div>
                  ${step.error_message ? `<div class="text-xs text-red-600 mt-1">${step.error_message}</div>` : ''}
                </div>
              `).join('')}
            </div>
          </div>

          <div>
            <h4 class="font-semibold mb-2">Execution Logs</h4>
            <div class="max-h-64 overflow-y-auto bg-neutral-900 text-neutral-100 p-3 rounded font-mono text-xs">
              ${logs.reverse().map(log => `
                <div class="${
                  log.level === 'error' ? 'text-red-400' :
                  log.level === 'warn' ? 'text-yellow-400' :
                  log.level === 'info' ? 'text-blue-400' :
                  'text-neutral-400'
                }">
                  [${new Date(log.created_at).toLocaleTimeString()}] ${log.level.toUpperCase()}: ${log.message}
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    const closeBtn = modal.querySelector('.close-btn');
    closeBtn.addEventListener('click', () => modal.remove());
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  } catch (error) {
    console.error('Failed to load execution details:', error);
    showNotification('Failed to load execution details', 'error');
  }
}
</script>

<script>
  // Profile Image
  const imageStore = 'connectify.pfpUrl';
  function applyPfpToDOM(pfpUrl){
    document.querySelectorAll('.js-main-pfp').forEach(img =>{
      img.src = pfpUrl;
      img.classList.remove("hidden");
    });
    document.querySelectorAll(".js-initial-pfp").forEach(el => el.classList.add("hidden"));
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    const saveImg = localStorage.getItem(imageStore);
    if(saveImg) applyPfpToDOM(saveImg);
  });
</script>

<!-- loading templates to flow designer -->
 <script>
  function loadTemplate(){
    const template = localStorage.getItem("connectify.selectedTemplate");
    if (!template) return;

    let temp;
    try{
      temp = JSON.parse(template)
    }
    catch(e){
      console.warn("no template", e);
      return;
    }
    clearCanvas();
    renderTemplate(temp);
    localStorage.removeItem("connectify.selectedTemplate")
  }

  function renderTemplate(temp){
    // Defensive render wrapper to avoid breaking the designer on malformed graphs
    try {
      if(!temp || !Array.isArray(temp.nodes)) {
        console.warn("renderTemplate: invalid graph payload", temp);
        showNotification('Invalid graph data – starting with empty canvas', 'warning');
        return;
      }

      const seenIds = new Set();
      temp.nodes.forEach(nodeDef => {
        if(!nodeDef || !nodeDef.id){
          console.warn("Skipping node without id", nodeDef);
          return;
        }
        if(seenIds.has(nodeDef.id)){
          console.warn("Duplicate node id detected, skipping", nodeDef.id);
          return;
        }
        seenIds.add(nodeDef.id);
        try {
          createNodeFromTemplate(nodeDef);
        } catch(e){
          console.error("Failed to create node", nodeDef, e);
        }
      });

      const edgesRaw = Array.isArray(temp.edges) ? temp.edges : (Array.isArray(temp.connections) ? temp.connections : []);
      edgesRaw.forEach(edge => {
        if(!edge || !edge.from || !edge.to){
          console.warn("Skipping invalid edge", edge);
          return;
        }
        if(!seenIds.has(edge.from) || !seenIds.has(edge.to)){
          console.warn("Edge references missing node", edge);
          return;
        }
        try {
          jsPlumbInstance.connect({
            source: edge.from,
            target: edge.to
          });
        } catch(err){
          console.warn("Failed to connect edge", edge, err);
        }
      });
    } catch(err){
      console.error("renderTemplate: unrecoverable error", err);
      showNotification('Failed to render flow graph', 'error');
    }
  }

  function createNodeFromTemplate(nodeDef){
    const id = nodeDef.id;
    const kind = nodeDef.kind || nodeDef.type || "api";
    const name = nodeDef.label || nodeDef.name || nodeDef.id;
    const element = document.createElement("div");

    element.className = `node ${kind}`;
    element.id = id;
    element.style.left = (nodeDef.x ?? 80) + "px";
    element.style.top = (nodeDef.y ?? 80) +"px";
    element.innerHTML = `
      <div class="connector-dot dot-left" id="${id}_left"></div>
      <span>${name}</span>
      <div class="connector-dot dot-right" id="${id}_right"></div>
    `;
    // Append element to DOM BEFORE registering sources/targets
    canvas.appendChild(element);

    // Safely locate connector handles
    const rightHandle = document.getElementById(id + "_right");
    const leftHandle = document.getElementById(id + "_left");

    // Guard against nulls to avoid jsPlumb errors
    if (rightHandle) {
      jsPlumbInstance.makeSource(rightHandle, {
        parent: element,
        anchor: "Right"
      });
    }
    if (leftHandle) {
      jsPlumbInstance.makeTarget(leftHandle, {
        parent: element,
        anchor: "Left"
      });
    }

    attachNodeInteractions(element, id, name);

    nodes.push({
      id, type: nodeDef.type || kind, kind, name, x:element.offsetLeft, y:element.offsetTop
    });
  }
 </script>

 <!-- mtn button hide/open -->
  <script>
    function toggleMTN(){
      const mtnBtn = document.getElementById('mtnBtn');
    
      const openArrow = document.getElementById('openArrow');
      const closeArrow = document.getElementById('closeArrow');
      mtnBtn.classList.toggle('hidden');

      const isHidden = mtnBtn.classList.contains('hidden');
      openArrow.classList.toggle('hidden', isHidden);
      closeArrow.classList.toggle('hidden', !isHidden);

    }

    function toggleFW(){
      const fWBtn = document.getElementById('fWBtn');

      const openArrowFW = document.getElementById('openArrowFW');
      const closeArrowFW = document.getElementById('closeArrowFW');
      fWBtn.classList.toggle('hidden');

      const isHidden = fWBtn.classList.contains('hidden');
      openArrowFW.classList.toggle('hidden', isHidden);
      closeArrowFW.classList.toggle('hidden', !isHidden);
    }
  </script>

</body>
</html>
