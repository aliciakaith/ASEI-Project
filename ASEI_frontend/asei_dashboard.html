<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ASEI Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="images/connectify_logo.png">
  <style>
  :root{--sidebar:#111111;--sidebar-2:#1c1c1c;--stroke:#e5e5e5}
  html,body{height:100%}
  body{font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol','Noto Color Emoji'}
  *{scrollbar-width:thin;scrollbar-color:#9a9898 transparent}
  *::-webkit-scrollbar{height:8px;width:8px}
  *::-webkit-scrollbar-thumb{background:#cfcfcf;border-radius:999px}
  *::-webkit-scrollbar-track{background:transparent}
  </style>
</head>
<body class="min-h-screen bg-neutral-100 text-neutral-900">
  <div class="flex">
    <!-- Sidebar -->
    <aside class="fixed inset-y-0 left-0 w-60 bg-neutral-900 text-neutral-100 flex flex-col">
      <div class="px-4 py-4 flex items-center gap-2 border-b border-neutral-800">
        <img src="images/connectify_logo.png" alt="Logo" class="h-8 w-auto">
        <span>Connectify</span>
      </div>

      <nav class="p-2 text-sm space-y-1 flex-1">
        <a href="asei_dashboard.html" class="flex items-center gap-2 px-3 py-2 rounded bg-neutral-800">üè† <span class="hidden sm:inline">Dashboard</span></a>
        <a href="flow_designer.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-800/70">üõ† <span class="hidden sm:inline">Flow Designer</span></a>
        <a href="connectors.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-800/70">üîå <span class="hidden sm:inline">Connectors</span></a>
        <a href="templates.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-800/70">üìë <span class="hidden sm:inline">Templates</span></a>
        <a href="deployments.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-800/70">üöÄ <span class="hidden sm:inline">Deployments</span></a>
        <a href="monitoring.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-800/70">üìä <span class="hidden sm:inline">Monitoring</span></a>
        <a href="settings.html" class="flex items-center gap-2 px-3 py-2 rounded hover:bg-neutral-800/70">‚öôÔ∏è <span class="hidden sm:inline">Settings</span></a>
      </nav>

      <div class="relative">
        <button id="profileBtn" class="w-full px-4 py-4 flex items-center gap-2 border-t border-neutral-800 text-left hover:bg-neutral-800/60">
          <div class="h-8 w-8 rounded-full bg-neutral-800 grid place-items-center">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
            </svg>
          </div>
          <span class="text-sm font-medium">Insert User Name</span>
        </button>

        <div id="profileMenu" class="absolute bottom-full left-3 right-3 mt-4 hidden rounded-lg bg-neutral-800 border border-neutral-700 text-neutral-200 shadow-xl z-50">
          <button id="logoutBtn" class="px-3 py-3 text-red-400 w-full hover:bg-neutral-700">Sign Out</button>
        </div>
      </div>
      <script>
        const btn = document.getElementById('profileBtn');
        const menu = document.getElementById('profileMenu');
        btn.addEventListener('click', (e) => { e.stopPropagation(); menu.classList.toggle('hidden'); });
        document.addEventListener('click', (e) => { if(!menu.contains(e.target) && e.target !== btn) menu.classList.add('hidden'); });
      </script>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-4 sm:p-6 ml-40 md:ml-64">
      <!-- Top controls -->
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-3">
        <h2 class="text-xl font-semibold mb-4">Dashboard</h2>
        <div class="flex items-center gap-2">
          <button class="px-3 py-1.5 rounded-lg bg-white border border-neutral-200 text-sm hover:bg-neutral-50 w-full sm:w-auto">Staging ‚ñæ</button>
          <button class="p-2 rounded-lg bg-white border border-neutral-200 hover:bg-neutral-50" aria-label="Notifications">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 1 0-12 0v3.2c0 .5-.2 1-.6 1.4L4 17h5"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          </button>
          <button class="p-2 rounded-full bg-white border border-neutral-200" aria-label="Profile">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          </button>
        </div>
      </div>

      <!-- KPI cards -->
      <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white border border-neutral-200 rounded-xl p-4">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-neutral-100 flex items-center justify-center">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg>
            </div>
            <div>
              <div class="text-2xl font-semibold"><span id="kpi-active-flows">12</span></div>
              <div class="text-xs text-neutral-500">Active Flows</div>
            </div>
          </div>
        </div>

        <div class="bg-white border border-neutral-200 rounded-xl p-4">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-neutral-100 flex items-center justify-center">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 9h10M7 13h6"/></svg>
            </div>
            <div>
              <div class="text-2xl font-semibold"><span id="kpi-transactions">1500</span></div>
              <div class="text-xs text-neutral-500">Transactions</div>
            </div>
          </div>
        </div>

        <div class="bg-white border border-neutral-200 rounded-xl p-4">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-neutral-100 flex items-center justify-center">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            </div>
            <div>
              <div class="text-2xl font-semibold"><span id="kpi-errors">03</span></div>
              <div class="text-xs text-neutral-500">Errors</div>
            </div>
          </div>
        </div>

        <div class="bg-white border border-neutral-200 rounded-xl p-4">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-neutral-100 flex items-center justify-center">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <div>
              <div class="text-2xl font-semibold"><span id="kpi-latency">120ms</span></div>
              <div class="text-xs text-neutral-500">Average Latency</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Content area -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
        <!-- Chart -->
        <div class="lg:col-span-2 bg-white border border-neutral-200 rounded-xl p-4">
          <div class="text-sm font-medium mb-2">Transactions</div>
          <!-- tagged for JS -->
          <svg id="tx-chart" viewBox="0 0 640 240" class="w-full h-56">
            <defs>
              <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#000" stop-opacity="0.08"/>
                <stop offset="100%" stop-color="#000" stop-opacity="0"/>
              </linearGradient>
            </defs>
            <rect x="0" y="0" width="640" height="240" fill="#fff"/>
            <g stroke="#e5e5e5" stroke-width="1">
              <line x1="0" y1="200" x2="640" y2="200"/>
              <line x1="0" y1="160" x2="640" y2="160"/>
              <line x1="0" y1="120" x2="640" y2="120"/>
              <line x1="0" y1="80" x2="640" y2="80"/>
            </g>
            <!-- JS will draw the path + dot -->
          </svg>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white border border-neutral-200 rounded-xl p-4">
          <div class="text-center font-semibold">Quick Actions</div>
          <div class="mt-4 space-y-3">
            <button id="addIntegrationBtn" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-neutral-900 text-white hover:bg-black">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              <span>Add new integration</span>
            </button>
            <button onclick="window.location.href='monitoring.html'" class="w-full px-4 py-2 rounded-lg bg-white border border-neutral-200 hover:bg-neutral-50">
              Test Sandbox API
            </button>
            <button onclick="window.location.href='Templates.html'" class="w-full px-4 py-2 rounded-lg bg-white border border-neutral-200 hover:bg-neutral-50">
              Generate Compliance
            </button>
          </div>
        </div>

        <!-- Modal (hidden by default) -->
        <div id="integrationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
          <div class="bg-white rounded-xl p-6 w-11/12 sm:w-96">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-semibold">Add New Integration</h2>
              <button id="closeModal" class="text-neutral-500 hover:text-neutral-900">&times;</button>
            </div>
            <form id="integration-form">
              <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Integration Name</label>
                <input id="integration-name" type="text" class="w-full border border-neutral-300 rounded px-3 py-2" placeholder="Enter integration name" required />
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium mb-1">API Key</label>
                <input id="integration-apikey" type="text" class="w-full border border-neutral-300 rounded px-3 py-2" placeholder="Enter API key" required />
              </div>
              <div class="flex justify-end gap-2">
                <button type="button" id="cancelModal" class="px-4 py-2 rounded-lg bg-neutral-200 hover:bg-neutral-300">Cancel</button>
                <button type="submit" class="px-4 py-2 rounded-lg bg-neutral-900 text-white hover:bg-black">Add</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Services list (dynamic) -->
      <section class="bg-white border border-neutral-200 rounded-xl p-4">
        <div class="text-sm font-medium mb-4">Services Integrations</div>
        <div id="services-list" class="space-y-4"></div>
      </section>

      <footer class="py-10"></footer>
    </main>
  </div>

  <!-- Modal JS (open/close only) -->
  <script>
    const modal = document.getElementById('integrationModal');
    const openBtn = document.getElementById('addIntegrationBtn');
    const closeBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelModal');
    openBtn.addEventListener('click', () => modal.classList.remove('hidden'));
    closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
    cancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
    window.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });
  </script>

  <!-- Backend integration -->
  <script type="module">
    // ‚úÖ Your backend origin (index.js listens on 3001)
    const base = 'http://localhost:3001';

    const fetchJSON = async (url, opts = {}) => {
      const res = await fetch(base + url, {
        credentials: 'include',
        headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) },
        ...opts
      });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.status === 204 ? null : res.json();
    };

    // DOM
    const elName = document.querySelector('#profileBtn span');
    const elKpiFlows = document.getElementById('kpi-active-flows');
    const elKpiTx    = document.getElementById('kpi-transactions');
    const elKpiErr   = document.getElementById('kpi-errors');
    const elKpiLat   = document.getElementById('kpi-latency');
    const servicesList = document.getElementById('services-list');
    const chart = document.getElementById('tx-chart');
    const form = document.getElementById('integration-form');
    const nameInput = document.getElementById('integration-name');
    const keyInput = document.getElementById('integration-apikey');
    const logoutBtn = document.getElementById('logoutBtn');

    // UI helpers
    function badge(status) {
      const map = {
        active:  { bg: 'bg-green-100', text: 'text-green-700', label: 'Active' },
        pending: { bg: 'bg-amber-100', text: 'text-amber-800', label: 'Pending' },
        error:   { bg: 'bg-red-100', text: 'text-red-700', label: 'Error' }
      };
      const s = map[status] || map.pending;
      return `<span class="text-xs px-2 py-1 rounded-full ${s.bg} ${s.text}">${s.label}</span>`;
    }

    function renderServices(items = []) {
      servicesList.innerHTML = items.map(it => `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <svg class="h-4 w-4 text-neutral-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2l7 4v6c0 5-3.5 9-7 10-3.5-1-7-5-7-10V6l7-4z"/>
            </svg>
            <div class="text-sm">${it.name}</div>
          </div>
          ${badge(it.status)}
        </div>
      `).join('');
    }

    function renderChart(points = []) {
      chart.querySelectorAll('.series').forEach(n => n.remove());
      if (!points.length) return;

      const left = 10, right = 620;
      const ys = points.map(p => p.value);
      const minY = Math.min(...ys), maxY = Math.max(...ys);
      const spanY = Math.max(1, maxY - minY);
      const stepX = (right - left) / Math.max(1, points.length - 1);

      const d = points.map((p, i) => {
        const x = left + i * stepX;
        const y = 200 - ((p.value - minY) / spanY) * 120;
        return `${i === 0 ? 'M' : 'L'} ${x.toFixed(1)} ${y.toFixed(1)}`;
      }).join(' ');

      const make = (tag) => document.createElementNS('http://www.w3.org/2000/svg', tag);

      const path = make('path');
      path.setAttribute('d', d);
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke', '#111');
      path.setAttribute('stroke-width', '3');
      path.setAttribute('stroke-linecap', 'round');
      path.classList.add('series');
      chart.appendChild(path);

      const last = points[points.length - 1];
      const x = left + (points.length - 1) * stepX;
      const y = 200 - ((last.value - minY) / spanY) * 120;
      const dot = make('circle');
      dot.setAttribute('cx', x.toFixed(1));
      dot.setAttribute('cy', y.toFixed(1));
      dot.setAttribute('r', '6');
      dot.setAttribute('fill', '#111');
      dot.classList.add('series');
      chart.appendChild(dot);
    }

    async function loadAll() {
      try {
        const [me, kpis, txSeries, integrations] = await Promise.all([
          fetchJSON('/api/me'),
          fetchJSON('/api/kpis'),
          fetchJSON('/api/transactions/series?window=24h'),
          fetchJSON('/api/integrations')
        ]);

        if (me?.firstName) elName.textContent = me.firstName + ' ' + (me.lastName || '');
        elKpiFlows.textContent = kpis?.activeFlows ?? 0;
        elKpiTx.textContent    = kpis?.transactions ?? 0;
        elKpiErr.textContent   = String(kpis?.errors ?? 0).padStart(2, '0');
        elKpiLat.textContent   = (kpis?.avgLatencyMs ?? 0) + 'ms';

        renderServices(integrations || []);
        renderChart((txSeries?.points || []).map(p => ({ t: p.t, value: p.count })));
      } catch (e) {
        console.error('Load error', e);
      }
    }

    // Create integration
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = { name: nameInput.value.trim(), apiKey: keyInput.value.trim() };
      if (!payload.name || !payload.apiKey) return;

      try {
        await fetchJSON('/api/integrations', { method: 'POST', body: JSON.stringify(payload) });
        const list = await fetchJSON('/api/integrations');
        renderServices(list || []);
        form.reset();
        document.getElementById('integrationModal').classList.add('hidden');
      } catch (err) {
        console.error('Create integration failed', err);
        alert('Could not add integration. Check console/network.');
      }
    });

    // ‚úÖ Logout (correct path + base)
    logoutBtn?.addEventListener('click', async () => {
      try {
        await fetchJSON('/api/auth/logout', { method: 'POST' });
        window.location.href = 'index.html';
      } catch (e) { console.error(e); }
    });

    loadAll();
  </script>
</body>
</html>
